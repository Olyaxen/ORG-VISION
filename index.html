<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glossy Touch - Modern Glass Design Experience</title>

    <link rel="stylesheet" href="templatemo-glossy-touch.css">
    <!--

TemplateMo 592 glossy touch

https://templatemo.com/tm-592-glossy-touch

-->
    <meta charset="UTF-8" />
    <style>
        /* --- 1. å…¨å±€ä¸åŸºç¡€æ ·å¼ --- */
        #canvas {
            /* å®šä¹‰é¢œè‰²å˜é‡ï¼Œæ–¹ä¾¿ç»Ÿä¸€ä¿®æ”¹ */
            --primary-color: #ffffff;
            --primary-gradient: linear-gradient(135deg, #00ffff, #0066ff);
            --secondary-gradient: linear-gradient(135deg, #ff00cc, #6600ff);
            --dark-bg: #000;
            --panel-bg: #0a0a0a;
            --input-bg: #111;
            --text-color: #fff;
            --text-color-light: #ffffff;
            --border-color: #333;
            --shadow-color-primary: rgba(0, 255, 255, 0.5);
            --shadow-color-secondary: rgba(255, 0, 204, 0.5);
        }

        body,
        html {
            background-color: var(--dark-bg);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        * {
            box-sizing: border-box;
        }

        /* --- 2. å¸ƒå±€å®¹å™¨ --- */
        .main-container {
            background-color: var(--dark-bg);
            padding: 0;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.1);
            width: 100%;
            margin: 0;
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background-color: var(--panel-bg);
            border-radius: 16px;
            margin-bottom: 0;
            max-height: 1000px;
            /* ç”¨äºæŠ˜å åŠ¨ç”» */
            overflow: visible;
            transition: max-height 0.3s ease-in-out;
        }

        .toolbar.collapsed {
            max-height: 0px;
            padding-top: 0;
            padding-bottom: 0;
            overflow: hidden;
        }

        .toolbar-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 10px 15px;
        }

        .chart-container {
            height: 90vh;
            background-color: #fcfdfff8;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(218, 218, 218, 0.187);
        }

        .org-logo {
            height: 60px;
            /* åŸæœ‰å°ºå¯¸ */
            width: auto;
            margin-left: auto;
            /* å…³é”®ï¼šå·¦å³ margin è®¾ä¸º auto */
            margin-right: auto;
            /*     â†‘  Flex ä¼šæŠŠå‰©ä½™å®½åº¦å¹³å‡åˆ†é…åˆ°è¿™ä¸¤ä¸ª margin */
            display: block;
        }

        /* --- 3. ç»„ä»¶æ ·å¼ï¼šæŒ‰é’®ã€è¾“å…¥æ¡†ã€ä¸‹æ‹‰èœå• --- */

        /* åŸºç¡€æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 8px 14px;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            color: var(--text-color);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        /* ä¸»è‰²è°ƒæŒ‰é’® (ä¸Šä¼ , æœç´¢, åˆ›å»º) */
        .btn-primary {
            background: var(--primary-gradient);
            box-shadow: 0 0 10px var(--shadow-color-primary);
        }

        .btn-primary:hover {
            box-shadow: 0 0 15px var(--shadow-color-primary);
        }

        /* æ¬¡è‰²è°ƒæŒ‰é’® (é‡ç½®, å¸ƒå±€åˆ‡æ¢) */
        .btn-secondary {
            background: var(--secondary-gradient);
            box-shadow: 0 0 10px var(--shadow-color-secondary);
        }

        .btn-secondary:hover {
            box-shadow: 0 0 15px var(--shadow-color-secondary);
        }

        /* æš—è‰²/ä¸­æ€§æŒ‰é’® (Edit, æŠ˜å ) */
        .btn-dark {
            background: #3c3c3e69;
            box-shadow: 0 0 1px #ffffff;
        }

        .btn-dark:hover {
            background: #444;
        }

        /* è¾“å…¥æ¡†æ ·å¼ */
        .form-input {
            padding: 8px 12px;
            width: 150px;
            font-size: 15px;
            border: 1px solid transparent;
            outline: none;
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--primary-color);
            box-shadow: 0 0 10px var(--primary-color);
            transition: box-shadow 0.3s ease-in-out, border-color 0.3s;
        }

        .form-input:focus {
            box-shadow: 0 0 20px var(--primary-color);
            border-color: var(--primary-color);
        }

        /* dropdown */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown .dropdown-content {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            min-width: 180px;
            display: none;
            flex-direction: column;
            gap: 6px;
            padding: 8px;
            background: rgba(28, 36, 60, 0.845);
            border-radius: 10px;
            border: 3px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.6);
            z-index: 1200;
        }

        .dropdown.open .dropdown-content,
        .dropdown:hover .dropdown-content {
            display: flex;
        }



        .menu-item {
            display: block;
            width: 100%;
            padding: 6px 12px;
            font-size: 13px;
            text-align: left;
            background: none;
            border: none;
            border-radius: 0;
            white-space: nowrap;
        }

        .menu-item:not(:last-child) {
            border-bottom: 1px solid var(--border-color);
        }

        .modal {
            position: fixed;
            inset: 0;
            /* top:0; right:0; bottom:0; left:0; */
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(23, 23, 31, 0.779);
            z-index: 9999;
            padding: 28px;
            overflow: auto;
        }

        .modal.open {
            display: flex;
        }

        /* å†…å®¹å®¹å™¨ */
        .modal .modal-content {
            width: 100%;
            max-width: 900px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 14px;
            padding: 80px;
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.65);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            max-height: 90vh;
            /* é™åˆ¶ä¸ºè§†çª—é«˜åº¦çš„ 90% */
            overflow-y: auto;
            /* å…³é”®ï¼šå†…å®¹æº¢å‡ºæ—¶å‡ºç°æ»šåŠ¨æ¡ */

        }

        /* å°æç¤ºï¼šç»™å…³é—­æŒ‰é’®ç»Ÿä¸€æ ·å¼ */
        .modal .close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: transparent;
            border: none;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
        }

        /* --- 5. å…¶ä»–æ§ä»¶ --- */
        .date-filter {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            margin-left: auto;
            /* æ¨åˆ°å³ä¾§ */
        }

        input[type="range"] {
            width: 150px;
            accent-color: var(--primary-color);
            /* ç°ä»£æµè§ˆå™¨æ”¯æŒï¼Œæ”¹å˜æ»‘å—é¢œè‰² */
        }

        /* --- 6. å“åº”å¼å¸ƒå±€ --- */
        @media (max-width: 1200px) {
            .org-logo {
                display: none;
                /* åœ¨ä¸­ç­‰å±å¹•ä¸Šéšè—logoï¼Œä¸ºå…¶ä»–æ§ä»¶è…¾å‡ºç©ºé—´ */
            }
        }

        @media (max-width: 992px) {
            .toolbar {
                justify-content: center;
            }

            .date-filter {
                margin-left: 0;
                width: 100%;
                justify-content: center;
                margin-top: 10px;
            }
        }

        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
                padding: 10px;
            }

            .btn,
            .form-input,
            .dropdown {
                width: 100%;
            }

            .dropdown-content {
                position: static;
                margin-top: 5px;
                box-shadow: none;
                border: none;
            }

            .form-group {
                flex-direction: column;
                align-items: stretch;
                gap: 5px;
                margin-bottom: 15px;
            }

            .form-group label {
                text-align: left;
            }
        }

        /* è¿æ¥çº¿ç»Ÿä¸€æ ·å¼ â€”â€” å¯æŒ‰éœ€æ”¹é¢œè‰² / ç²—ç»† / è™šçº¿ */
        .chart-container .link {
            stroke: #111111;
            /* é¢œè‰² */
            stroke-width: 2px;
            /* ç²—ç»† */

        }

        /* æ·»åŠ åˆ° <style> æ ‡ç­¾çš„æœ«å°¾ */
        .selection-choice {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .selection-choice:hover {
            background-color: #2a2a2a;
            border-color: var(--primary-color);
        }

        .selection-choice h4 {
            margin: 0 0 5px 0;
            color: var(--primary-color);
        }

        .selection-choice p {
            margin: 0;
            font-size: 14px;
            color: var(--text-color-light);
        }

        /* --- æœ€ç»ˆæ–¹æ¡ˆï¼šä¸º HTML ç»“æ„çš„å±•å¼€/æ”¶å›æŒ‰é’®è‡ªå®šä¹‰æ ·å¼ --- */

        /* 1. å®šä½åˆ°ä½œä¸ºæŒ‰é’®å®¹å™¨çš„ <div> */
        /* è¿™ä¸ªé€‰æ‹©å™¨ç²¾ç¡®åœ°åŒ¹é…äº†æ‚¨æˆªå›¾ä¸­ div çš„çˆ¶å­ç»“æ„ */
        .node-button-div>div {

            /* æ ¸å¿ƒéœ€æ±‚ï¼šè®¾ç½®èƒŒæ™¯ä¸ºæ·±ç°è‰² */
            /* !important ä»ç„¶éœ€è¦ï¼Œå› ä¸ºåŸå§‹æ ·å¼æ˜¯å†…è” styleï¼Œä¼˜å…ˆçº§å¾ˆé«˜ */
            background-color: #383535 !important;

            /* è®©æŒ‰é’®æ›´å®½ã€‚
       å¯¹äºHTMLå…ƒç´ ï¼Œç›´æ¥è°ƒæ•´å†…è¾¹è·(padding)æˆ–è®¾ç½®æœ€å°å®½åº¦(min-width)æ˜¯æœ€å¥½çš„æ–¹æ³•
    */

            min-width: 45px !important;
            min-height: 10px !important;
            /* æ‚¨å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´è¿™ä¸ªæ•°å€¼ */

            display: flex !important;
            align-items: center;
            justify-content: center;


        }

        /* 2. å®šä½åˆ°æŒ‰é’®å†…éƒ¨çš„ <span> å…ƒç´ ï¼Œæ”¹å˜æ–‡å­—é¢œè‰² */
        /* é€‰æ‹©å™¨ .node-button-div span ä¼šé€‰ä¸­æ‰€æœ‰çš„ spanï¼ŒåŒ…æ‹¬å›¾æ ‡å’Œæ•°å­— */
        .node-button-div span {

            /* å°†æ–‡å­—é¢œè‰²æ”¹ä¸ºç™½è‰²ä»¥ä¿è¯æ¸…æ™°å¯è¯» */
            color: #FFFFFF !important;
            font-size: 13px;
        }


        /* è®©æŠ˜å /å±•å¼€å›¾æ ‡çº¯ç™½ï¼Œç²—ä¸€ç‚¹ï¼Œé¡ºä¾¿è°ƒå¤§å° */
        .node-button-div svg {
            /* æ•´ä¸ª SVG */
            width: 12px;
            /* é»˜è®¤æ˜¯ 8pxï¼Œå¯æ”¾å¤§ä¸€å€ */
            height: 12px;
        }

        .node-button-div svg *,
        .node-button-div svg

        /* è·¯å¾„ä¸è‡ªèº«éƒ½è¦†ç›– */
            {
            fill: #FFFFFF !important;
            /* å°‘é‡å›¾æ ‡ç”¨ fill */
            stroke: #FFFFFF !important;
            /* å¤§éƒ¨åˆ†ç®­å¤´ç”¨ stroke */
            stroke-width: 2;
            /* çº¿æ¡æ›´ç²— */
        }

        @media print {

            html,
            body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                overflow: hidden;
                /* å¼ºåˆ¶éšè—ä»»ä½•å¯èƒ½è¶…å‡ºé¡µé¢çš„å†…å®¹ */
            }

            body * {
                visibility: hidden;
                /* éšè—æ‰€æœ‰å†…å®¹ */
            }

            .chart-container,
            .chart-container * {
                visibility: visible;
                /* åªæ˜¾ç¤ºå›¾è¡¨åŒºåŸŸ */
            }

            .chart-container {
                position: absolute;
                top: 50px;
                left: 50px;
                right: 50px;
                bottom: 50px;

                /* ç§»é™¤åŸæœ‰çš„å®½åº¦å’Œé«˜åº¦è®¾ç½®ï¼Œå°ºå¯¸ç”±ä¸Šé¢çš„å››ä¸ªå®šä½å±æ€§è‡ªåŠ¨æ’‘å¼€ */
                width: auto;
                height: auto;
            }

        }

        /* éšè—èŠ‚ç‚¹æŒ‰é’®ä¸­çš„æ•°å­— */
        .node-button-div span+span {
            display: none !important;
        }
    </style>
</head>


<script>
    let chart;         // chart å®ä¾‹ï¼Œç”¨äºåç»­æ›´æ–°å›¾è¡¨
    let globalData = []; // å…¨å±€æ•°æ®æºï¼ŒåŠ è½½ csv åä¿å­˜åœ¨è¿™é‡Œ
    let originalData = []; // æ–°å¢å˜é‡ï¼šç”¨äºå­˜å‚¨åŸå§‹å®Œæ•´æ•°æ®
    let nodeToModify = null; // â–¼ æ–°å¢ï¼šç”¨äºå­˜å‚¨å¾…ä¿®æ”¹çš„èŠ‚ç‚¹å¯¹è±¡ â–¼
    let status = true; // ç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦ä¸Šä¼ æ–‡ä»¶
    let uploadedData = null; // æ–°å¢ï¼šå­˜å‚¨ä¸Šä¼ çš„åŸå§‹æ•°æ®
    let data_by_position = null;
    let dateValues = [];//å­˜å‚¨æ—¥æœŸ
    let isConfigPanelVisible = true;
    const now = new Date();
    const undoStack = [];
    const redoStack = [];


    console.log(now);
    // æ”¾åœ¨ä¸€ä¸ªåˆé€‚çš„ä½ç½®ï¼Œæ¯”å¦‚ handleFileUpload å‡½æ•°çš„ä¸Šé¢
    function sortDataByBand(data) {
        const bandOrder = { "1": 0, "2": 1, "3": 2, "4": 3, "AL": 4 };
        // ä½¿ç”¨ slice() åˆ›å»ºä¸€ä¸ªæµ…æ‹·è´ï¼Œé¿å…ä¿®æ”¹åŸå§‹æ•°ç»„
        return data.slice().sort((a, b) => {
            return bandOrder[a.Position_Band] - bandOrder[b.Position_Band];
        });
    }
    // åŠ è½½ CSV æ•°æ®å¹¶åˆå§‹åŒ–ç»„ç»‡å›¾
    function handleFileUpload() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        if (!file) {
            alert("Please upload csv fileï¼");
            return;
        }

        const reader = new FileReader();

        reader.onload = function (e) {
            const csvText = e.target.result;
            const data = d3.csvParse(csvText);
            let uniqueIdCounter = 0; // æ–°å¢ä¸€ä¸ªè®¡æ•°å™¨

            // === å¤„ç† Position_Band å­—æ®µ ===
            uploadedData = data.map(d => {
                switch (d.Position_Band) {
                    case '001': d.Position_Band = '1'; break;
                    case '1': d.Position_Band = '1'; break;
                    case '002': d.Position_Band = '2'; break;
                    case '2': d.Position_Band = '2'; break;
                    case '003': d.Position_Band = '3'; break;
                    case '3': d.Position_Band = '3'; break;
                    case '004': d.Position_Band = '4'; break;
                    case '4': d.Position_Band = '4'; break;
                    case 'B': d.Position_Band = 'B'; break;
                    default: d.Position_Band = 'AL';
                }

                // è¿”å›ä¸åŸ CSV å­—æ®µä¸€è‡´çš„ç»“æ„
                return {
                    ...d,
                    id: d.Position_Number,
                    parentId: d.Reports_To_Position_Number,
                    _uniqueId: `csv-${uniqueIdCounter++}` // æ–°å¢ï¼šåˆ†é…å”¯ä¸€çš„å†…éƒ¨ID
                };
            });




            // å°†å¤„ç†åçš„æ•°æ®ä¿å­˜åˆ°å…¨å±€å˜é‡
            originalData = JSON.parse(JSON.stringify(uploadedData)); // ä¿ç•™ä¸€ä»½çº¯å‡€çš„åŸå§‹æ•°æ®å¤‡ä»½
            editedData = JSON.parse(JSON.stringify(uploadedData)); // è¿™æ˜¯æˆ‘ä»¬æœªæ¥æ“ä½œçš„â€œæºæ•°æ®â€
            globalData = [...uploadedData]; // å¦‚æœè¿˜åœ¨ç”¨ globalDataï¼Œä¹Ÿè¿™æ ·åˆå§‹åŒ–

            alert('File uploadedï¼Please enter whole name');
            initDateSlider();
        };

        reader.readAsText(file);
    }

    // æ›¿æ¢æ‰æ—§çš„ searchPerson å‡½æ•°

    function searchPerson() {
        const nameToSearch = document.getElementById("searchInput").value.trim();
        if (!nameToSearch) {
            alert("Please enter whole name (Lastname Firstname)");
            return;
        }

        // åœ¨åŸå§‹æ•°æ®ä¸­æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…è¯¥å§“åçš„å‘˜å·¥
        const matchedPersons = editedData.filter(d =>
            (d.Display_Name && d.Display_Name.trim().toLowerCase() === nameToSearch.trim().toLowerCase()) ||
            (d.Position_Number && String(d.Position_Number).trim() === nameToSearch.trim())
        );

        if (matchedPersons.length === 0) {
            alert(`Cannot find ${nameToSearch}`);
            return;
        }

        // æŸ¥æ‰¾æˆåŠŸåï¼Œç«‹å³ç”¨å®Œæ•´æ•°æ®åˆå§‹åŒ–/é‡ç½®æ—¥æœŸæ»‘å—
        initDateSlider();

        if (matchedPersons.length === 1) {
            // å¦‚æœåªæœ‰ä¸€ä¸ªåŒ¹é…é¡¹ï¼Œç›´æ¥ç”Ÿæˆå›¾è¡¨
            buildAndDisplayChart(matchedPersons[0]);
        } else {
            // å¦‚æœæœ‰å¤šä¸ªåŒ¹é…é¡¹ï¼Œæ˜¾ç¤ºé€‰æ‹©æ¨¡æ€æ¡†
            const modal = document.getElementById('selectionModal');
            const choicesContainer = document.getElementById('selectionChoices');

            // 1. æ¸…ç©ºæ—§é€‰é¡¹
            choicesContainer.innerHTML = '';

            // 2. åŠ¨æ€åˆ›å»ºæ–°é€‰é¡¹
            matchedPersons.forEach(person => {
                const choiceElement = document.createElement('div');
                choiceElement.className = 'selection-choice';
                // å°† Position_Number å­˜å‚¨åœ¨ data attribute ä¸­ï¼Œæ–¹ä¾¿åç»­è·å–
                choiceElement.dataset.id = person.Position_Number;

                choiceElement.innerHTML = `
        <h4>${person.Display_Name}</h4>
        <p>${person.Department_Descr_Short}</p>
        <p>${person.Position_Descr}</p>
        <p>${person.Effective_Date}</p>
      `;

                // 3. ä¸ºæ¯ä¸ªé€‰é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
                choiceElement.addEventListener('click', () => {
                    // ä»æ•°æ®ä¸­æ‰¾åˆ°å®Œæ•´çš„ person å¯¹è±¡
                    const selectedPerson = editedData.find(d => d.id === person.Position_Number);
                    if (selectedPerson) {
                        initDateSlider();
                        buildAndDisplayChart(selectedPerson);
                    }
                    modal.style.display = 'none'; // å…³é—­æ¨¡æ€æ¡†
                });

                choicesContainer.appendChild(choiceElement);
            });

            // 4. æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.style.display = 'flex';
        }
    }
    /**
     * ä¿®æ­£ç‰ˆå‡½æ•°ï¼šéå†æ•´ä¸ªæ•°æ®æ ‘ï¼Œä¸ºæ‰€æœ‰å­èŠ‚ç‚¹æ•°>6çš„èŠ‚ç‚¹åº”ç”¨è™šæ‹Ÿåˆ†ç»„ã€‚
     * è¿™ä¸ªç‰ˆæœ¬é€šè¿‡åˆ›å»ºæ–°å¯¹è±¡æ¥é¿å…â€œæ•°æ®æ±¡æŸ“â€ã€‚
     * @param {Array} data - ç”¨äºå›¾è¡¨æ¸²æŸ“çš„å®Œæ•´æ•°æ®æ•°ç»„ã€‚
     * @returns {Array} - ç»è¿‡è½¬æ¢ï¼ŒåŒ…å«äº†è™šæ‹ŸèŠ‚ç‚¹çš„æ–°æ•°æ®æ•°ç»„ã€‚
     */
    function applyVirtualGrouping(data) {
        // å¤åˆ¶ä¸€ä»½æ•°æ®è¿›è¡Œæ“ä½œï¼Œè¿™æ˜¯ä¸€ä¸ªæµ…æ‹·è´ï¼Œä½†æˆ‘ä»¬åç»­ä¼šå¤„ç†å¯¹è±¡å¼•ç”¨é—®é¢˜
        let processedData = [...data];
        const virtualNodesToAdd = [];

        // åˆ›å»ºä¸€ä¸ªæŒ‰ parentId åˆ†ç»„çš„ Mapï¼Œæ–¹ä¾¿å¿«é€ŸæŸ¥æ‰¾å­èŠ‚ç‚¹
        const childrenMap = new Map();
        data.forEach(node => {
            // å¿½ç•¥è™šæ‹ŸèŠ‚ç‚¹è‡ªèº«ï¼Œå®ƒä»¬ä¸åº”è¯¥æˆä¸ºçˆ¶èŠ‚ç‚¹
            if (node.isVirtual) return;

            if (node.parentId) {
                if (!childrenMap.has(node.parentId)) {
                    childrenMap.set(node.parentId, []);
                }
                childrenMap.get(node.parentId).push(node);
            }
        });

        // éå†æ‰€æœ‰å¯èƒ½çš„çˆ¶èŠ‚ç‚¹
        childrenMap.forEach((children, parentId) => {
            if (children.length > 6) {
                const numVirtualNodes = children.length <= 12 ? 2 : 3;
                const virtualNodes = [];

                // åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹
                for (let i = 0; i < numVirtualNodes; i++) {
                    const virtualNode = {
                        id: `virtual-${parentId}-${i}`,
                        parentId: parentId,
                        Display_Name: `Group ${i + 1}`,
                        isVirtual: true,
                        Position_Band: 'VIRTUAL',
                        Effective_Date: '2000/12/01 00:00:00'

                    };
                    virtualNodes.push(virtualNode);
                    virtualNodesToAdd.push(virtualNode); // å…ˆæ”¶é›†èµ·æ¥ï¼Œæœ€åç»Ÿä¸€æ·»åŠ 
                }

                // --- æ ¸å¿ƒä¿®æ­£ç‚¹ ---
                // é‡æ–°åˆ†é…å­èŠ‚ç‚¹çš„ parentIdï¼Œä½†ä¸æ˜¯ç›´æ¥ä¿®æ”¹ï¼Œè€Œæ˜¯æ›¿æ¢ä¸ºæ–°å¯¹è±¡
                children.forEach((child, index) => {
                    const childIndexInProcessedData = processedData.findIndex(d => d.id === child.id);

                    if (childIndexInProcessedData !== -1) {
                        const virtualNodeIndex = index % numVirtualNodes;

                        // åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„å­èŠ‚ç‚¹å¯¹è±¡å‰¯æœ¬ï¼Œåªä¿®æ”¹ parentId
                        const updatedChild = {
                            ...processedData[childIndexInProcessedData], // å¤åˆ¶æ‰€æœ‰å±æ€§
                            parentId: virtualNodes[virtualNodeIndex].id // è¦†ç›– parentId

                        };

                        // åœ¨ processedData æ•°ç»„ä¸­ï¼Œç”¨æ–°å¯¹è±¡æ›¿æ¢æ‰æ—§å¯¹è±¡
                        processedData.splice(childIndexInProcessedData, 1, updatedChild);
                    }
                });
            }
        });

        // å°†æ‰€æœ‰æ–°åˆ›å»ºçš„è™šæ‹ŸèŠ‚ç‚¹åˆå¹¶åˆ°ç»“æœæ•°ç»„ä¸­
        return [...processedData, ...virtualNodesToAdd];
    }

    // æ›¿æ¢æ—§çš„ buildAndDisplayChart å‡½æ•°
    function buildAndDisplayChart(person) {
        if (!person) return;

        // 1. è·å–æ—¥æœŸæ»‘å—çš„å½“å‰é€‰å®šæ—¥æœŸ
        const slider = document.getElementById('dateRange');
        // å¦‚æœæ»‘å—è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œå°±ç”¨ä»Šå¤©çš„æ—¥æœŸ
        const selectedDate = dateValues[slider.value] || formatDate(new Date());

        // 2. è°ƒç”¨æ–°å‡½æ•°ï¼Œè·å–åŸºäºè¯¥æ—¥æœŸçš„ã€å¹²å‡€çš„ "è§†å›¾æ•°æ®"
        const viewData = getViewDataForDate(selectedDate);

        // 3. åœ¨æ¸²æŸ“å‰ï¼Œå¯¹åˆšåˆšç”Ÿæˆçš„ viewData é‡æ–°è®¡ç®—ä¸‹å±äººæ•°
        //    è¿™æ ·å¯ä»¥ç¡®ä¿å›¾è¡¨ä¸Šæ˜¾ç¤ºçš„æ‰€æœ‰è®¡æ•°å€¼éƒ½æ˜¯åŸºäºå½“å‰æ—¥æœŸçš„å‡†ç¡®å€¼
        recalculateSubordinateCounts(viewData);

        // 3. getSubtree å‡½æ•°ç°åœ¨åŸºäºå¹²å‡€çš„ viewData æ“ä½œ
        function getSubtree(rootId) {
            const children = viewData.filter((d) => d.parentId === rootId);
            let result = [...children];
            for (let child of children) {
                result = result.concat(getSubtree(child.id));
            }
            return result;
        }

        // 4. æ„å»ºç”¨äºæ¸²æŸ“çš„æœ€ç»ˆæ•°æ®
        const subtree = getSubtree(person.id);
        const rootNodeInView = viewData.find(d => d.id === person.id); // ç¡®ä¿æ ¹èŠ‚ç‚¹ä¹Ÿæ¥è‡ªviewData
        const rootNodeForChart = { ...rootNodeInView, parentId: null };
        let mainTree = [rootNodeForChart, ...subtree];
        mainTree = sortDataByBand(mainTree);

        // 5. åº”ç”¨è™šæ‹Ÿåˆ†ç»„å¹¶æ˜¾ç¤ºå›¾è¡¨ (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
        const transformedTree = applyVirtualGrouping(mainTree);
        displayChart(transformedTree);
        data_by_position = transformedTree; // æ›´æ–°å…¨å±€å˜é‡ä»¥åæ˜ å½“å‰è§†å›¾
    }


    document.addEventListener("DOMContentLoaded", function () {
        // ...æ‚¨å·²æœ‰çš„å…¶ä»– DOMContentLoaded ä»£ç ...

        const selectionModal = document.getElementById('selectionModal');
        const cancelSelectionBtn = document.getElementById('cancelSelection');

        // ç‚¹å‡»å–æ¶ˆæŒ‰é’®å…³é—­æ¨¡æ€æ¡†
        if (cancelSelectionBtn) {
            cancelSelectionBtn.onclick = () => {
                selectionModal.style.display = 'none';
            };
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯ä¹Ÿèƒ½å…³é—­
        if (selectionModal) {
            selectionModal.addEventListener('click', e => {
                if (e.target === selectionModal) {
                    selectionModal.style.display = 'none';
                }
            });
        }
    });




    // 1. æ·»åŠ å­—æ®µé…ç½®é¢æ¿åˆ°HTMLä¸­ï¼ˆéœ€è¦åœ¨HTMLä¸­æ·»åŠ å®¹å™¨ï¼‰
    // ä¿®æ”¹ createConfigPanel å‡½æ•°
    function createConfigPanel() {
        // åˆ›å»ºå®¹å™¨ï¼ˆç”¨äºåŒ…è£¹æŒ‰é’®å’Œé¢æ¿ï¼‰
        const configContainer = document.createElement('div');
        configContainer.id = 'chart-config-container';
        configContainer.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: flex;
        flex-direction: row-reverse;
        align-items: flex-end;
        gap: 10px;
        z-index: 1000;
    `;

        // åˆ›å»ºåˆ‡æ¢æŒ‰é’®
        const toggleBtn = document.createElement('button');
        toggleBtn.id = 'config-toggle-btn';
        toggleBtn.innerHTML = 'âš™ï¸';
        toggleBtn.style.cssText = `
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 1);
        border: 1px solid #fff;
        color: white;
        font-size: 20px;
        cursor: pointer;
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
    `;

        // åˆ›å»ºé…ç½®é¢æ¿
        const configPanel = document.createElement('div');
        configPanel.id = 'chart-config-panel';
        configPanel.style.cssText = `
        position: relative;
        background: rgba(0, 0, 0, 0.5);
        padding: 15px;
        border: 2px solid #fff;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        color: white;
        transition: transform 0.3s ease, opacity 0.3s ease;
    `;

        configPanel.innerHTML = `
        <h3 style="margin-top:0; color:#fff; border-bottom:1px solid #fff; padding-bottom:8px;">Field Filter</h3>
        <div id="field-configs" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;"></div>
        <div style="margin-top:15px; display:flex; gap:8px;">
            <button id="save-config" style="flex:1; background:#0066cc; color:white; border:1px solid #0ff; padding:5px;">Save Configuration</button>
            <button id="reset-config" style="flex:1; background:#333; color:white; border:1px solid #888; padding:5px;">Reset Configuration</button>
        </div>
    `;

        // æ·»åŠ å…³é—­æŒ‰é’®åˆ°é¢æ¿å³ä¸Šè§’
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = 'Ã—';
        closeBtn.style.cssText = `
        position: absolute;
        top: 5px;
        right: 8px;
        background: transparent;
        border: none;
        color: #fff;
        font-size: 20px;
        cursor: pointer;
        line-height: 1;
        padding: 0;
    `;
        configPanel.appendChild(closeBtn);

        // ç»„è£…å…ƒç´ 
        configContainer.appendChild(toggleBtn);
        configContainer.appendChild(configPanel);
        document.body.appendChild(configContainer);

        // æ·»åŠ äº‹ä»¶ç›‘å¬
        toggleBtn.addEventListener('click', toggleConfigPanel);
        closeBtn.addEventListener('click', toggleConfigPanel);

        // åˆå§‹åŒ–é¢æ¿çŠ¶æ€
        updatePanelVisibility();
    }

    // æ–°å¢å‡½æ•°ï¼šåˆ‡æ¢é¢æ¿å¯è§æ€§
    function toggleConfigPanel() {
        // ä»localStorageåŠ è½½ä¿å­˜çš„çŠ¶æ€
        const savedState = localStorage.getItem('configPanelState');
        if (savedState) {
            isConfigPanelVisible = JSON.parse(savedState);
        }

        isConfigPanelVisible = !isConfigPanelVisible;
        updatePanelVisibility();

        // ä¿å­˜çŠ¶æ€åˆ°localStorage
        localStorage.setItem('configPanelState', JSON.stringify(isConfigPanelVisible));
    }

    // æ–°å¢å‡½æ•°ï¼šæ›´æ–°é¢æ¿å¯è§æ€§
    function updatePanelVisibility() {
        const panel = document.getElementById('chart-config-panel');
        const toggleBtn = document.getElementById('config-toggle-btn');

        if (panel && toggleBtn) {
            if (isConfigPanelVisible) {
                panel.style.transform = 'translateX(0)';
                panel.style.opacity = '1';
                panel.style.pointerEvents = 'auto';
                toggleBtn.innerHTML = 'âš™ï¸';
                toggleBtn.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            } else {
                panel.style.transform = 'translateX(20px)';
                panel.style.opacity = '0';
                panel.style.pointerEvents = 'none';
                toggleBtn.innerHTML = 'âš™ï¸';
                toggleBtn.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            }
        }
    }


    // 2. å­—æ®µé…ç½®å®šä¹‰
    const fieldConfigurations = [
        { id: 'displayName', label: 'Name', field: 'Display_Name', default: true },
        { id: 'department', label: 'Department', field: 'Department_Descr_Short', default: true },
        { id: 'PositionBand', label: 'Position Band', field: 'Position_Band', default: true },
        { id: 'salaryGrade', label: 'Salary Grade', field: 'Salary_Grade', default: true },
        { id: 'effectiveDate', label: 'Effective Date', field: 'Effective_Date', default: true },
        { id: 'Span_of_Control', label: 'Span of Control', field: 'Span_of_Control', default: true },
        { id: 'totalStaffs', label: 'Total Staffs', field: 'Staffs', default: true },
        { id: 'PositionDescr', label: 'Position Descr', field: 'Position_Descr', default: true },
        { id: 'Funding', label: 'Funding', field: 'FTE_Type_Funding_Status', default: true },
        { id: 'CostCenter', label: 'Cost Center', field: 'Cost_Center', default: true },
        { id: 'RiskAssessment', label: 'Risk Assessment', field: 'Risk_Assessment', default: true },
        { id: 'Remark', label: 'Remark', field: 'Mark_in_OrgChart', default: true },
        { id: 'DirectReport', label: 'Direct Report', field: 'Direct_Report', default: true },
        { id: 'Remark2', label: 'Remark 2', field: 'Remark_2', default: false },
        { id: 'Remark3', label: 'Remark 3', field: 'Remark_3', default: false }
    ];

    // 3. å­—æ®µé…ç½®çŠ¶æ€ç®¡ç†
    let fieldConfigState = {};

    function initializeFieldConfig() {
        // å°è¯•ä»localStorageåŠ è½½é…ç½®
        const savedConfig = localStorage.getItem('orgChartFieldConfig');

        if (savedConfig) {
            fieldConfigState = JSON.parse(savedConfig);
        } else {
            // ä½¿ç”¨é»˜è®¤é…ç½®
            fieldConfigState = {};
            fieldConfigurations.forEach(config => {
                fieldConfigState[config.id] = config.default;
            });
        }

        renderFieldConfigUI();
    }

    function renderFieldConfigUI() {
        const container = document.getElementById('field-configs');
        if (!container) return;

        container.innerHTML = '';

        fieldConfigurations.forEach(config => {
            const isChecked = fieldConfigState[config.id];

            const checkbox = document.createElement('div');
            checkbox.style.display = 'flex';
            checkbox.style.alignItems = 'center';
            checkbox.style.gap = '5px';

            checkbox.innerHTML = `
      <input type="checkbox" id="${config.id}" ${isChecked ? 'checked' : ''}>
      <label for="${config.id}" style="cursor:pointer;">${config.label}</label>
    `;

            container.appendChild(checkbox);

            // æ·»åŠ äº‹ä»¶ç›‘å¬
            document.getElementById(config.id).addEventListener('change', (e) => {
                fieldConfigState[config.id] = e.target.checked;
                refreshChart();
            });
        });
    }

    function getNodeContent(d) {
        if (d.data.isVirtual) {
            return `
        <div style="
         
          background-color: transparent; /* å®Œå…¨é€æ˜ */
          border: none; /* æ— è¾¹æ¡† */
        ">
        </div>
      `;
        }
        // --- ä¿®æ”¹ç»“æŸ ---
        const dynamicSrc = `https://corpdir.sharepoint.com/sites/DWT_HRGCPowerBICommunity-DataWorkers/Shared%20Documents/HR%20Data%20Workers/Employee%20Pictures/${d.data.Job_User_ID}.png`;
        const defaultSrc = `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAF8AAABfCAYAAACOTBv1AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAABdzSURBVHhe5Z0JtNXTF8ePh1BJRElKUchYKilKKaVBKEKUTIlFahWRpfxTFrLM46JQallRSYhMadBgKEVSkkqJzGPG8z+f/e6+zvu9c++79707vPiutd+97zec3/nts8/e+5x9zr7bGWOso3KHGjVqmHr16pnatWubvffe2+y2226mcuXKZpdddjE77bST2XHHHU1BQYH566+/zO+//262bt1qfvnlF/PTTz+Zb775xmzatMl8+umnZu3atebnn3+OlVq+kBfmwzRrrZCiQYMG5rDDDjMHHXSQqVOnjtlnn33MnnvuaapWrWp23XVXs/POO5sKFSoI07fffnuh7bbbzvz999/SAH/++af5448/zG+//SaN8OOPP5pvv/3WfPHFF9IQ69atMx9++KF55513pHHKA/LCfJgG4w899FBz7LHHmkMOOcQceOCBZt999xWG77777iLdXFdW0DA0Bg3x5Zdfmk8++cSsXr3avP3222bu3Lnm66+/jl2Ze+Sc+agTGH7MMceYI4880tSvX99Ur17dVKxYUXpEtkEP+eGHH8xnn30mPeG9994zs2fPNsuWLcu5esoZ81ElJ554ojnhhBPM4YcfLv+jTtJhOLr9119/FWlG/6OGYCTH+Y5qQi0l6jGq5vQ8DfHVV19Jb6AnPP/882bhwoVSZkg1ZhpZZz6S3qVLF3PSSSeZxo0biwFFpSQDRvPzzz8X6URX6ydMQa8fddRR5txzzzV169Y1L730kpkyZYowcYcddhC1xXFUGJ808l577SXPhJHRhlHmUvbHH38szKe8t956S+qRTWSM+VFJQRJh+mmnnSYqBiYkYjoSCLPff/998+abb4pOxih+//335rvvvpNPdDYSDi688EJz7bXXmgMOOECk9brrrhP1AfCGsBl4R/q5xx57SIM1a9bMHHzwwfI/BhtonWkUiEZYuXKleeONN8zYsWPNqlWr4u+UDVBymclVPP69RYsW9tZbb7VLliyxzti5uhfCeSZCis2bN1vHPDtgwADbqVMn6xhkq1WrZh1jipQdpeuvv17uBe+++651NiR4nRLluZ5gnRDYbt262VGjRtn58+db16jF6qRwhti+8MIL9oorrrC1atUKlpsBCh4sFVWqVMmed955dtasWdZJbrGX4n8nvXbFihX2nnvusWeeeaZ1qsg63R8sLxHddddd1kmolLlhwwbrbEnwukTkxg22ZcuW1vUg++STT1rnilrX+6Q8QD2dXbFOxVk3VrDjxo2TepYkFKWg4MG0ybmNdvTo0cJY52vHXuMf8HIffPCBvfHGG63T/3a//fazTjUFyyqJxo8fL40InD9vTz755OB1JZFTUda5udapRmGwU33xnuALDs9wtsX27t1beib3OjUrjeH3+FJQ8GBa1KZNGztp0iTr/OgilVYgPbfddpuoFqSuLBJUpUoVO3369PhzaNS+fftaZ0+C16dC1MeNM2zPnj3t008/bZ19kbJ90Auca2pvuOEGERyYXkbGQ8GDKdMZZ5xhX375ZdGfdFWf+c4ttNOmTbO9evUSneu8kWAZ6ZAbBVtnDGNPKMSIESOs82iC16dCKsX0ROcG26uuusq6kbDdunVr7An/YOPGjfbBBx+0biQeLCtNCh5Mifr06WOdSyZMjnZV57ZZ55HYI444Qrp36P7SUNeuXa3zbGJPKcTDDz9snecTvD4V8qWYhnDuqm3durV99NFHrXNh5Rm8mwoXPYOejiBEy0qTggeTEhW84IILhAnod79iqAEMrvPD5SVC95eF+vXrZ9esWSMMUeCVNGrUKHh9ukQPUF2OdCNAH330kbwX76jv6cYAdurUqdaN0oPlpEjBg0kJxi9fvlz0oF8hPBCk5fjjjxcPJgM6sRg5n14Mo49U3M1Uye8FkBskimqdN2+eqCF9Xwg3+plnnilLAwQPJiQkeunSpcJ4lXQqgl+M7sVwoTuzwXjo9ttvF/viw41+bfv27YPXZ4JQm7imGHoknveGtAFwV/H2QveWQMGDQUICFi9eHJcAZTwDnmHDhoknE7ovk0TPirqyZXE30yF8/SlTphRrAHo8rmopjHDwoBC6XSW4Xbt29rXXXhPjCtN9xg8dOlS6p399tmjy5Mny0j6oR/fu3YPXZ4r03bAt1AGG+wLIoHLMmDHihkbv8cuJUPCg3IhryM20OP4vEuY/EFWDxMN47sk24+vUqSPGPIQhQ4bYqlWrBu/LBPnvhgeHsdUeAC/4xA0dPHiwrV69erF7ElDwoNwI8ULoWRitXQ1C7w4fPjwnqkYJvY7/HcJDDz1k999//+B92SAEEi8LFQw/FCtXrpT5oxQHfcGDcbrooovsqlWr5AHawkj+Aw88YOvVq5cTVaPEvBF1CeHZZ58ViQzdly3q0KGDXbRokfBFwXcmC1NxfZNGMlq0aGHOPvtsmRd3DI7TK6+8YiZMmGA2bNhQZBo52yA2UKlSpdh/RaHRsFyCMCTTzgRjFE4YjXO1Tc+ePU2tWrViR8NIyHwKOf30002TJk0kOgRgvBtwGOdxyPy56wE5YzwgUMJ8fQicyzXziao5P19iCn4sGAFBaF1PjMcNQkjI/FNPPVXCfoT6lMEEGtxQXiQ/H8sxCIIkYn6yc9kEQXmngs38+fNl5YRqAuf1mD59+sjCgEQIMp+o01lnnSXLOXzMnDnTOCOTl4g/kTGWkfAZAkJCXDeZpGULaIOJEyeaNWvWxAUVLUHoFBVUpUoVORZFkPmE/wi5EZBWPc8DnH8ri5DyAfQnzEcdhkD8lvgwjZBLUB+1g8STCXfyP41ACBPVzQqNEIq9CdLeqVMnWbSkrUjQGsYTX2VlWD5AvJaYbAja1ZNdky3os4k5P/HEE2b58uWykAvQCM2bNxfpRy1GUYz56HmWdmj3pgDWtLjRrdmyZYscyweQ/GRSTT1LuiYbUAEFLAB49dVXZZUc9QGowlNOOcW4MYj876MI85H2tm3bmpo1a8YLxYigz5YuXSrHtNBcI5mbqXXKh7vpg9UVkyZNEk/Q+fuxo0Y8RigqGMJ81VutW7eWJXy6xgWsWLHCLF68WJZwcMxv6VwimZupyIe7GQU+P54P64gUSH/Hjh3FA1JeA2G+MpVlfBgtwAUQup5ldSBfjAcYWxyAZEDfl3RNLjB16lThmc8vBqyoReU1iDO/cePGMiiga+tJVomVh1W9uGq66iwZkDCkv6Trsg08wyVLlsi4CMBP6oVwoxoVcZ2PymE9vHYJPhcsWCBTCPkG+h63LZGbqWAkjr1KZBtyBfQ9nuHGjRtjRwpd4TZt2sgYSlVP/G1YG490AU5gaPFw1q9fL8fyCdZdpuLFUO9Ur8025syZI8seaQgVaOWxqh5hfsOGDcVH9rsrKoeFo/j1enO+gB1KNEqMIp1rswmmHXBWcFQU2C28HlQQEOY3bdpUjIHPZFxL/FVtpXyCbUHo81TAtflWOwp4SCMA5eHRRx8tqhEI89mKU61atTij6SpsGED68814kIqbqSgP7qYC1cN0jPIQ4WaVNLwGwny/q3IBVhpdX142kqXiZirKi7sJNm/eLHsLfNWNTVJeFzCqxZvwd3TAeNbElwdQUeZFEs1mRoHKQbLy7W4q8BbV5QQIBvNnMkmIsVUDoGCU5huKfALBQJpLcjMVNBICVV70PttRo7xUnhcQIqQVfJQnyVdj6zsDycB15cno6nYmH/j69OiCaEUxtqEb8gUqygArHZQXXx+gdpjjV2cGiu++jBoo5u4ZmZUXY5tsNjMR0nFNsw2MLtMzOstJz4TneG8FtIAGyAGWGcYTHM8H/Fk/pjvYyIbkE6BI1e0lcoQ/HQpg5Bo+P/W9EAxsUwEtwLyDgoh8PhivTNeu2apVKzN8+HDTvn17kXzOaeVLAkP4Sy+91Fx22WXxWdp8ggbweYqmIdZcgNT7QWfUjnaRXEKZDnXv3l22d/bo0UPUjno6nEsFXI9H0b9/fzNs2DAZROYTBFl8niLs1LEAxvsSRQtpDDJXUObC6AEDBsgeW+KeUaOZquQDrmXKhFUYo0ePlvBovjygKPO1lxfwJ8r8VCUsU+B5zPhdc801ZtCgQaZRo0bFRqnpMl6BG81qjFGjRsmudX8+PVeA8T5PlecFUUOWzktmCh06dBD93rt3bwm1+TYoE6AhWQozePBgoVAwO5uIahf4DRXQKr6aYVie7YVH2u0A0oh+79y5s0wLZKvxKZdhfd++fc3IkSOlpwG/LtmCGNeYagXaEwoImvj6CCnJtORFwYNxI1EzQ4cOFbeQ5/o9MFvAE2Ipx5gxY2RBE25stp8bdefVqSkIuUHZZj6JMJB2jCuJjvB5kb5sS6ACPxsXdsSIEaZfv35imLMJmB9y5wsYANASCpjPvIPfUplEt27dhPFIHUEF7fa5Yrw+B2agehgL0AOTLWgtC+Al5DNfeV7AvAPSr4DpGD1uyCTo3vjdMJ6ER5kuvzRA3TAPxHJu3FEC3AhfJkGv0llZngcxywnPC5h70KQ+qvsyPTHFgIfBzpAhQ2S6IN2l3NQr6pXRbbFXZR2T0BMw9F27djU33XST6dWrVzzSpCiLUWZ6G0HT+/kkPIv0b+8k8gYGNFykJ1ltxaorGqY08C17u3btzMCBA0XNIAXpelLKcOoFMUk1b948c//995vHH39cZg15OXpWurZKywTUi/ohKJSlMQ3eRaW2NOD9sS/MM+mzWNHMmk4Oyh4iH2zqIpOIuy5tchUV4rvrzvb111+XbZNOQmOlpwfuI70Le7FIOMEm7KZNm8Zz9Lheatu2bWuvvPJKO2PGDOukqsgeqVSh9eOT/DuuYSUJBu/iGqbU+85cb4rnb1CQwsD1fs4bO3bs2CIZNsqyqZhKsmXz6quvtsuWLYvnZkgEziU6zw5Itn7CWBIasdvQjUOCz3XSL5vQqPedd94puX38d0r2HB96DTxgt2GPHj2s09nyDBoi3UaIbtpmFyfJO2Lnjf3f//4nuXIAD0dySKXlfOIiBaVCSCUSyp7UVCQwyhCkfPXq1faRRx6R5EK+lKdKNL4z6iIAM2fOtFu2bClVb3AeiST3YJO3U0nC+HQagJQA9Hz/HUkG5dS8XmMkyQ8HgV5IF053ayX7T9mSGUoWVBKcfrWzZ8+2zu2TTFT169e3zvMIPicZ+WoClUreNmdv7L333ivJivzekArgx7p16yQtGXkl0pF8kjAhSD5IH+BcXL2mMOfYiy++GDtdiPXr15eYu0yloFKlSpKvbMGCBUUS2kWhvUobmE/y8tA1qWjz5s2FYZQbel4qRH2iDKIx6tatKykM2DHvDJ40djpABZLgguwmqL5UesAdd9xRLEkHCfO8nlx4IarCuT+xSwq7HBmXYIZeEyUe3qBBA8mbRk6aVPU7FSK7H+WzkRiJKo2Ul4acG2mbNWsmedXuu+8+MeS+Tk4E6g1/yHKFoOxZQi4h+EJeNl/dodpJdeZdV/jFjfTs2rVrY5cVAi8oWS4ZPKIJEyaIh+H8bqFEzOcc5eNFnH/++ZJCpWosV0I6ejSTRG+gd6PTMeyoy0T1h4kQ74H6Ij0k94fKhchJFFU59LgmTZr41xV+wUihevyH4yJ16dJFGBNlkOZWwyvgHqUoOI+Uu5Gt7dy5c1DK88F4n+jdGPZzzjlHDD1Mi/aG6PuRcIk0L2QnpIwof6KahEbDAVC1Grv2n0qQARBd6DMTQ0MaEy24Ro0a4vqR3SmUWw2olKMj8WmRcro7D/WfV15ImVGhQgUx9PQGknqgYlCR0ffTd+bcc889J64jrq6W16pVK7tw4cIi92FDcSQijfRPJfCRca24SQ2jG+mJoeI8mTbuvvtuSdUIg33jCZByjC42AM8HqahYsWK8/PJKvsQqVa9eXTLQot8fe+wxESbsIPD5wzEEcdCgQbZmzZpy78033yz5d/RaaOLEicWSITHWv8GRgGkF5l6Y4WOCzVVK5niYfGP6wekxmQvXoDbnIdb5sAHYdTXZuejUl2wfZQ6D2bttEcy9sMiVvMq8CztNWPrHFIZTHfFpcPjAOiFWHzMtQZiSBQAEbjgP4J8z7rLTxwmtHFMUaY1QWhVXCTmGZANaEpeSlF8jR460rkFkQLEtSHlZCJVLnmiMKY4G/r/2BoDjgTGOupdJsh8WPYDPT85ImKvdS7sYxMj1qaeesv379xfdRvfEj46W828mHAYn6eI2MjuAqo06HkrY0IsvvjjRKL3YAbH6TK5xszIfMHplYosR2r9dylMlegMDL7w5BozwDOgnGQmZoAvdG1x37VxISeLvpD92xF1prcxzs8mLbe7+uf8ysGtMv6PLNU7hGC+fpEuYNm2aTE+rjYwi2CpM05KqlxbUVsRvJd8armfonv8aqduIN0jSU/S/zy8/zTDXRe93VOyAEPPNjOIwIj7Q+ZdccklWM/ltKwRDmUbARqozomCikgEqY4fQvTEKHhRiwIHOio72+EWI4447LnjPf40YjEUFlIYgxWOyebEYBQ/GidEbgwgGVdqd+E4OYTUkkVHbf4aYyWVCUfmiKmf8+PEyjZICX4IH41S5cmXJpL1hwwZ5AOAB6H983YYNG/4nGc9PjqABfD8fvmAnmUZg2jkFvgQPFmk1Jt2YKGLIrK2L+4kPSwiyFDmEt2kidbAb8cbnthS4mgzA0pitDR4sdhMSzuCKFLY66AJMw9IwGB7/+n8rwfi5c+fGGa+8INiCnvfn+Ust+SFiLpqYKKE4vwGYemaeXqdX/62EqlGJB7w/xOoMfqyHOC/SnsZqh+DBYkShEKM5Yq0EumkAJeYzJk+eXGQ0l0K322aIAFD0d1RgPP8TLmRlhTKez1AZAQoeLEbKRAonoTSDCr8BAEaYnkHAGr3HPdtiA/h1Jl80UwdMmKlxVYmnBxCKxObtEMu4nua7Bg8mJQYOBBzIp6+SoBWigvykB/6vH4TZlkjrzMgVt5HfCODdFHxH1SDxPuOj5aRAwYMlEg3AL+oQyUHi/coBRsJUnAB5uutu8k21a9e2l19+uZ0zZ06xkSvAuPLzgwxCVc3klPkQD2ZdDMZWIzc+8Izwe/lhr2TB5nyR6mifcR07dhShIVqHWo2CXypi1QXudylVjU/BgymRtjhu6C233CJBlyjoEQSb+bEyYr9IVaisfJDPOGIThP8IECHt2LFob0aQ+D0B3EneHYqWmSYFD6ZEfosjCXgEBI5D62CwBUR++LmLgQMHyvV+WVAZum+pieUvMB3fXZeOwHh/OoXGYDTP6gsdQGWinkww8yUjYLsNP61N6nJSwIe2XTLvzW/fEhcl/SHLvRctWiTLsd0LlXopdjogvkqaRXYokvPMGU1ZZu4aX85rHagP+THHjRtnnG2TrFFOiOR8JuqZUeYryH3ALg92fJDIObr5WCtPYJmg9KpVqyQZHDnJCDJnI0U86+7ZC8ZWIL5TRzaBJNqoQZBkxowZQggI+wJAJgUkK8wH9AI2uzmXVKL5miYYuO4sLwEBegMMp0cQ9dm0aZPk/OE7n6wiYGUFUlcSaGhWE8BYcgmx55a9X3yHOMc1SLkvwVofUt2QG42ssHyy+cIZXrkm08ga8xWoHpZVkMgf4jv7npTxUdAwbvAiyZaQNtQRnxDblzhHIzi9LOS8FVnmQpkQS10Id7IPCmKZB8d0qYcPX4J5Hupv+vTp0vsIl7J8JJvIOvMVrPtB17Zs2VK2yrA+yBmvhI3gAybRO2C6Mp5jNBQSDLGehkbgkwZJtVzWHMHsWbNmiQ1CBToDG7siu8gZ8xVIJaqAxmBXIvvBaBT2qvrw1QHfIb6nwtSSQC/CxujiLtQbxjTXiwJyznwfzt2Unegke8Mwk1yVzLasiPPVhN8QpQHqCnuCVJOimN82Idko/2P06UH5QF6ZD9TwYRQxkqqjsQ0YbI7ROLiC9A6MNurFdwthHuoIe4CeRn/jrSDNSDaMx5BitElRnCu1UhLyznxVK1GgnugBrH/EO1Gmo9Mh/qcB1A6oTcAzcYM8YTBSDePL5xojY/4PQ7EU4HLLk7wAAAAASUVORK5CYII=`;



        // åˆ¤æ–­ Risk_Assessment æ˜¯å¦ä¸º 'Yes' æˆ– 'compulsory'ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
        const isRiskRed = d.data.Risk_Assessment && (d.data.Risk_Assessment.toLowerCase() === 'yes' || d.data.Risk_Assessment.toLowerCase() === 'compulsory');
        const idColor =
            !d.data.Display_Name || d.data.Display_Name.trim() === '' ? 'red' : '#212121';
        // è®¾ç½®å­—ä½“é¢œè‰²ä¸ºçº¢è‰²ï¼Œå¹¶åŠ ç²—ï¼Œå¦‚æœç¬¦åˆæ¡ä»¶
        const riskStyle = isRiskRed ? 'color: red; font-weight: 600;' : '';

        // åŠ¨æ€è®¾ç½®é¡¶éƒ¨æ¸å˜æ¡çš„é¢œè‰²
        let gradientColor = '';
        if (d.data.Position_Band === '1' || d.data.Position_Band === 'B' || d.data.Position_Band === 'C' || d.data.Position_Band === '001') {
            gradientColor = 'background:darkgreen ;';
        } else if (d.data.Position_Band === '2' || d.data.Position_Band === '002') {
            gradientColor = 'background: lawngreen;';
        } else if (d.data.Position_Band === '3' || d.data.Position_Band === '003') {
            gradientColor = 'background: navy;';
        } else if (d.data.Position_Band === '4' || d.data.Position_Band === '004') {
            gradientColor = 'background: skyblue;';
        } else if (d.data.Position_Band === 'AL') {
            // åˆ¤æ–­æ˜¯å¦æœ‰å­èŠ‚ç‚¹
            const hasChildren = d.children && d.children.length > 0;
            gradientColor = hasChildren ? 'background: gray;' : 'background: white;';
        }


        return `
  <div style="
    padding-top: 30px;
    margin-left: 0;
    height: ${d.height}px;
    overflow: visible;
  ">
    <div style="
      height: ${d.height - 32}px;
      background-color:#ffffff;
      border-radius: 12px;
      border: ${(
                String(d.data.Mark_in_OrgChart ?? '').toLowerCase().includes('dot') ||
                String(d.data.Remark_2 ?? '').toLowerCase().includes('dot') ||
                String(d.data.Remark_3 ?? '').toLowerCase().includes('dot')
            )
                ? '4px dashed #000'
                : '1px solid rgba(0,0,0,0.05)'
            };

      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: relative;
    ">
      <!-- é¡¶éƒ¨æ¸å˜æ¡ï¼Œä½¿ç”¨åŠ¨æ€é¢œè‰² -->
      <div style="
        position: absolute; top: 0; left: 0;
        width: 100%; height: 8px;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        ${gradientColor}  /* åŠ¨æ€èƒŒæ™¯é¢œè‰² */
      "></div>
      
      <!-- å¤´åƒ -->
      <img
        
        src="${dynamicSrc}"
        onerror="this.onerror=null; this.src='${defaultSrc}';"
        
        style="
          position: absolute; top: -30px;
          left: calc(50% - 30px);
          width: 60px; height: 60px;
          border-radius: 50%;
          border: 2px solid rgba(64,201,255,0.8);
          box-shadow: 0 2px 6px rgba(64,201,255,0.3);
          background-color: #fff;
        "
      />

      <!-- ID -->
      <div style="
        position: absolute; top: 12px; right: 12px;
        color: ${idColor}; font-size: 16px;
      ">${d.data.id}</div>

      <!-- PB -->
      <div style="
        position: absolute; top: 12px; left: 12px;
        color: #212121; 
      ">
      ${fieldConfigState.PositionBand ? `<div style="font-size: 20px; font-weight: 1000;">${d.data.Position_Band}</div>` : ''}
      </div>

      <!-- å†…å®¹åŒº -->
      <div style="padding: 50px 20px 20px; text-align: center; color: #212121;">
        ${fieldConfigState.displayName ? `<div style="font-size: 18px; font-weight: 600;">${d.data.Display_Name}</div>` : ''}
        ${fieldConfigState.department ? `<div style="font-size: 14px; margin-top: 4px; color: #555;">${d.data.Department_Descr_Short}</div>` : ''}
      </div>

      <style>
        .info-row {
          display: flex;
          justify-content: space-between;
          padding: 0 20px;
          margin-bottom: 8px;
          color: #212121;
          font-size: 13px;
        }
        .info-row .label {
          color: #212121;
          margin-right: 4px;
        }
        

      </style>


      ${fieldConfigState.PositionDescr ? `
      <div class="info-row">
        <div><span class="label">Position Descr:</span>${d.data.Position_Descr}</div>
      </div>` : ''}

      ${fieldConfigState.salaryGrade ? `
      <div class="info-row">
        <div><span class="label">Salary Grade:</span>${d.data.Salary_Grade}</div>
      </div>` : ''}

      ${fieldConfigState.effectiveDate ? `
      <div class="info-row">
        <div><span class="label">Effective Date:</span>${d.data.Effective_Date}</div>
      </div>` : ''}

      ${fieldConfigState.Span_of_Control || fieldConfigState.totalStaffs ? `
      <div class="info-row">
        ${fieldConfigState.Span_of_Control ? `<div><span class="label">Span_of_Control:</span>${d.data.Span_of_Control}ğŸ‘¤</div>` : ''}
        ${fieldConfigState.totalStaffs ? `<div><span class="label">Staffs:</span>${d.data.Staffs}ğŸ‘¤</div>` : ''}
      </div>` : ''}

      ${fieldConfigState.Funding || fieldConfigState.CostCenter ? `
      <div class="info-row">
        ${fieldConfigState.Funding ? `<div><span class="label">Funding:</span>${d.data.FTE_Type_Funding_Status}</div>` : ''}
        ${fieldConfigState.CostCenter ? `<div><span class="label">Cost Center:</span>${d.data.Cost_Center}</div>` : ''}
      </div>` : ''}

      ${fieldConfigState.RiskAssessment || fieldConfigState.DirectReport ? `
      <div class="info-row">
        ${fieldConfigState.RiskAssessment ? `<div><span class="label" style="${riskStyle}">Risk Assessment:</span><span style="${riskStyle}">${d.data.Risk_Assessment}</span></div>` : ''}
        ${fieldConfigState.DirectReport ? `<div><span class="label">Direct Report:</span>${d.data.Direct_Report}ğŸ‘¤</div>` : ''}
      </div>` : ''}

       ${fieldConfigState.Remark ? `
      <div class="info-row">
        <div><span class="label">Remark:</span>${d.data.Mark_in_OrgChart}</div>
      </div>` : ''}

      ${fieldConfigState.Remark2 ? `
      <div class="info-row">
        <div><span class="label">Remark 2:</span>${d.data.Remark_2}</div>
      </div>` : ''}

      ${fieldConfigState.Remark3 ? `
      <div class="info-row">
        <div><span class="label">Remark 3:</span>${d.data.Remark_3}</div>
      </div>` : ''}

      <!-- å¯ä¿ç•™å›¾è¡¨å®¹å™¨ -->
      <div id="chart-container-${d.data.id}" style="height: 100px; margin: 0 20px;"></div>
    </div>
  </div>
  `;
    }


    // 5. åˆ·æ–°å›¾è¡¨å‡½æ•°
    function refreshChart() {
        if (chart) {
            // æ›´æ–°èŠ‚ç‚¹å†…å®¹å‡½æ•°
            chart.nodeContent(getNodeContent);
            // é‡æ–°æ¸²æŸ“å›¾è¡¨
            chart.render();
            chart.collapseAll();
        }
    }

    // 6. ä¿å­˜å’Œé‡ç½®é…ç½®åŠŸèƒ½
    function setupConfigActions() {
        document.getElementById('save-config')?.addEventListener('click', () => {
            localStorage.setItem('orgChartFieldConfig', JSON.stringify(fieldConfigState));
            alert('Config Savedï¼');
        });

        document.getElementById('reset-config')?.addEventListener('click', () => {
            // é‡ç½®ä¸ºé»˜è®¤é…ç½®
            fieldConfigurations.forEach(config => {
                fieldConfigState[config.id] = config.default;
            });

            renderFieldConfigUI();
            refreshChart();
        });
    }

    function getFieldCount(d) {
        return fieldConfigurations.reduce((count, config) => {
            // config.id å¦‚ "displayName"ï¼Œconfig.field å¦‚ "Display_Name"
            if (fieldConfigState[config.id] && d.data[config.field] != null) {
                return count + 1;
            }
            return count;
        }, 0);
    }

    const defaultFieldCount = fieldConfigurations
        .filter(cfg => cfg.default)
        .length;
    const defaultHeight = 370;  // åˆå§‹é«˜
    const unitHeight = 22;      // â€œå‡ä¸€è¡Œâ€å°±ç”¨ 22px

    function computeNodeHeight(d) {
        /* â‘  å…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯è™šæ‹ŸèŠ‚ç‚¹ â€”â€” åœ¨ applyVirtualGrouping é‡Œå·²ç»å†™äº† isVirtual:true */
        if (d.data && d.data.isVirtual) {
            return 1;        // åªæœ‰ 1â€¯px é«˜ï¼›å¦‚æœæƒ³ç¨å¾®èƒ½çœ‹è§ï¼Œå¯æ”¹æˆ 12ã€20 ç­‰
        }
        const currentCount = getFieldCount(d);
        const removed = defaultFieldCount - currentCount;
        const steps = Math.floor(Math.max(removed, 0) / 2);
        return defaultHeight - steps * unitHeight;
    }


    // ä½¿ç”¨è¿™ä¸ªæ–°ç‰ˆæœ¬å®Œæ•´æ›¿æ¢æ—§çš„ displayChart å‡½æ•°
    function displayChart(data) {

        // --- æ ¸å¿ƒä¿®æ­£ï¼šåˆ›å»ºæ•°æ®çš„â€œæ·±æ‹·è´â€ï¼Œå½»åº•éš”ç»æ•°æ®æ±¡æŸ“ ---
        // è¿™æ ·æ— è®ºåç»­D3åº“å¯¹æ•°æ®åšä»»ä½•ä¿®æ”¹ï¼Œéƒ½ä¸ä¼šå½±å“åˆ°æˆ‘ä»¬çš„åŸå§‹æ•°æ®æº
        const dataForChart = JSON.parse(JSON.stringify(data));

        console.log('è¿›å…¥äº†displayChartå‡½æ•°ï¼Œå¼€å§‹ç»˜åˆ¶å›¾è¡¨');
        if (!dataForChart || dataForChart.length === 0) {
            alert('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æ•°æ®ï¼Œè¯·ç¡®è®¤æœç´¢æ¡ä»¶');
            return;
        }

        // æ¸…ç©ºä¸Šä¸€æ¬¡çš„å›¾è¡¨ï¼Œç¡®ä¿ä¸€ä¸ªå¹²å‡€çš„ç”»å¸ƒ
        document.querySelector('.chart-container').innerHTML = '';

        // ç¡®ä¿é…ç½®é¢æ¿å­˜åœ¨ (è¿™éƒ¨åˆ†é€»è¾‘ä¸å˜)
        if (!document.getElementById('chart-config-container')) {
            createConfigPanel();
            const savedState = localStorage.getItem('configPanelState');
            if (savedState !== null) {
                isConfigPanelVisible = JSON.parse(savedState);
            }
            initializeFieldConfig();
            setupConfigActions();
            updatePanelVisibility();
        }

        // åˆå§‹åŒ–å›¾è¡¨å®ä¾‹ï¼Œæ³¨æ„è¿™é‡Œä¼ å…¥çš„æ˜¯æ·±æ‹·è´åçš„ dataForChart
        chart = new d3.OrgChart()
            .container('.chart-container')
            .data(dataForChart) // <--- ä½¿ç”¨æ·±æ‹·è´çš„æ•°æ®
            .nodeWidth((d) => 370)
            .initialZoom(0.7)

            .nodeHeight(computeNodeHeight)
            .childrenMargin((d) => 40)
            .compactMarginBetween((d) => 35)
            .compactMarginPair((d) => 80)
            .nodeContent(getNodeContent)


            .compact(true)
            .onExpandOrCollapse(node => {
                // åˆšåˆšè¢«â€œå±•å¼€â€çš„åˆ¤å®šï¼šæœ‰ children ä¸”æ²¡æœ‰ _children
                const justExpanded = !!node.children && !node._children;
                // åˆšåˆšè¢«â€œæ”¶å›â€çš„åˆ¤å®šï¼šæ²¡æœ‰ children ä¸”æœ‰ _children
                const justCollapsed = !node.children && !!node._children;

                // A) ç¦æ­¢æ”¶å›ï¼šå¦‚æœè¢«æ”¶å›çš„å°±æ˜¯â€œè™šæ‹Ÿç»„â€æœ¬èº«ï¼Œç«‹åˆ»åå‘å±•å¼€å›æ¥
                if (justCollapsed && node.data && node.data.isVirtual) {
                    node.children = node._children;
                    node._children = null;
                    chart.update(node);  // ç«‹å³åˆ·æ–°è§†å›¾
                    //setTimeout(restyleVirtualNodeButtons, 0);
                    return;              // ç›´æ¥è¿”å›ï¼Œé˜»æ­¢åç»­é€»è¾‘
                }

                // B) åŸæœ‰é€»è¾‘ï¼šå½“çˆ¶èŠ‚ç‚¹è¢«å±•å¼€æ—¶ï¼Œè‡ªåŠ¨æŠŠå®ƒçš„â€œè™šæ‹Ÿç»„â€å­©å­ä¹Ÿä¿æŒä¸ºå±•å¼€æ€
                if (justExpanded && Array.isArray(node.children)) {
                    node.children.forEach(child => {
                        if (child.data && child.data.isVirtual && child._children) {
                            child.children = child._children;
                            child._children = null;
                        }
                    });
                    chart.update(node);
                    //setTimeout(restyleVirtualNodeButtons, 0);
                }
            })
            .render()

            .collapseAll();
        //setTimeout(restyleVirtualNodeButtons, 0);



    }






    function collapseToOneLevel() {
        // ç¡®ä¿å›¾è¡¨å·²å­˜åœ¨ä¸”æœ‰æ•°æ®
        if (!chart || !data_by_position || data_by_position.length === 0) {
            alert('You should create a org chart before collapse');
            return;
        }

        // 1. åœ¨å½“å‰å›¾è¡¨æ•°æ®ä¸­æ‰¾åˆ°æ ¹èŠ‚ç‚¹ (parentId ä¸º null çš„èŠ‚ç‚¹)
        const rootNode = data_by_position.find(d => d.parentId === null);

        if (!rootNode) {
            console.error("åœ¨å½“å‰å›¾è¡¨ä¸­æœªæ‰¾åˆ°æ ¹èŠ‚ç‚¹");
            return;
        }

        // 2. è°ƒç”¨å›¾è¡¨åº“çš„ collapseAll æ–¹æ³•ï¼Œæ”¶èµ·æ‰€æœ‰èŠ‚ç‚¹
        chart.collapseAll();

        // 3. æ¥ç€è°ƒç”¨ expand æ–¹æ³•ï¼Œä»…å±•å¼€æ ¹èŠ‚ç‚¹ï¼Œè¿™æ ·å…¶+1çº§çš„å­èŠ‚ç‚¹å°±ä¼šæ˜¾ç¤ºå‡ºæ¥
        // d3-org-chart åº“çš„ expand æ–¹æ³•ä¼šè‡ªåŠ¨å¤„ç†æ¸²æŸ“å’ŒåŠ¨ç”»
        chart.expand(rootNode);
    }




    // 8. ä¿®æ”¹DOMContentLoadedäº‹ä»¶ï¼ˆç¡®ä¿é…ç½®é¢æ¿åœ¨å›¾è¡¨ä¹‹ååˆ›å»ºï¼‰
    document.addEventListener("DOMContentLoaded", function () {

        const addDataBtn = document.getElementById('addDataBtn');
        const addDataModal = document.getElementById('addDataModal');
        const cancelBtn = document.getElementById('cancelAddData');
        const confirmBtn = document.getElementById('confirmAddData');
        const dropdown = document.querySelector('.dropdown');
        const editBtn = document.getElementById('editBtn');
        const editMenu = document.getElementById('editMenu');
        const undoBtn = document.getElementById('undoAddBtn');
        const redoBtn = document.getElementById('redoAddBtn');
        const removeDataBtn = document.getElementById('removeDataBtn');
        const modifyDataBtn = document.getElementById('modifyDataBtn');
        const modifyDataModal = document.getElementById('modifyDataModal');
        const cancelModifyBtn = document.getElementById('cancelModifyData');
        const confirmModifyBtn = document.getElementById('confirmModifyData');
        const exportBtn = document.getElementById('exportCsvBtn');
        if (exportBtn) exportBtn.addEventListener('click', exportEditedDataCsv);

        undoBtn.onclick = undoLastAdd;
        redoBtn.onclick = redoLastAdd;
        removeDataBtn.onclick = removeNode;

        modifyDataBtn.onclick = initiateModifyNode;
        confirmModifyBtn.onclick = confirmModification;
        cancelModifyBtn.onclick = () => {
            modifyDataModal.classList.remove('open');
            nodeToModify = null; // å–æ¶ˆæ—¶æ¸…ç©º
        };

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯ä¹Ÿèƒ½å…³é—­
        modifyDataModal.addEventListener('click', e => {
            if (e.target === modifyDataModal) {
                modifyDataModal.classList.remove('open');
                nodeToModify = null; // å–æ¶ˆæ—¶æ¸…ç©º
            }
        });

        // ç”¨æ›´å¥å£®çš„ handler æ›¿æ¢åŸå…ˆçš„ç®€å•æ‰“å¼€è¡Œä¸º
        addDataBtn.onclick = () => {
            try {
                const supervisorInput = document.getElementById('new_Reports_To_Position_Number');
                const positionInput = document.getElementById('new_Position_Number');

                // å¦‚æœ data_by_position å·²å­˜åœ¨å¹¶ä¸”æ˜¯æ•°ç»„ï¼Œæ‰¾åˆ°å½“å‰è§†å›¾çš„æ ¹èŠ‚ç‚¹
                if (typeof data_by_position !== 'undefined' && Array.isArray(data_by_position) && data_by_position.length > 0) {
                    const currentViewRoot = data_by_position.find(d => d.parentId === null);
                    if (currentViewRoot && currentViewRoot.id) {
                        // é¢„å¡« Supervisor Position Number
                        supervisorInput.value = currentViewRoot.id;
                    } else {
                        // æ²¡æ‰¾åˆ°æ ¹èŠ‚ç‚¹åˆ™æ¸…ç©ºï¼ˆæˆ–å¯ä»¥ä¿ç•™ä¸Šæ¬¡å€¼ï¼‰
                        supervisorInput.value = '';
                    }
                } else {
                    // æ²¡æœ‰ data_by_positionï¼ˆå°šæœªæ¸²æŸ“å›¾è¡¨ï¼‰ï¼Œé»˜è®¤æ¸…ç©º
                    if (supervisorInput) supervisorInput.value = '';
                }

                // æ‰“å¼€æ¨¡æ€æ¡†
                addDataModal.classList.add('open');

                // UX: å°†ç„¦ç‚¹ç§»åˆ° Position Number è¾“å…¥æ¡†ï¼Œæ–¹ä¾¿ç”¨æˆ·ç›´æ¥è¾“å…¥æ–°æ¡ç›®
                if (positionInput) {
                    positionInput.focus();
                }
            } catch (err) {
                // å‡ºé”™æ—¶ä»ä¿è¯æ¨¡æ€æ¡†èƒ½æ‰“å¼€ï¼Œä¸é˜»å¡ç”¨æˆ·
                console.warn('é¢„å¡« Supervisor å¤±è´¥ï¼š', err);
                addDataModal.classList.add('open');
            }
        };

        cancelBtn.onclick = () => { addDataModal.classList.remove('open'); };
        // ç‚¹å‡» Confirm åæ”¶é›†æ•°æ®ã€å†™å…¥æ•°ç»„å¹¶é‡æ¸²æŸ“
        confirmBtn.onclick = () => {
            addDataModal.classList.remove('open');
            const pos = document.getElementById('new_Position_Number').value.trim();
            const rpt = document.getElementById('new_Reports_To_Position_Number').value.trim();
            const nm = document.getElementById('new_Display_Name').value.trim();
            const pb = document.getElementById('new_Position_Band').value.trim();
            const sg = document.getElementById('new_Salary_Grade').value.trim();
            const cp = document.getElementById('new_Department_Descr_Short').value.trim();
            const pd = document.getElementById('new_Position_Descr').value.trim();
            const cc = document.getElementById('new_Cost_Center').value.trim();
            const fd = document.getElementById('new_FTE_Type_Funding_Status').value.trim();
            const rk = document.getElementById('new_Risk_Assessment').value.trim();
            const rm = document.getElementById('new_Mark_in_OrgChart').value.trim();
            const dt = document.getElementById('new_Effective_Date').value.trim();
            const rm2 = document.getElementById('new_Remark_2').value.trim();
            const rm3 = document.getElementById('new_Remark_3').value.trim();
            if (!pos) {
                alert('Please enter Position Number');
                return;
            }
            if (!dt) {
                alert('Please enter Effective Date');
                return;
            }
            // æ˜ å°„æˆå’Œ CSV å¯¼å…¥æ—¶ä¸€è‡´çš„æ ¼å¼
            const entry = {
                Position_Number: pos,
                Reports_To_Position_Number: rpt,
                id: pos,
                parentId: rpt,
                Display_Name: nm,
                Position_Band: pb,
                Salary_Grade: sg,
                Department_Descr_Short: cp,
                Position_Descr: pd,
                Cost_Center: cc,
                FTE_Type_Funding_Status: fd,
                Risk_Assessment: rk,
                Mark_in_OrgChart: rm,
                Effective_Date: dt,
                Remark_2: rm2,
                Remark_3: rm3,
                _uniqueId: `new-${Date.now()}` // æ–°å¢ï¼šä¸ºæ–°æ¡ç›®ç”Ÿæˆå”¯ä¸€ID
            };
            // --- æ ¸å¿ƒä¿®æ”¹ ---
            // æ­¥éª¤ 1: ä¿®æ”¹â€œçœŸå®æ•°æ®æºâ€ (editedData) å’Œæ’¤é”€æ ˆ
            editedData.push(entry);
            // å°†ç®€å•çš„æ¡ç›®æ¨å…¥æ”¹ä¸ºæ¨å…¥ä¸€ä¸ªå¸¦â€œactionâ€æ ‡å¿—çš„å¯¹è±¡
            undoStack.push({ action: 'add', data: entry });
            redoStack.length = 0; // æ¸…ç©ºé‡åšæ ˆ
            // [æ–°å¢] åœ¨è¿™é‡Œè°ƒç”¨è®¡ç®—å‡½æ•°
            recalculateSubordinateCounts(editedData);

            initDateSlider();

            // æ­¥éª¤ 2: è§¦å‘è§†å›¾çš„å®Œå…¨é‡å»º
            // 2a. ä»ä¸Šä¸€æ¬¡æ¸²æŸ“çš„æ•°æ®ä¸­ (data_by_position) æ‰¾åˆ°æ ¹èŠ‚ç‚¹ï¼Œä»¥ç¡®å®šå½“å‰è§†å›¾æ˜¯ä»€ä¹ˆ
            const currentViewRoot = data_by_position.find(d => d.parentId === null);
            if (!currentViewRoot) {
                alert("æ— æ³•ç¡®å®šå½“å‰å›¾è¡¨çš„æ ¹èŠ‚ç‚¹ï¼Œæ— æ³•åˆ·æ–°ã€‚");
                return;
            }

            // 2b. ä½¿ç”¨æ ¹èŠ‚ç‚¹çš„IDï¼Œåœ¨â€œçœŸå®æ•°æ®æºâ€ä¸­æ‰¾åˆ°å¯¹åº”çš„ã€æœªç»è½¬æ¢çš„èŠ‚ç‚¹å¯¹è±¡
            const rootNodeForRemount = editedData.find(d => d.id === currentViewRoot.id);

            // 2c. ä»¥è¿™ä¸ªå¹²å‡€çš„æ ¹èŠ‚ç‚¹ä¸ºèµ·ç‚¹ï¼Œè°ƒç”¨æ€»çš„æ„å»ºå’Œæ˜¾ç¤ºå‡½æ•°
            //      è¿™ä¸ªå‡½æ•°ä¼šå¤„ç†æ’åºã€è™šæ‹Ÿåˆ†ç»„ç­‰æ‰€æœ‰é€»è¾‘
            if (rootNodeForRemount) {
                buildAndDisplayChart(rootNodeForRemount);
            }

            // æ­¥éª¤ 3: å…³é—­å¼¹çª—å¹¶æ›´æ–°æŒ‰é’®çŠ¶æ€


        };

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯ä¹Ÿèƒ½å…³é—­
        addDataModal.addEventListener('click', e => {
            if (e.target === addDataModal) addDataModal.classList.remove('open');
        });




        // å®Œæ•´æ›¿æ¢æ—§çš„ removeNode å‡½æ•°
        function removeNode() {
            const positionToRemove = prompt("Please input Position Number to remove:");
            if (!positionToRemove || positionToRemove.trim() === '') {
                return;
            }

            const trimmedId = positionToRemove.trim();

            // 1. åœ¨ editedData ä¸­æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„è®°å½•
            const matchedPersons = editedData.filter(d => d.id === trimmedId);

            // 2. æ ¹æ®åŒ¹é…æ•°é‡æ‰§è¡Œä¸åŒæ“ä½œ
            if (matchedPersons.length === 0) {
                alert(`Cannot find this Position Number: "${trimmedId}"`);
                return;
            }

            if (matchedPersons.length === 1) {
                // åªæœ‰ä¸€ä¸ªåŒ¹é…é¡¹ï¼Œç›´æ¥æ‰§è¡Œåˆ é™¤
                performRemove(matchedPersons[0]);
            } else {
                // æœ‰å¤šä¸ªåŒ¹é…é¡¹ï¼Œè°ƒç”¨é€‰æ‹©å‡½æ•°ï¼Œå¹¶å°†çœŸæ­£çš„åˆ é™¤é€»è¾‘ä½œä¸ºå›è°ƒä¼ å…¥
                promptUserToSelectRecord(matchedPersons, (selectedPerson) => {
                    performRemove(selectedPerson);
                });
            }
        }

        /**
         * è¾…åŠ©å‡½æ•°ï¼šå°è£…äº†å®é™…çš„åˆ é™¤é€»è¾‘
         * @param {object} nodeToRemove - ç»è¿‡ç”¨æˆ·ç¡®è®¤çš„ã€è¦åˆ é™¤çš„å”¯ä¸€èŠ‚ç‚¹å¯¹è±¡.
         */
        function performRemove(nodeToRemove) {

            const nodesToRemove = [nodeToRemove];

            // å­˜å…¥æ’¤é”€æ ˆ
            undoStack.push({ action: 'remove', data: nodesToRemove });
            redoStack.length = 0;

            // æ–°çš„æ­£ç¡®ä»£ç ï¼šç›´æ¥åˆ¤æ–­å¯¹è±¡å¼•ç”¨æ˜¯å¦åœ¨å¾…åˆ é™¤åˆ—è¡¨ä¸­ï¼Œç¡®ä¿å”¯ä¸€æ€§
            editedData = editedData.filter(d => !nodesToRemove.includes(d));

            // é‡æ–°è®¡ç®—å¹¶åˆ·æ–°å›¾è¡¨
            recalculateSubordinateCounts(editedData);

            const currentViewRoot = data_by_position.find(d => d.parentId === null);
            if (!currentViewRoot) {
                alert("Cannot find current root node, unable to refresh.");
                return;
            }

            const rootNodeForRemount = editedData.find(d => d.id === currentViewRoot.id);
            if (rootNodeForRemount) {
                buildAndDisplayChart(rootNodeForRemount);
            } else {
                document.querySelector('.chart-container').innerHTML = '';
                alert("The root node of the chart has been removed.");
            }
        }
        /**
       * å¯åŠ¨ä¿®æ”¹æµç¨‹çš„å‡½æ•°
       */
        function initiateModifyNode() {
            const positionToModify = prompt("Please input Position Number to modify:");
            if (!positionToModify || positionToModify.trim() === '') {
                return;
            }

            const trimmedId = positionToModify.trim();

            // 1. æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…è®°å½•
            const matchedPersons = editedData.filter(d => d.id === trimmedId);

            // 2. æ ¹æ®åŒ¹é…æ•°é‡æ‰§è¡Œä¸åŒæ“ä½œ
            if (matchedPersons.length === 0) {
                alert(`Cannot find Position Number: "${trimmedId}"`);
                return;
            }

            if (matchedPersons.length === 1) {
                // åªæœ‰ä¸€ä¸ªåŒ¹é…é¡¹ï¼Œç›´æ¥æ‰“å¼€ä¿®æ”¹æ¡†
                populateAndShowModifyModal(matchedPersons[0]);
            } else {
                // æœ‰å¤šä¸ªåŒ¹é…é¡¹ï¼Œè°ƒç”¨é€‰æ‹©å‡½æ•°ï¼Œå¹¶å°†æ‰“å¼€ä¿®æ”¹æ¡†çš„é€»è¾‘ä½œä¸ºå›è°ƒ
                promptUserToSelectRecord(matchedPersons, (selectedPerson) => {
                    populateAndShowModifyModal(selectedPerson);
                });
            }
        }

        /**
         * è¾…åŠ©å‡½æ•°ï¼šå°è£…äº†å¡«å……å¹¶æ˜¾ç¤ºä¿®æ”¹æ¨¡æ€æ¡†çš„é€»è¾‘
         * @param {object} node - ç»è¿‡ç”¨æˆ·ç¡®è®¤çš„ã€è¦ä¿®æ”¹çš„å”¯ä¸€èŠ‚ç‚¹å¯¹è±¡.
         */
        function populateAndShowModifyModal(node) {
            nodeToModify = node; // å°†æ‰¾åˆ°çš„èŠ‚ç‚¹å­˜å‚¨åœ¨å…¨å±€å˜é‡ä¸­

            // è·å–æ¨¡æ€æ¡†åŠå…¶æ‰€æœ‰è¾“å…¥å­—æ®µ
            const modal = document.getElementById('modifyDataModal');
            document.getElementById('modify_Position_Number').value = node.Position_Number || '';
            document.getElementById('modify_Effective_Date').value = node.Effective_Date || '';
            document.getElementById('modify_Reports_To_Position_Number').value = node.Reports_To_Position_Number || '';
            document.getElementById('modify_Display_Name').value = node.Display_Name || '';
            document.getElementById('modify_Position_Band').value = node.Position_Band || '';
            document.getElementById('modify_Salary_Grade').value = node.Salary_Grade || '';
            document.getElementById('modify_Department_Descr_Short').value = node.Department_Descr_Short || '';
            document.getElementById('modify_Position_Descr').value = node.Position_Descr || '';
            document.getElementById('modify_Cost_Center').value = node.Cost_Center || '';
            document.getElementById('modify_FTE_Type_Funding_Status').value = node.FTE_Type_Funding_Status || '';
            document.getElementById('modify_Risk_Assessment').value = node.Risk_Assessment || '';
            document.getElementById('modify_Mark_in_OrgChart').value = node.Mark_in_OrgChart || '';
            document.getElementById('modify_Remark_2').value = node.Remark_2 || '';
            document.getElementById('modify_Remark_3').value = node.Remark_3 || '';

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.classList.add('open');
        }

        /**
         * ç¡®è®¤ä¿®æ”¹å¹¶æ›´æ–°æ•°æ®çš„å‡½æ•°
         */
        function confirmModification() {
            if (!nodeToModify) return;

            // 1. ä¸º Undo/Redo ä¿å­˜èŠ‚ç‚¹çš„æ—§çŠ¶æ€ (æ·±æ‹·è´)
            const oldNodeData = JSON.parse(JSON.stringify(nodeToModify));

            // 2. ä»æ¨¡æ€æ¡†è¯»å–æ–°æ•°æ®å¹¶æ›´æ–°èŠ‚ç‚¹å¯¹è±¡
            //    ç”±äº nodeToModify æ˜¯ editedData ä¸­å¯¹è±¡çš„å¼•ç”¨ï¼Œç›´æ¥ä¿®æ”¹å®ƒå³å¯
            nodeToModify.Effective_Date = document.getElementById('modify_Effective_Date').value;
            nodeToModify.Reports_To_Position_Number = document.getElementById('modify_Reports_To_Position_Number').value;
            nodeToModify.parentId = document.getElementById('modify_Reports_To_Position_Number').value; // ç¡®ä¿ parentId ä¹Ÿæ›´æ–°
            nodeToModify.Display_Name = document.getElementById('modify_Display_Name').value;
            nodeToModify.Position_Band = document.getElementById('modify_Position_Band').value;
            nodeToModify.Salary_Grade = document.getElementById('modify_Salary_Grade').value;
            nodeToModify.Department_Descr_Short = document.getElementById('modify_Department_Descr_Short').value;
            nodeToModify.Position_Descr = document.getElementById('modify_Position_Descr').value;
            nodeToModify.Cost_Center = document.getElementById('modify_Cost_Center').value;
            nodeToModify.FTE_Type_Funding_Status = document.getElementById('modify_FTE_Type_Funding_Status').value;
            nodeToModify.Risk_Assessment = document.getElementById('modify_Risk_Assessment').value;
            nodeToModify.Mark_in_OrgChart = document.getElementById('modify_Mark_in_OrgChart').value;
            nodeToModify.Remark_2 = document.getElementById('modify_Remark_2').value;
            nodeToModify.Remark_3 = document.getElementById('modify_Remark_3').value;

            // 3. ä¸º Undo/Redo ä¿å­˜èŠ‚ç‚¹çš„æ–°çŠ¶æ€ (æ·±æ‹·è´)
            const newNodeData = JSON.parse(JSON.stringify(nodeToModify));

            // 4. å°†â€œä¿®æ”¹â€æ“ä½œæ¨å…¥æ’¤é”€æ ˆ
            undoStack.push({ action: 'modify', oldData: oldNodeData, newData: newNodeData });
            redoStack.length = 0; // æ¸…ç©ºé‡åšæ ˆ

            // [æ–°å¢] åœ¨è¿™é‡Œè°ƒç”¨è®¡ç®—å‡½æ•°
            recalculateSubordinateCounts(editedData);

            initDateSlider();

            // 5. å…³é—­æ¨¡æ€æ¡†å¹¶é‡ç½®å…¨å±€å˜é‡
            document.getElementById('modifyDataModal').classList.remove('open');
            nodeToModify = null;

            // 6. é‡æ–°æ¸²æŸ“å›¾è¡¨
            const currentViewRoot = data_by_position.find(d => d.parentId === null);
            if (currentViewRoot) {
                const rootNodeForRemount = editedData.find(d => d.id === currentViewRoot.id);
                if (rootNodeForRemount) {
                    buildAndDisplayChart(rootNodeForRemount);
                }
            }
        }

        // åŸæœ‰çš„æœç´¢æ¡†äº‹ä»¶ç›‘å¬...

        // ç¡®ä¿åœ¨é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–é…ç½®
        if (!document.getElementById('chart-config-container')) {
            createConfigPanel();

            // ä»localStorageåŠ è½½é¢æ¿çŠ¶æ€
            const savedState = localStorage.getItem('configPanelState');
            if (savedState !== null) {
                isConfigPanelVisible = JSON.parse(savedState);
            }

            initializeFieldConfig();
            setupConfigActions();
            updatePanelVisibility(); // åº”ç”¨åˆå§‹çŠ¶æ€
        }



        // ç‚¹å‡» Edit æŒ‰é’®ï¼Œåˆ‡æ¢èœå•æ˜¾ç¤º/éšè—
        editBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ° document
            dropdown.classList.toggle('open');
        });

        // ç‚¹å‡»é¡µé¢å…¶å®ƒåœ°æ–¹æ—¶è‡ªåŠ¨æ”¶èµ·èœå•
        document.addEventListener('click', () => {
            dropdown.classList.remove('open');
        });


    });

    function undoLastAdd() {
        if (undoStack.length === 0) {
            alert("No more undo");
            return;
        }

        const lastAction = undoStack.pop();
        redoStack.push(lastAction);

        switch (lastAction.action) {
            case 'add':
                // ä¿®æ”¹ï¼šä½¿ç”¨ _uniqueId æ¥ç²¾ç¡®æŸ¥æ‰¾å¹¶åˆ é™¤
                const indexToRemove = editedData.findIndex(d => d._uniqueId === lastAction.data._uniqueId);
                if (indexToRemove > -1) editedData.splice(indexToRemove, 1);
                break;

            case 'remove':
                editedData.push(...lastAction.data);
                break;

            case 'modify':
                // ä¿®æ”¹ï¼šä½¿ç”¨ _uniqueId æ¥æŸ¥æ‰¾è¦æ¢å¤çš„èŠ‚ç‚¹
                const nodeToRestore = editedData.find(d => d._uniqueId === lastAction.oldData._uniqueId);
                if (nodeToRestore) {
                    // ç”¨æ—§æ•°æ®è¦†ç›–å®ƒ
                    Object.assign(nodeToRestore, lastAction.oldData);
                }
                break;
        }

        // [æ–°å¢] åœ¨è¿™é‡Œè°ƒç”¨è®¡ç®—å‡½æ•°
        recalculateSubordinateCounts(editedData);

        initDateSlider();

        // å®Œå…¨é‡å»ºè§†å›¾
        const currentViewRoot = data_by_position.find(d => d.parentId === null);
        if (!currentViewRoot) return;

        const rootNodeForRemount = editedData.find(d => d.id === currentViewRoot.id);
        if (rootNodeForRemount) {
            buildAndDisplayChart(rootNodeForRemount);
        } else {
            const restoredRoot = lastAction.action === 'remove' ? lastAction.data.find(d => d.id === currentViewRoot.id) : null;
            if (restoredRoot) buildAndDisplayChart(restoredRoot);
        }
    }

    function redoLastAdd() {
        if (redoStack.length === 0) {
            alert("No more redo");
            return;
        }

        const actionToRedo = redoStack.pop();
        undoStack.push(actionToRedo);

        switch (actionToRedo.action) {
            case 'add':
                editedData.push(actionToRedo.data);
                break;

            case 'remove':
                // ä¿®æ”¹ï¼šåˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰å¾…åˆ é™¤é¡¹ _uniqueId çš„ Set
                const idsToRemove = new Set(actionToRedo.data.map(n => n._uniqueId));
                // ä¿®æ”¹ï¼šæ ¹æ® _uniqueId è¿›è¡Œè¿‡æ»¤ï¼Œç¡®ä¿åªåˆ é™¤æ­£ç¡®çš„è®°å½•
                editedData = editedData.filter(d => !idsToRemove.has(d._uniqueId));
                break;

            case 'modify':
                // ä¿®æ”¹ï¼šä½¿ç”¨ _uniqueId æ¥æŸ¥æ‰¾è¦æ›´æ–°çš„èŠ‚ç‚¹
                const nodeToUpdate = editedData.find(d => d._uniqueId === actionToRedo.newData._uniqueId);
                if (nodeToUpdate) {
                    // ç”¨æ–°æ•°æ®è¦†ç›–å®ƒ
                    Object.assign(nodeToUpdate, actionToRedo.newData);
                }
                break;
        }

        // [æ–°å¢] åœ¨è¿™é‡Œè°ƒç”¨è®¡ç®—å‡½æ•°
        recalculateSubordinateCounts(editedData);

        initDateSlider();

        // å®Œå…¨é‡å»ºè§†å›¾
        const currentViewRoot = data_by_position.find(d => d.parentId === null);
        if (!currentViewRoot) return;

        const rootNodeForRemount = editedData.find(d => d.id === currentViewRoot.id);
        if (rootNodeForRemount) {
            buildAndDisplayChart(rootNodeForRemount);
        } else {
            document.querySelector('.chart-container').innerHTML = '';
            alert("Root node removed");
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("searchInput").addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
                if (!uploadedData) {
                    alert('Please upload data');
                    return;
                }
                searchPerson(); // ç¡®ä¿æ­¤å‡½æ•°å·²å®šä¹‰
            }
        });
    });




    // è‡ªå®šä¹‰é€šçŸ¥å‡½æ•°ï¼ˆå¯é€‰ï¼Œå¦‚éœ€ä¿ç•™åŸç”Ÿalertå¯åˆ é™¤ï¼‰
    function showNotification(message, type = 'info') {
        // å®ç°ä¸ä¹‹å‰ç›¸åŒ...
    }
    //æ§åˆ¶æ”¶ç¼©ä¸å±•å¼€
    function toggleContainer() {
        const container = document.getElementById('collapsibleContainer');
        const button = document.querySelector('button[onclick="toggleContainer()"]');

        // é€šè¿‡åˆ‡æ¢ class æ¥æ§åˆ¶çŠ¶æ€
        const isCollapsed = container.classList.toggle('collapsed');

        if (isCollapsed) {
            button.textContent = "â–¼ Expand";
        } else {
            button.textContent = "â–²";
        }
    }

    function formatDate(date) {
        return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
    }

    // æ›¿æ¢æ—§çš„ initDateSlider å‡½æ•°
    function initDateSlider() {
        // æ³¨æ„ï¼šç°åœ¨æˆ‘ä»¬ä» editedData (å®Œæ•´æ•°æ®æº) ä¸­æå–æ—¥æœŸ
        if (!editedData || editedData.length === 0) {
            console.error('No data available for date slider');
            return;
        }

        const today = new Date();
        const todayFormatted = formatDate(today);
        const toDate = (dateStr) => new Date(dateStr.replace(/\//g, '-'));

        // ä» editedData æå–æ‰€æœ‰ä¸é‡å¤çš„æœªæ¥æ—¥æœŸ
        const futureDates = [...new Set(
            editedData
                .map(item => item.Effective_Date ? item.Effective_Date.split(' ')[0] : null)
                .filter(date => date && toDate(date) > toDate(todayFormatted))
        )];

        // å°†ä»Šå¤©å’Œæœªæ¥æ—¥æœŸåˆå¹¶å¹¶æ’åº
        dateValues = [todayFormatted, ...futureDates].sort((a, b) => toDate(a) - toDate(b));

        const slider = document.getElementById('dateRange');
        const output = document.getElementById('dateValue');

        slider.min = 0;
        slider.max = dateValues.length - 1;
        slider.value = 0; // é»˜è®¤å€¼è®¾ä¸ºä»Šå¤©

        updateDateDisplay(slider.value, true); // é¦–æ¬¡åŠ è½½ä¸é‡ç»˜å›¾è¡¨

        // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®š
        const newSlider = slider.cloneNode(true);
        slider.parentNode.replaceChild(newSlider, slider);

        // ç›‘å¬æ»‘å—å˜åŒ–ï¼Œè§¦å‘å®Œæ•´çš„å›¾è¡¨é‡ç»˜
        newSlider.addEventListener('input', function () {
            updateDateDisplay(this.value, false); // æ»‘åŠ¨æ—¶éœ€è¦é‡ç»˜
        });

        // å¦‚æœæ²¡æœ‰æœªæ¥æ—¥æœŸï¼Œåˆ™ç¦ç”¨æ»‘å—
        if (dateValues.length <= 1) {
            newSlider.disabled = false;
            output.style.color = '#fff';
            output.title = 'No future data available';
        } else {
            newSlider.disabled = false;
            output.style.color = '#fff';
            output.title = '';
        }
    }

    // æ›¿æ¢æ—§çš„ updateDateDisplay å‡½æ•°
    function updateDateDisplay(index, isInitialLoad = false) {
        const output = document.getElementById('dateValue');
        const selectedDate = dateValues[index];

        if (selectedDate) {
            output.textContent = selectedDate;

            // å¦‚æœä¸æ˜¯é¦–æ¬¡åŠ è½½ï¼Œåˆ™é‡ç»˜å›¾è¡¨
            if (!isInitialLoad) {
                // æ‰¾åˆ°å½“å‰è§†å›¾çš„æ ¹èŠ‚ç‚¹ï¼Œç„¶åç”¨æ–°æ—¥æœŸé‡ç»˜
                const currentViewRoot = data_by_position.find(d => d.parentId === null);
                if (currentViewRoot) {
                    const rootNodeForRemount = editedData.find(d => d.id === currentViewRoot.id);
                    if (rootNodeForRemount) {
                        buildAndDisplayChart(rootNodeForRemount);
                    }
                }
            }
        }
    }

    // è¯·åˆ é™¤æ—§çš„ filterDataByDate å‡½æ•°ï¼Œå®ƒä¸å†è¢«éœ€è¦ã€‚


    function printChart() {
        const chartContainer = document.querySelector('.chart-container');

        if (!chartContainer) {
            alert("No contentï¼");
            return;
        }

        // æ‰“å¼€æµè§ˆå™¨çš„æ‰“å°å¯¹è¯æ¡†
        window.print();
    }


    /*
      function toggleCompact() {
        if (!chart) return;          // chart è¿˜æ²¡åˆå§‹åŒ–å°±ç›´æ¥è¿”å›
    
        const nowCompact = chart.compact();     // è¯»å–å½“å‰çŠ¶æ€
        chart.compact(!nowCompact).render();    // åˆ‡æ¢å¹¶é‡æ–°æ¸²æŸ“
    
        // æ”¹ä¸€ä¸‹æŒ‰é’®æ–‡å­—ï¼ˆå¯é€‰ï¼‰
        const btn = document.getElementById('swapLayoutBtn');
        btn.textContent = nowCompact ? 'Vertical' : 'Horizontal';
      }*/

    function exportEditedDataCsv() {
        if (!Array.isArray(editedData) || !editedData.length) {
            alert('No data'); return;
        }
        // è¿‡æ»¤æ‰è™šæ‹Ÿå­èŠ‚ç‚¹
        const rows = editedData.filter(r => !r.isVirtual);

        if (!rows.length) { alert('No data'); return; }

        // å¯é€‰ï¼šæŒ‡å®šåˆ—é¡ºåºï¼›ä¸æŒ‡å®šåˆ™ d3 ä¼šæŒ‰å¯¹è±¡ key é¡ºåºå¯¼å‡º
        const columns = [
            "Position_Number", "Reports_To_Position_Number", "Display_Name", "Position_Descr",
            "Department_Descr_Short", "Position_Band", "Salary_Grade", "FTE_Type_Funding_Status",
            "Cost_Center", "Risk_Assessment", "Mark_in_OrgChart", "Remark_2", "Remark_3",
            "Effective_Date", "id", "parentId", "Span_of_Control", "Direct_Report", "Staffs"
        ].filter(c => rows.some(r => Object.prototype.hasOwnProperty.call(r, c)));

        const csv = d3.csvFormat(rows, columns); // â† å®˜æ–¹æ ¼å¼åŒ–å‡½æ•°ï¼ˆd3-dsvï¼‰

        const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `editedData-${new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-')}.csv`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    /**
   * é€’å½’è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—ä¸€ä¸ªèŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰åä»£ï¼ˆç›´æ¥+é—´æ¥ï¼‰æ€»æ•°
   * @param {string} parentId - è¦è®¡ç®—çš„çˆ¶èŠ‚ç‚¹çš„ ID
   * @param {Array} dataArray - å®Œæ•´çš„æ•°æ®æºæ•°ç»„ (editedData)
   * @returns {number} - åä»£æ€»æ•°
   */
    function countAllDescendants(parentId, dataArray) {
        // æ‰¾åˆ°æ‰€æœ‰ç›´æ¥å­èŠ‚ç‚¹ (éè™šæ‹ŸèŠ‚ç‚¹)
        const directChildren = dataArray.filter(d => !d.isVirtual && d.parentId === parentId);
        let count = directChildren.length;
        // å¯¹æ¯ä¸ªå­èŠ‚ç‚¹ï¼Œé€’å½’åœ°åŠ ä¸Šå®ƒè‡ªå·±çš„åä»£æ•°é‡
        for (const child of directChildren) {
            count += countAllDescendants(child.id, dataArray);
        }
        return count;
    }

    /**
     * ä¸»å‡½æ•°ï¼šä¸ºæ•´ä¸ªæ•°æ®é›†é‡æ–°è®¡ç®— Direct_Report, Staffs å’Œ Span_of_Control æ•°é‡
     * è¿™ä¸ªå‡½æ•°ä¼šç›´æ¥ä¿®æ”¹ä¼ å…¥æ•°ç»„ä¸­å¯¹è±¡çš„å±æ€§
     * @param {Array} dataArray - å®Œæ•´çš„æ•°æ®æºæ•°ç»„ (editedData)
     */
    function recalculateSubordinateCounts(dataArray) {
        // --- ç¬¬ä¸€éƒ¨åˆ†ï¼šè®¡ç®— Direct_Report å’Œ Staffs ---
        const directReportMap = new Map();
        dataArray.forEach(d => {
            // è¿‡æ»¤æ‰è™šæ‹ŸèŠ‚ç‚¹ï¼Œå®ƒä»¬ä¸åº”è¢«è®¡å…¥
            if (d.isVirtual) return;
            if (d.parentId) {
                directReportMap.set(d.parentId, (directReportMap.get(d.parentId) || 0) + 1);
            }
        });

        dataArray.forEach(person => {
            if (person.isVirtual) return;
            const personId = person.id;
            person.Direct_Report = directReportMap.get(personId) || 0;

            // [ä¿®æ”¹ç‚¹ 1] å­—æ®µåä» _totalSubordinates æ”¹ä¸º Staffs
            person.Staffs = countAllDescendants(personId, dataArray);
        });

        // --- ç¬¬äºŒéƒ¨åˆ†ï¼šæ ¹æ®æ‚¨çš„ç‰¹æ®Šé€»è¾‘è®¡ç®— Span_of_Control ---
        dataArray.forEach(person => {
            if (person.isVirtual) return;

            const applicableBands = ['B', '1', '2', '3', '4'];

            // [ä¿®æ”¹ç‚¹ 2] åº”ç”¨æ–°çš„è®¡ç®—é€»è¾‘
            // åˆ¤æ–­å½“å‰èŠ‚ç‚¹çš„ Position_Band æ˜¯å¦åœ¨éœ€è¦ç‰¹æ®Šè®¡ç®—çš„èŒƒå›´å†…
            if (applicableBands.includes(person.Position_Band)) {
                let sumOfALStaffs = 0;
                // æ‰¾åˆ°æ‰€æœ‰ Position_Band ä¸º 'AL' çš„ç›´æ¥å­èŠ‚ç‚¹
                const directALChildren = dataArray.filter(d =>
                    !d.isVirtual && d.parentId === person.id && d.Position_Band === 'AL'
                );

                // ç´¯åŠ è¿™äº› 'AL' å­èŠ‚ç‚¹çš„ Staffs æ•°é‡
                directALChildren.forEach(child => {
                    // ä½¿ç”¨åœ¨ç¬¬ä¸€éƒ¨åˆ†ä¸­å·²ç»ä¸ºæ¯ä¸ªèŠ‚ç‚¹è®¡ç®—å¥½çš„ Staffs å€¼
                    sumOfALStaffs += (child.Staffs || 0);
                });

                // æœ€ç»ˆç»“æœæ˜¯ AL å­èŠ‚ç‚¹ Staffs æ€»å’Œ + çˆ¶èŠ‚ç‚¹è‡ªèº«çš„ç›´æ¥ä¸‹å±æ•°é‡
                person.Span_of_Control = sumOfALStaffs + person.Direct_Report;
            } else {
                // å¯¹äºå…¶ä»– Position_Band (ä¾‹å¦‚ 'AL' èŠ‚ç‚¹è‡ªèº«)ï¼ŒSpan_of_Control ç­‰äº Direct_Report
                person.Span_of_Control = 0;
            }
        });
    }
    /*
    // è°ƒæ·¡è™šæ‹Ÿå­èŠ‚ç‚¹çš„å±•å¼€/æ”¶å›æŒ‰é’®æ ·å¼
    function restyleVirtualNodeButtons() {
      const LIGHT = '#ffffff';        // æµ…ç°è‰²
      const OPACITY = 1;           // é€æ˜åº¦
      const THIN = '1';               // æ›´ç»†çš„çº¿å®½
  
      // d3-org-chart æ¯ä¸ªèŠ‚ç‚¹æ˜¯ .node åˆ†ç»„ï¼ŒæŒ‰é’®åœ¨å…¶ä¸­çš„ .node-button-div
      d3.selectAll('.node').each(function (d) {
        const isVirtual = d && d.data && d.data.isVirtual;
        const btnDiv = d3.select(this).select('.node-button-div');
        if (btnDiv.empty()) return;
  
        const btnSvg = btnDiv.select('svg');
  
        if (isVirtual) {
          // èƒŒæ™¯ä¸æ•´ä½“é€æ˜åº¦æ›´æ·¡
          btnDiv.style('background', 'transparent')
            .style('opacity', OPACITY);
  
          // è¦†ç›–å›¾æ ‡é¢œè‰²ï¼ˆéœ€è¦ important æ‰èƒ½å‹è¿‡å…¨å±€ !importantï¼‰
          btnSvg.style('opacity', OPACITY);
          btnSvg.selectAll('*').each(function () {
            this.style.setProperty('stroke', LIGHT, 'important');
            this.style.setProperty('fill', LIGHT, 'important');
            this.style.setProperty('stroke-width', THIN, 'important');
          });
        } else {
          // éè™šæ‹ŸèŠ‚ç‚¹æ¢å¤é»˜è®¤ï¼ˆç§»é™¤è¦†ç›–ï¼Œäº¤ç”±å…¨å±€ CSS æ§åˆ¶ï¼‰
          btnDiv.style('background', null)
            .style('opacity', null);
          btnSvg.style('opacity', null);
          btnSvg.selectAll('*').each(function () {
            this.style.removeProperty('stroke');
            this.style.removeProperty('fill');
            this.style.removeProperty('stroke-width');
          });
        }
      });
    }*/

    /**
   * æ ¹æ®é€‰å®šæ—¥æœŸï¼Œä»ä¸»æ•°æ®æº(editedData)ç”Ÿæˆç”¨äºå›¾è¡¨å±•ç¤ºçš„å¹²å‡€æ•°æ®ã€‚
   * @param {string} selectedDate - YYYY/MM/DD æ ¼å¼çš„æ—¥æœŸå­—ç¬¦ä¸².
   * @returns {Array} - ç»è¿‡ç­›é€‰å’Œå»é‡åçš„æ•°æ®æ•°ç»„ï¼Œå¯ç›´æ¥ç”¨äºæ¸²æŸ“.
   */
    function getViewDataForDate(selectedDate) {
        if (!editedData || editedData.length === 0) {
            return [];
        }

        const selectedDateObj = new Date(selectedDate.replace(/\//g, '-'));

        // 1. ç­›é€‰å‡ºæ‰€æœ‰ç”Ÿæ•ˆæ—¥æœŸæ—©äºæˆ–ç­‰äºé€‰å®šæ—¥æœŸçš„æ•°æ®
        const historicallyValidData = editedData.filter(item => {
            if (!item.Effective_Date || item.isVirtual) { // å¿½ç•¥è™šæ‹ŸèŠ‚ç‚¹å’Œæ— æ•ˆæ—¥æœŸ
                return item.isVirtual; // è™šæ‹ŸèŠ‚ç‚¹ç›´æ¥é€šè¿‡
            }
            const itemDateObj = new Date(item.Effective_Date.split(' ')[0].replace(/\//g, '-'));
            return itemDateObj <= selectedDateObj;
        });

        // 2. å¤„ç†é‡å¤çš„ Position_Numberï¼Œåªä¿ç•™æœ€æ–°çš„è®°å½•
        const uniquePositions = new Map();
        historicallyValidData.forEach(item => {
            // è™šæ‹ŸèŠ‚ç‚¹æ²¡æœ‰Position_Number, ç›´æ¥è·³è¿‡
            if (item.isVirtual) return;

            const existing = uniquePositions.get(item.Position_Number);
            if (!existing) {
                uniquePositions.set(item.Position_Number, item);
            } else {
                const existingDate = new Date(existing.Effective_Date.split(' ')[0].replace(/\//g, '-'));
                const itemDate = new Date(item.Effective_Date.split(' ')[0].replace(/\//g, '-'));
                // å¦‚æœå½“å‰é¡¹çš„æ—¥æœŸæ¯”å·²å­˜é¡¹çš„æ—¥æœŸæ›´æ–°ï¼Œåˆ™æ›¿æ¢å®ƒ
                if (itemDate > existingDate) {
                    uniquePositions.set(item.Position_Number, item);
                }
            }
        });

        // 3. å°†è™šæ‹ŸèŠ‚ç‚¹é‡æ–°åŠ å›æ¥ (å¦‚æœå®ƒä»¬å­˜åœ¨äºç­›é€‰åçš„æ•°æ®ä¸­)
        const virtualNodes = historicallyValidData.filter(item => item.isVirtual);

        // è¿”å›å»é‡åçš„å”¯ä¸€èŒä½æ•°æ®æ•°ç»„ï¼Œå¹¶åˆå¹¶è™šæ‹ŸèŠ‚ç‚¹
        return [...uniquePositions.values(), ...virtualNodes];
    }

    /**
   * å½“æ‰¾åˆ°å¤šä¸ªåŒ¹é…è®°å½•æ—¶ï¼Œå¼¹å‡ºä¸€ä¸ªæ¨¡æ€æ¡†è®©ç”¨æˆ·é€‰æ‹©ã€‚
   * @param {Array} records - æ‰¾åˆ°çš„å¤šä¸ªåŒ¹é…è®°å½•æ•°ç»„.
   * @param {function} onSelectCallback - ç”¨æˆ·é€‰æ‹©ä¸€ä¸ªè®°å½•åè¦æ‰§è¡Œçš„å›è°ƒå‡½æ•°. è¿™ä¸ªå‡½æ•°ä¼šæ¥æ”¶è¢«é€‰ä¸­çš„è®°å½•å¯¹è±¡ä½œä¸ºå‚æ•°.
   */
    function promptUserToSelectRecord(records, onSelectCallback) {
        const modal = document.getElementById('selectionModal');
        const choicesContainer = document.getElementById('selectionChoices');
        const modalTitle = document.getElementById('selectionModalTitle');

        // 1. è®¾ç½®æ ‡é¢˜å¹¶æ¸…ç©ºæ—§é€‰é¡¹
        modalTitle.textContent = 'Found multiple records. Please choose one:';
        choicesContainer.innerHTML = '';

        // 2. åŠ¨æ€åˆ›å»ºæ–°é€‰é¡¹ï¼Œè¿™æ¬¡è¦åŒ…å« Effective_Date
        records.forEach(person => {
            const choiceElement = document.createElement('div');
            choiceElement.className = 'selection-choice';
            // ä½¿ç”¨ä¸€ä¸ªå”¯ä¸€çš„ç»„åˆé”®ï¼ˆå¦‚ ID + Dateï¼‰æˆ–ç›´æ¥ç”¨ç´¢å¼•æ¥æŸ¥æ‰¾
            choiceElement.dataset.id = person.Position_Number;
            choiceElement.dataset.date = person.Effective_Date; // å­˜å‚¨æ—¥æœŸç”¨äºç²¾ç¡®æŸ¥æ‰¾

            // åœ¨æ˜¾ç¤ºå†…å®¹ä¸­åŠ å…¥ç”Ÿæ•ˆæ—¥æœŸ
            choiceElement.innerHTML = `
      <h4>${person.Display_Name} (ID: ${person.Position_Number})</h4>
      <p><strong>Effective Date: ${person.Effective_Date.split(' ')[0]}</strong></p> <p>${person.Position_Descr}</p>
    `;

            // 3. ä¸ºæ¯ä¸ªé€‰é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
            choiceElement.addEventListener('click', () => {
                // ç²¾ç¡®æ‰¾åˆ°ç”¨æˆ·ç‚¹å‡»çš„é‚£æ¡è®°å½•
                const selectedPerson = records.find(d =>
                    d.Position_Number === choiceElement.dataset.id &&
                    d.Effective_Date === choiceElement.dataset.date
                );

                if (selectedPerson) {
                    // æ‰§è¡Œä¼ å…¥çš„å›è°ƒå‡½æ•°ï¼ŒæŠŠé€‰ä¸­çš„è®°å½•ä¼ ç»™å®ƒ
                    onSelectCallback(selectedPerson);
                }
                modal.style.display = 'none'; // å…³é—­æ¨¡æ€æ¡†
            });

            choicesContainer.appendChild(choiceElement);
        });

        // 4. æ˜¾ç¤ºæ¨¡æ€æ¡†
        modal.style.display = 'flex';
    }


</script>

<body>
    <div class="bg-shapes">
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
    </div>

    <!-- SINGLE NAVIGATION HEADER -->
    <header>
        <div class="container">
            <nav class="glass">
                <div class="logo" onclick="showPage('home')">
                    <div class="logo-icon">
                        <img src="images/ORG.png" alt="Org Vision logo" style="width:75px;height:auto;display:block;">
                    </div>
                    <span style="color:#1a9fe2">ORG VISION CANVAS</span>
                </div>
                <div class="nav-links">
                    <a href="#" onclick="showPage('home')" class="active">Home</a>
                    <a href="#" onclick="showPage('Canvas')">Canvas</a>
                    <a href="#" onclick="showPage('services')">Services</a>
                    <a href="#" onclick="showPage('contact')">Contact</a>
                </div>
            </nav>
        </div>
    </header>

    <!-- HOME PAGE -->
    <div id="home" class="page active">
        <div class="container">
            <div class="content-wrapper">
                <section class="hero glass">
                    <div class="hero-image">
                        <img src="images/templatemo-futuristic-girl.jpg" alt="Modern Technology Interaction" />
                    </div>
                    <div class="hero-content">
                        <h1>Welcome to ORG VISION Canvas</h1>
                        <p>Experience cutting-edge glass morphism design that brings depth and elegance to modern web
                            interfaces. Clean, translucent, and beautifully interactive.</p>
                        <button onclick="document.getElementById('fileInput').click()" class="cta-button">
                            Upload CSV File
                        </button>
                    </div>

                </section>

                <section class="features">
                    <div class="feature-card glass">
                        <div class="feature-icon">âœ¨</div>
                        <h3>Modern Design</h3>
                        <p>Beautiful glass morphism effects with backdrop blur and translucent elements that create
                            depth and visual hierarchy.</p>
                    </div>

                    <div class="feature-card glass">
                        <div class="feature-icon">âš¡</div>
                        <h3>Fast Performance</h3>
                        <p>Optimized animations and effects that maintain smooth 60fps performance across all modern
                            browsers and devices.</p>
                    </div>

                    <div class="feature-card glass">
                        <div class="feature-icon">ğŸ“±</div>
                        <h3>Responsive</h3>
                        <p>Fully responsive design that adapts beautifully to any screen size, from mobile phones to
                            desktop displays.</p>
                    </div>

                    <div class="feature-card glass">
                        <div class="feature-icon">ğŸ¨</div>
                        <h3>Interactive UI</h3>
                        <p>Engaging hover effects, smooth transitions, and micro-animations that create delightful user
                            experiences.</p>
                    </div>

                    <div class="feature-card glass">
                        <div class="feature-icon">ğŸ”’</div>
                        <h3>Secure & Safe</h3>
                        <p>Built with modern security standards and best practices to ensure your data and user privacy
                            are protected.</p>
                    </div>

                    <div class="feature-card glass">
                        <div class="feature-icon">ğŸš€</div>
                        <h3>Easy Integration</h3>
                        <p>Simple to implement and customize for any project with clean, well-documented code and
                            flexible components.</p>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Canvas PAGE -->
    <div id="Canvas" class="page">

        <script src="./libs/d3.min.js"></script>
        <script src="./libs/d3-flextree.min.js"></script>
        <script src="./libs/d3-org-chart.min.js"></script>
        <script src="https://unpkg.com/html2canvas@1.1.4/dist/html2canvas.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>


        <div class="toolbar">


            <!-- â–¼ æ–°å¢ï¼šCollect Collapse æŒ‰é’® -->
            <!--<button id="swapLayoutBtn" onclick="toggleCompact()" class="btn btn-secondary">Horizontal</button>-->

            <!--
            <div class="toolbar-controls">
                <button onclick="toggleContainer()" class="cta-button">â–²</button>-->

            <button onclick="document.getElementById('fileInput').click()" class="cta-button">
                Upload
            </button>

            <input type="file" id="fileInput" accept=".csv" style="display: none" onchange="handleFileUpload(event)" />

            <input id="searchInput" type="text" placeholder="Name or Position Number" class="cta-SearchInput">
            <style>
                /* ä¸´æ—¶è¦†ç›–ï¼Œä»…ä½œç”¨äºå¸¦ id çš„è¿™ä¸ªè¾“å…¥æ¡† */
                #searchInput::placeholder {
                    color: #ffffff;
                    opacity: 1;
                }
            </style>


            <button onclick="searchPerson()" class="cta-button">
                Create
            </button>
            <div style="flex: 1;"></div>
            <button id="collapseToOneLevelBtn" onclick="collapseToOneLevel()" class="cta-button">Collapse All</button>

            <div class="cta-button">
                <label for="dateRange">Future Date:</label>
                <input type="range" id="dateRange" min="0" max="1000" value="500">
                <output id="dateValue">No Data</output>
            </div>
            <button onclick="chart.fit()" class="cta-button">Auto Layout</button>
            <div style="flex: 1;"></div>


            <div class="dropdown">
                <button id="editBtn" class="cta-button">Edit â–¼</button>
                <div id="editMenu" class="dropdown-content">
                    <button id="addDataBtn" class="cta-button">Add New</button>
                    <button id="removeDataBtn" class="cta-button">Remove</button>
                    <button id="modifyDataBtn" class="cta-button">Modify</button>
                    <button id="undoAddBtn" class="cta-button">Undo</button>
                    <button id="redoAddBtn" class="cta-button">Redo</button>
                </div>
            </div>
            <button id="exportCsvBtn" class="cta-button">Export Data</button>



            <button onclick="printChart()" class="cta-button">Print</button>


        </div>

        <div id="addDataModal" class="modal ">
            <div class="modal-content">
                <h3>Add Person</h3>
                <div class="form-group"><label for="new_Position_Number">Position Number</label><input
                        id="new_Position_Number" type="text" placeholder="e.g.,CND00003"></div>
                <div class="form-group"><label for="new_Effective_Date">Effective Date</label><input
                        id="new_Effective_Date" type="text" placeholder="e.g.,YYYY-MM-DD"></div>
                <div class="form-group"><label for="new_Reports_To_Position_Number">Supervisor Position
                        Number</label><input id="new_Reports_To_Position_Number" type="text"
                        placeholder="e.g., CND00001">
                </div>
                <div class="form-group"><label for="new_Display_Name">Name</label><input id="new_Display_Name"
                        type="text" placeholder="e.g., Tom"></div>
                <div class="form-group"><label for="new_Position_Band">Position Band</label><input
                        id="new_Position_Band" type="text" placeholder="e.g., PB3"></div>
                <div class="form-group"><label for="new_Salary_Grade">Salary Grade</label><input id="new_Salary_Grade"
                        type="text" placeholder="e.g., PG5"></div>
                <div class="form-group"><label for="new_Department_Descr_Short">Company</label><input
                        id="new_Department_Descr_Short" type="text" placeholder="e.g., BMBS"></div>
                <div class="form-group"><label for="new_Position_Descr">Position Descr</label><input
                        id="new_Position_Descr" type="text" placeholder="e.g., President"></div>
                <div class="form-group"><label for="new_Cost_Center">Cost Center</label><input id="new_Cost_Center"
                        type="text" placeholder="e.g., 10900771"></div>
                <div class="form-group"><label for="new_FTE_Type_Funding_Status">Funding</label><input
                        id="new_FTE_Type_Funding_Status" type="text" placeholder="e.g., BMBS"></div>
                <div class="form-group"><label for="new_Risk_Assessment">Risk</label><input id="new_Risk_Assessment"
                        type="text" placeholder="e.g., Compulsory"></div>
                <div class="form-group"><label for="new_Mark_in_OrgChart">Remark</label><input id="new_Mark_in_OrgChart"
                        type="text" placeholder="e.g.,New"></div>
                <div class="form-group"><label for="new_Remark_2">Remark 2</label><input id="new_Remark_2" type="text">
                </div>
                <div class="form-group"><label for="new_Remark_3">Remark 3</label><input id="new_Remark_3" type="text">
                </div>

                <div class="modal-buttons">
                    <button id="cancelAddData" class="cta-button">Cancel</button>
                    <button id="confirmAddData" class="cta-button">Confirm</button>
                </div>
            </div>
        </div>

        <div id="modifyDataModal" class="modal">
            <div class="modal-content">
                <h3>Modify Person</h3>
                <div class="form-group"><label for="modify_Position_Number">Position Number</label><input
                        id="modify_Position_Number" type="text" readonly style="background-color: #555;"></div>
                <div class="form-group"><label for="modify_Effective_Date">Effective Date</label><input
                        id="modify_Effective_Date" type="text" placeholder="e.g.,YYYY-MM-DD"></div>
                <div class="form-group"><label for="modify_Reports_To_Position_Number">Supervisor Position
                        Number</label><input id="modify_Reports_To_Position_Number" type="text"
                        placeholder="e.g.,CND00001">
                </div>
                <div class="form-group"><label for="modify_Display_Name">Name</label><input id="modify_Display_Name"
                        type="text" placeholder="e.g.,Tom"></div>
                <div class="form-group"><label for="modify_Position_Band">Position Band</label><input
                        id="modify_Position_Band" type="text" placeholder="e.g.,PB3"></div>
                <div class="form-group"><label for="modify_Salary_Grade">Salary Grade</label><input
                        id="modify_Salary_Grade" type="text" placeholder="e.g.,PG5"></div>
                <div class="form-group"><label for="modify_Department_Descr_Short">Company</label><input
                        id="modify_Department_Descr_Short" type="text" placeholder="e.g., BMBS"></div>
                <div class="form-group"><label for="modify_Position_Descr">Position Descr</label><input
                        id="modify_Position_Descr" type="text" placeholder="e.g., President"></div>
                <div class="form-group"><label for="modify_Cost_Center">Cost Center</label><input
                        id="modify_Cost_Center" type="text" placeholder="e.g., 10900771"></div>
                <div class="form-group"><label for="modify_FTE_Type_Funding_Status">Funding</label><input
                        id="modify_FTE_Type_Funding_Status" type="text" placeholder="e.g., BMBS"></div>
                <div class="form-group"><label for="modify_Risk_Assessment">Risk</label><input
                        id="modify_Risk_Assessment" type="text" placeholder="e.g., Compulsory"></div>
                <div class="form-group"><label for="modify_Mark_in_OrgChart">Remark</label><input
                        id="modify_Mark_in_OrgChart" type="text" placeholder="New"></div>
                <div class="form-group"><label for="modify_Remark_2">Remark_2</label><input id="modify_Remark_2"
                        type="text">
                </div>
                <div class="form-group"><label for="modify_Remark_3">Remark_3</label><input id="modify_Remark_3"
                        type="text">
                </div>

                <div class="modal-buttons">
                    <button id="cancelModifyData" class="cta-button">Cancel</button>
                    <button id="confirmModifyData" class="cta-button">Confirm</button>
                </div>
            </div>
        </div>

        <div id="selectionModal" class="modal">
            <div class="modal-content">
                <h3 id="selectionModalTitle">Please Chooseï¼š</h3>
                <div id="selectionChoices">
                </div>
                <div class="modal-buttons" style="margin-top: 20px;">
                    <button id="cancelSelection" class="btn btn-dark">Cancel</button>
                </div>
            </div>
        </div>

        <div class="chart-container"></div>
    </div>





    </div>

    <!-- SERVICES PAGE -->
    <div id="services" class="page">
        <div class="container">
            <div class="content-wrapper">
                <section class="hero glass">
                    <h1>Our Services</h1>
                    <p>Comprehensive design and development solutions tailored to your needs</p>
                </section>

                <section class="services-grid">
                    <div class="service-card glass">
                        <div class="service-header">
                            <div class="service-icon">ğŸ¨</div>
                            <h3>UI/UX Design</h3>
                        </div>
                        <p>Create stunning user interfaces with modern design principles, focusing on usability and
                            aesthetic appeal.</p>
                        <ul class="service-features">
                            <li>User Research & Analysis</li>
                            <li>Wireframing & Prototyping</li>
                            <li>Visual Design & Branding</li>
                            <li>Responsive Design</li>
                        </ul>
                    </div>

                    <div class="service-card glass">
                        <div class="service-header">
                            <div class="service-icon">ğŸ’»</div>
                            <h3>Web Development</h3>
                        </div>
                        <p>Build fast, secure, and scalable websites using the latest web technologies and best
                            practices.</p>
                        <ul class="service-features">
                            <li>Frontend Development</li>
                            <li>Backend Integration</li>
                            <li>Performance Optimization</li>
                            <li>SEO Implementation</li>
                        </ul>
                    </div>

                    <div class="service-card glass">
                        <div class="service-header">
                            <div class="service-icon">ğŸ“±</div>
                            <h3>Mobile Apps</h3>
                        </div>
                        <p>Develop native and cross-platform mobile applications that deliver exceptional user
                            experiences.</p>
                        <ul class="service-features">
                            <li>iOS & Android Development</li>
                            <li>Cross-platform Solutions</li>
                            <li>App Store Optimization</li>
                            <li>Maintenance & Updates</li>
                        </ul>
                    </div>

                    <div class="service-card glass">
                        <div class="service-header">
                            <div class="service-icon">ğŸš€</div>
                            <h3>Digital Strategy</h3>
                        </div>
                        <p>Strategic consulting to help your business thrive in the digital landscape with data-driven
                            insights.</p>
                        <ul class="service-features">
                            <li>Digital Transformation</li>
                            <li>Analytics & Reporting</li>
                            <li>Growth Strategy</li>
                            <li>Technology Consulting</li>
                        </ul>
                    </div>

                    <div class="service-card glass">
                        <div class="service-header">
                            <div class="service-icon">â˜ï¸</div>
                            <h3>Cloud Solutions</h3>
                        </div>
                        <p>Modernize your infrastructure with scalable cloud services and seamless migration strategies.
                        </p>
                        <ul class="service-features">
                            <li>Cloud Migration</li>
                            <li>DevOps & Automation</li>
                            <li>Infrastructure as Code</li>
                            <li>24/7 Monitoring</li>
                        </ul>
                    </div>

                    <div class="service-card glass">
                        <div class="service-header">
                            <div class="service-icon">ğŸ”</div>
                            <h3>Cybersecurity</h3>
                        </div>
                        <p>Protect your digital assets with comprehensive security solutions and threat protection.</p>
                        <ul class="service-features">
                            <li>Security Auditing</li>
                            <li>Penetration Testing</li>
                            <li>Data Protection</li>
                            <li>Compliance Management</li>
                        </ul>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- CONTACT PAGE -->
    <div id="contact" class="page">
        <div class="container">
            <div class="content-wrapper">
                <section class="contact-grid">
                    <div class="contact-form glass">
                        <h2>Get In Touch</h2>
                        <form>
                            <div class="form-group">
                                <label for="name">Full Name</label>
                                <input type="text" id="name" name="name" placeholder="Enter your full name" required>
                            </div>
                            <div class="form-group">
                                <label for="email">Email Address</label>
                                <input type="email" id="email" name="email" placeholder="Enter your email" required>
                            </div>
                            <div class="form-group">
                                <label for="subject">Subject</label>
                                <input type="text" id="subject" name="subject" placeholder="What's this about?">
                            </div>
                            <div class="form-group">
                                <label for="message">Message</label>
                                <textarea id="message" name="message" placeholder="Tell us about your project..."
                                    required></textarea>
                            </div>
                            <button type="submit" class="cta-button">Send Message</button>
                        </form>
                    </div>

                    <div class="contact-info glass">
                        <h2>Contact Information</h2>

                        <div class="contact-item">
                            <div class="contact-item-icon">ğŸ“§</div>
                            <div class="contact-item-text">
                                <h4>Email</h4>
                                <p>hello@glossytouch.com</p>
                            </div>
                        </div>

                        <div class="contact-item">
                            <div class="contact-item-icon">ğŸ“</div>
                            <div class="contact-item-text">
                                <h4>Phone</h4>
                                <p>+1 (555) 123-4567</p>
                            </div>
                        </div>

                        <div class="contact-item">
                            <div class="contact-item-icon">ğŸ“</div>
                            <div class="contact-item-text">
                                <h4>Address</h4>
                                <p>123 Design Street<br>Creative District, CD 12345</p>
                            </div>
                        </div>

                        <div class="contact-item">
                            <div class="contact-item-icon">ğŸ•’</div>
                            <div class="contact-item-text">
                                <h4>Business Hours</h4>
                                <p>Mon-Fri: 9AM-6PM<br>Sat-Sun: 10AM-4PM</p>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="contact-map-section">
                    <div class="contact-map glass">
                        <h2>Find Us</h2>
                        <div class="map-container">
                            <div class="map-placeholder">
                                <div class="map-placeholder-icon">ğŸ—ºï¸</div>
                                <p><strong>Interactive Map Area</strong></p>
                                <p>123 Design Street</p>
                                <p>Creative District, CD 12345</p>
                                <p style="margin-top: 15px; font-size: 12px; opacity: 0.7;">
                                    Map integration can be added with<br>
                                    Google Maps, OpenStreetMap, or Mapbox
                                </p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>


    <script src="templatemo-glossy-touch.js"></script>
</body>

</html>
