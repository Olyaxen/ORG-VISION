<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORG VISION CANVAS</title>

    <link rel="stylesheet" href="templatemo-glossy-touch.css">
    <!--

TemplateMo 592 glossy touch

https://templatemo.com/tm-592-glossy-touch

-->
    <meta charset="UTF-8" />
    <style>
        /* --- 1. 全局与基础样式 --- */
        #canvas {
            /* 定义颜色变量，方便统一修改 */
            --primary-color: #ffffff;
            --primary-gradient: linear-gradient(135deg, #00ffff, #0066ff);
            --secondary-gradient: linear-gradient(135deg, #ff00cc, #6600ff);
            --dark-bg: #000;
            --panel-bg: #0a0a0a;
            --input-bg: #111;
            --text-color: #fff;
            --text-color-light: #ffffff;
            --border-color: #333;
            --shadow-color-primary: rgba(0, 255, 255, 0.5);
            --shadow-color-secondary: rgba(255, 0, 204, 0.5);
        }

        body,
        html {
            background-color: var(--dark-bg);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        * {
            box-sizing: border-box;
        }

        /* --- 2. 布局容器 --- */
        .main-container {
            background-color: var(--dark-bg);
            padding: 0;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.1);
            width: 100%;
            margin: 0;
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background-color: var(--panel-bg);
            border-radius: 16px;
            margin-bottom: 0;
            max-height: 1000px;
            /* 用于折叠动画 */
            overflow: visible;
            transition: max-height 0.3s ease-in-out;
        }

        .toolbar.collapsed {
            max-height: 0px;
            padding-top: 0;
            padding-bottom: 0;
            overflow: hidden;
        }

        .toolbar-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 10px 15px;
        }

        .chart-container {
            height: 90vh;
            background-color: #fcfdfff8;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(218, 218, 218, 0.187);
        }

        .org-logo {
            height: 60px;
            /* 原有尺寸 */
            width: auto;
            margin-left: auto;
            /* 关键：左右 margin 设为 auto */
            margin-right: auto;
            /*     ↑  Flex 会把剩余宽度平均分配到这两个 margin */
            display: block;
        }

        /* --- 3. 组件样式：按钮、输入框、下拉菜单 --- */

        /* 基础按钮样式 */
        .btn {
            padding: 8px 14px;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            color: var(--text-color);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        /* 主色调按钮 (上传, 搜索, 创建) */
        .btn-primary {
            background: var(--primary-gradient);
            box-shadow: 0 0 10px var(--shadow-color-primary);
        }

        .btn-primary:hover {
            box-shadow: 0 0 15px var(--shadow-color-primary);
        }

        /* 次色调按钮 (重置, 布局切换) */
        .btn-secondary {
            background: var(--secondary-gradient);
            box-shadow: 0 0 10px var(--shadow-color-secondary);
        }

        .btn-secondary:hover {
            box-shadow: 0 0 15px var(--shadow-color-secondary);
        }

        /* 暗色/中性按钮 (Edit, 折叠) */
        .btn-dark {
            background: #3c3c3e69;
            box-shadow: 0 0 1px #ffffff;
        }

        .btn-dark:hover {
            background: #444;
        }

        /* 输入框样式 */
        .form-input {
            padding: 8px 12px;
            width: 150px;
            font-size: 15px;
            border: 1px solid transparent;
            outline: none;
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--primary-color);
            box-shadow: 0 0 10px var(--primary-color);
            transition: box-shadow 0.3s ease-in-out, border-color 0.3s;
        }

        .form-input:focus {
            box-shadow: 0 0 20px var(--primary-color);
            border-color: var(--primary-color);
        }

        /* dropdown */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown .dropdown-content {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            min-width: 180px;
            display: none;
            flex-direction: column;
            gap: 6px;
            padding: 8px;
            background: rgba(28, 36, 60, 0.845);
            border-radius: 10px;
            border: 3px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.6);
            z-index: 1200;
        }

        .dropdown.open .dropdown-content,
        .dropdown-content {
            display: flex;
        }



        .menu-item {
            display: block;
            width: 100%;
            padding: 6px 12px;
            font-size: 13px;
            text-align: left;
            background: none;
            border: none;
            border-radius: 0;
            white-space: nowrap;
        }

        .menu-item:not(:last-child) {
            border-bottom: 1px solid var(--border-color);
        }

        .modal {
            position: fixed;
            inset: 0;
            /* top:0; right:0; bottom:0; left:0; */
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(23, 23, 31, 0.779);
            z-index: 9999;
            padding: 28px;
            overflow: auto;
        }

        .modal.open {
            display: flex;
        }

        /* 内容容器 */
        .modal .modal-content {
            width: 100%;
            max-width: 900px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 14px;
            padding: 80px;
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.65);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            max-height: 90vh;
            /* 限制为视窗高度的 90% */
            overflow-y: auto;
            /* 关键：内容溢出时出现滚动条 */

        }

        /* 小提示：给关闭按钮统一样式 */
        .modal .close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: transparent;
            border: none;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
        }

        /* --- 5. 其他控件 --- */
        .date-filter {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            margin-left: auto;
            /* 推到右侧 */
        }

        input[type="range"] {
            width: 150px;
            accent-color: var(--primary-color);
            /* 现代浏览器支持，改变滑块颜色 */
        }

        /* --- 6. 响应式布局 --- */
        @media (max-width: 1200px) {
            .org-logo {
                display: none;
                /* 在中等屏幕上隐藏logo，为其他控件腾出空间 */
            }
        }

        @media (max-width: 992px) {
            .toolbar {
                justify-content: center;
            }

            .date-filter {
                margin-left: 0;
                width: 100%;
                justify-content: center;
                margin-top: 10px;
            }
        }

        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
                padding: 10px;
            }

            .btn,
            .form-input,
            .dropdown {
                width: 100%;
            }

            .dropdown-content {
                position: static;
                margin-top: 5px;
                box-shadow: none;
                border: none;
            }

            .form-group {
                flex-direction: column;
                align-items: stretch;
                gap: 5px;
                margin-bottom: 15px;
            }

            .form-group label {
                text-align: left;
            }
        }

        /* 连接线统一样式 —— 可按需改颜色 / 粗细 / 虚线 */
        .chart-container .link {
            stroke: #111111;
            /* 颜色 */
            stroke-width: 2px;
            /* 粗细 */

        }

        /* 添加到 <style> 标签的末尾 */
        .selection-choice {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .selection-choice:hover {
            background-color: #2a2a2a;
            border-color: var(--primary-color);
        }

        .selection-choice h4 {
            margin: 0 0 5px 0;
            color: var(--primary-color);
        }

        .selection-choice p {
            margin: 0;
            font-size: 14px;
            color: var(--text-color-light);
        }

        /* --- 最终方案：为 HTML 结构的展开/收回按钮自定义样式 --- */

        /* 1. 定位到作为按钮容器的 <div> */
        /* 这个选择器精确地匹配了您截图中 div 的父子结构 */
        .node-button-div>div {

            /* 核心需求：设置背景为深灰色 */
            /* !important 仍然需要，因为原始样式是内联 style，优先级很高 */
            background-color: #383535 !important;

            /* 让按钮更宽。
       对于HTML元素，直接调整内边距(padding)或设置最小宽度(min-width)是最好的方法
    */

            min-width: 45px !important;
            min-height: 10px !important;
            /* 您可以根据需要调整这个数值 */

            display: flex !important;
            align-items: center;
            justify-content: center;


        }

        /* 2. 定位到按钮内部的 <span> 元素，改变文字颜色 */
        /* 选择器 .node-button-div span 会选中所有的 span，包括图标和数字 */
        .node-button-div span {

            /* 将文字颜色改为白色以保证清晰可读 */
            color: #FFFFFF !important;
            font-size: 13px;
        }


        /* 让折叠/展开图标纯白，粗一点，顺便调大小 */
        .node-button-div svg {
            /* 整个 SVG */
            width: 12px;
            /* 默认是 8px，可放大一倍 */
            height: 12px;
        }

        .node-button-div svg *,
        .node-button-div svg

        /* 路径与自身都覆盖 */
            {
            fill: #FFFFFF !important;
            /* 少量图标用 fill */
            stroke: #FFFFFF !important;
            /* 大部分箭头用 stroke */
            stroke-width: 2;
            /* 线条更粗 */
        }

        @media print {

            html,
            body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                overflow: hidden;
                /* 强制隐藏任何可能超出页面的内容 */
            }

            body * {
                visibility: hidden;
                /* 隐藏所有内容 */
            }

            .chart-container,
            .chart-container * {
                visibility: visible;
                /* 只显示图表区域 */
            }

            .chart-container {
                position: absolute;
                top: 50px;
                left: 50px;
                right: 50px;
                bottom: 50px;

                /* 移除原有的宽度和高度设置，尺寸由上面的四个定位属性自动撑开 */
                width: auto;
                height: auto;
            }

        }

        /* 隐藏节点按钮中的数字 */
        .node-button-div span+span {
            display: none !important;
        }

        /* --- 添加到 <style> 标签的末尾 --- */

        /* 饼图容器的额外样式 */
        .service-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 15px;
            /* 为标题留出空间 */
        }

        /* 饼图提示框样式 (更新版) */
        .pie-tooltip {
            position: absolute;
            text-align: center;
            width: auto;
            padding: 8px 12px;
            font: 12px sans-serif;
            background: rgba(20, 30, 50, 0.7);
            /* 深蓝色半透明背景 */
            border: 1px solid rgba(255, 255, 255, 0.2);
            /* 细微的白色边框 */
            border-radius: 8px;
            pointer-events: none;
            /* 关键：让鼠标事件穿透提示框 */
            color: #fff;
            backdrop-filter: blur(5px);
            /* 背景模糊，核心的玻璃效果 */
            -webkit-backdrop-filter: blur(5px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transition: opacity 0.2s;
            /* 添加平滑过渡 */
        }

        .glow-white {
            text-shadow:
                0 1px 1px rgba(255, 255, 255, 0.4),
                0 1px 2px rgba(255, 255, 255, 0.3),
                0 2px 3px rgba(255, 255, 255, 0.2),
                0 2px 4px rgba(255, 255, 255, 0.1);
        }


        /* 可选：呼吸式扩散动画 */
        .glow-pulse {
            animation: glowPulse 2.2s ease-in-out infinite;
        }

        @keyframes glowPulse {
            0% {
                text-shadow:
                    0 0 2px rgba(255, 255, 255, 0.9),
                    0 0 6px rgba(255, 255, 255, 0.6);
            }

            70% {
                text-shadow:
                    0 0 6px rgba(255, 255, 255, 0.9),
                    0 0 16px rgba(255, 255, 255, 0.6),
                    0 0 28px rgba(255, 255, 255, 0.45),
                    0 0 40px rgba(255, 255, 255, 0.35);
            }

            100% {
                text-shadow:
                    0 0 2px rgba(255, 255, 255, 0.9),
                    0 0 6px rgba(255, 255, 255, 0.6);
            }
        }
    </style>
</head>


<script>
    let chart;         // chart 实例，用于后续更新图表
    let globalData = []; // 全局数据源，加载 csv 后保存在这里
    let originalData = []; // 新增变量：用于存储原始完整数据
    let nodeToModify = null; // ▼ 新增：用于存储待修改的节点对象 ▼
    let status = true; // 用于判断是否需要上传文件
    let uploadedData = null; // 新增：存储上传的原始数据
    let data_by_position = null;
    let dateValues = [];//存储日期
    let isConfigPanelVisible = true;
    const now = new Date();
    const undoStack = [];
    const redoStack = [];


    console.log(now);


    /**
 * 根据指定字段聚合数据
 * @param {Array} data - 原始数据数组
 * @param {string} field - 用于聚合的字段名 (例如 'Position_Band')
 * @returns {Array} - 返回聚合后的数据，格式为 [{key: '...', value: count}, ...]
 */
    function aggregateDataByField(data, field) {
        if (!data || !Array.isArray(data)) return [];

        const counts = d3.rollup(data, v => v.length, d => d[field]);
        return Array.from(counts, ([key, value]) => ({ key: key || 'Undefined', value }));
    }

    // 新增：定义一个现代感的蓝色系调色板
    // 定义一个现代、有设计感的蓝紫色调色板
    const modernBluePalette = [
        '#5a189a', // 深邃紫
        '#0077b6', // 星海蓝
        '#7b2cbf', // 活力紫
        '#00b4d8', // 天青蓝
        '#9d4edd', // 丁香紫
        '#48cae4', // 碧空蓝
        '#c77dff', // 柔光紫
        '#ade8f4'  // 冰晶蓝
    ];

    /**
 * 绘制饼图的通用函数 (更新版：现代蓝色玻璃效果)
 * @param {string} containerSelector - 目标容器的CSS选择器 (例如 '#position-band-chart-container')
 * @param {Array} data - 聚合后的数据
 */
    function createPieChart(containerSelector, data) {
        const container = d3.select(containerSelector);
        if (container.empty()) {
            console.error(`无法找到容器: ${containerSelector}`);
            return;
        }

        // 清空旧图表
        container.select('svg').remove();
        container.style('position', 'relative');

        // 设置图表尺寸
        const containerRect = container.node().getBoundingClientRect();
        const width = containerRect.width * 0.9;
        const height = 220;
        const radius = Math.min(width, height) / 2 - 10;

        const svg = container.append('svg')
            .attr('width', width)
            .attr('height', height)
            .append('g')
            .attr('transform', `translate(${width / 2}, ${height / 2})`);

        // --- 【修改点 1】: 使用新的蓝色调色板 ---
        // 将 d3.schemeCategory10 替换为我们的 modernBluePalette
        const color = d3.scaleOrdinal(modernBluePalette);

        // 创建饼图生成器
        const pie = d3.pie()
            .value(d => d.value)
            .sort(null);

        const arc = d3.arc()
            .innerRadius(0) // 实心饼图
            .outerRadius(radius);

        // --- 【新增】: 为SVG添加滤镜定义，用于实现磨砂效果 ---
        const defs = svg.append('defs');
        const filter = defs.append('filter')
            .attr('id', 'frosted-glass');
        filter.append('feGaussianBlur')
            .attr('in', 'SourceGraphic')
            .attr('stdDeviation', '0'); // 模糊程度，数值越大越模糊

        // 创建提示框（Tooltip）
        const tooltip = container.append('div')
            .attr('class', 'pie-tooltip')
            .style('opacity', 0);

        // 绘制扇区
        svg.selectAll('path')
            .data(pie(data))
            .enter()
            .append('path')
            .attr('d', arc)
            // --- 【修改点 2】: 应用玻璃效果样式 ---
            .attr('fill', d => color(d.data.key))
            .attr('fill-opacity', 0.5) // 设置填充不透明度，营造半透明感
            .attr('stroke', 'rgba(255, 255, 255, 0.4)') // 添加白色描边，模拟高光边缘
            .style('stroke-width', '2px') // 描边宽度

            .style('filter', 'url(#frosted-glass)') // 应用上面定义的模糊滤镜
            .on('mouseover', function (event, d) {
                // 鼠标悬浮时，提高不透明度并移除滤镜，使其“清晰”高亮
                d3.select(this).transition().duration(200)
                    .attr('fill-opacity', 0.7)
                    .style('filter', null);

                tooltip.transition().duration(200).style('opacity', .9);
                tooltip.html(`<strong>${d.data.key}</strong><br/>Count: ${d.data.value}`)
                    .style('left', (event.offsetX + 10) + 'px')
                    .style('top', (event.offsetY - 20) + 'px');
            })
            .on('mouseout', function () {
                // 鼠标移开后，恢复半透明和磨砂效果
                d3.select(this).transition().duration(500)
                    .attr('fill-opacity', 0.5)
                    .style('filter', 'url(#frosted-glass)');

                tooltip.transition().duration(500).style('opacity', 0);
            });

        // 添加图例
        const legend = svg.selectAll('.legend')
            .data(data.map(d => d.key))
            .enter().append('g')
            .attr('class', 'legend')
            .attr('transform', (d, i) => `translate(${radius + 20}, ${i * 20 - height / 2 + 10})`);

        legend.append('rect')
            .attr('width', 18)
            .attr('height', 18)
            .style('fill', color)
            // --- 【修改点 3】: 让图例也拥有玻璃效果 ---
            .style('fill-opacity', 0.7)
            .style('stroke', '#ffffff')
            .style('stroke-width', '1px');

        legend.append('text')
            .attr('x', 24)
            .attr('y', 9)
            .attr('dy', '.35em')
            .style('fill', '#fff')
            .text(d => d);
    }


    function sortDataByBand(data) {
        const bandOrder = { "1": 0, "2": 1, "3": 2, "4": 3, "AL": 4 };
        // 使用 slice() 创建一个浅拷贝，避免修改原始数组
        return data.slice().sort((a, b) => {
            return bandOrder[a.Position_Band] - bandOrder[b.Position_Band];
        });
    }
    // 加载 CSV 数据并初始化组织图
    function handleFileUpload() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        if (!file) {
            alert("Please upload csv file！");
            return;
        }

        const reader = new FileReader();

        reader.onload = function (e) {
            const csvText = e.target.result;
            const data = d3.csvParse(csvText);
            let uniqueIdCounter = 0; // 新增一个计数器

            // === 处理 Position_Band 字段 ===
            uploadedData = data.map(d => {
                switch (d.Position_Band) {
                    case '001': d.Position_Band = '1'; break;
                    case '1': d.Position_Band = '1'; break;
                    case '002': d.Position_Band = '2'; break;
                    case '2': d.Position_Band = '2'; break;
                    case '003': d.Position_Band = '3'; break;
                    case '3': d.Position_Band = '3'; break;
                    case '004': d.Position_Band = '4'; break;
                    case '4': d.Position_Band = '4'; break;
                    case 'B': d.Position_Band = 'B'; break;
                    default: d.Position_Band = 'AL';
                }

                // 返回与原 CSV 字段一致的结构
                return {
                    ...d,
                    id: d.Position_Number,
                    parentId: d.Reports_To_Position_Number,
                    _uniqueId: `csv-${uniqueIdCounter++}` // 新增：分配唯一的内部ID
                };
            });




            // 将处理后的数据保存到全局变量
            originalData = JSON.parse(JSON.stringify(uploadedData)); // 保留一份纯净的原始数据备份
            editedData = JSON.parse(JSON.stringify(uploadedData)); // 这是我们未来操作的“源数据”
            globalData = [...uploadedData]; // 如果还在用 globalData，也这样初始化

            alert('File uploaded！Please enter whole name');
            updateHomepageStats();   // ← 新增：刷新主页“Total Positions”
            // ▼▼▼【新增代码】从这里开始 ▼▼▼

            // 1. 聚合 Position_Band 数据并生成饼图
            const positionBandData = aggregateDataByField(originalData, 'Position_Band');
            if (positionBandData.length > 0) {
                createPieChart('#position-band-chart-container', positionBandData);
            }

            // 2. 聚合 Company_Descr_Short 数据并生成饼图
            // 注意：您的CSV文件中似乎没有 Company_Descr_Short 字段，
            // 这里我暂时使用 Department_Descr_Short 作为示例。
            // 如果您的CSV中有这个字段，请直接替换。
            const entityData = aggregateDataByField(originalData, 'Company_Descr_Short');
            if (entityData.length > 0) {
                createPieChart('#entity-chart-container', entityData);
            }

            // ▲▲▲【新增代码】到这里结束 ▲▲▲

            initDateSlider();
        };

        reader.readAsText(file);
    }
    // 更新主页统计卡片里“Total Positions”的数字
    function updateHomepageStats() {
        if (!Array.isArray(originalData) || originalData.length === 0) return;

        // 只统计真实记录，过滤掉虚拟节点
        const rows = originalData.filter(r => r && !r.isVirtual);
        const total = rows.length;

        // Display_Name 为空、全空格，或为 'NA' 等视为“空岗”
        const isEmptyName = v => v == null || String(v).trim() === '' || String(v).trim().toLowerCase() === 'na';
        const vacant = rows.filter(r => isEmptyName(r.Display_Name)).length;
        const rate = total ? (vacant / total * 100) : 0;

        // 根据 stat-label 精确找到卡片（大小写不敏感，自动忽略多空格）
        const norm = s => (s || '').toLowerCase().replace(/\s+/g, ' ').trim();
        const findCard = (labels) => {
            const wanted = labels.map(norm);
            const cards = document.querySelectorAll('#home .stats .stat-card');
            for (const card of cards) {
                const labelEl = card.querySelector('.stat-label');
                if (wanted.includes(norm(labelEl?.textContent))) return card;
            }
            return null;
        };
        const setNumber = (card, value) => {
            if (!card) return;
            const el = card.querySelector('.stat-number');
            if (el) el.textContent = value;
        };

        // 写入三个指标
        setNumber(findCard(['Total Positions']), String(total));
        setNumber(findCard(['Vacant Positions']), String(vacant));
        setNumber(findCard(['Vacancy Rate']), `${rate.toFixed(1)}%`);
    }



    // 替换掉旧的 searchPerson 函数

    function searchPerson() {
        const nameToSearch = document.getElementById("searchInput").value.trim();
        if (!nameToSearch) {
            alert("Please enter whole name (Lastname Firstname)");
            return;
        }

        // 在原始数据中查找所有匹配该姓名的员工
        const matchedPersons = editedData.filter(d =>
            (d.Display_Name && d.Display_Name.trim().toLowerCase() === nameToSearch.trim().toLowerCase()) ||
            (d.Position_Number && String(d.Position_Number).trim() === nameToSearch.trim())
        );

        if (matchedPersons.length === 0) {
            alert(`Cannot find ${nameToSearch}`);
            return;
        }

        // 查找成功后，立即用完整数据初始化/重置日期滑块
        initDateSlider();

        if (matchedPersons.length === 1) {
            // 如果只有一个匹配项，直接生成图表
            buildAndDisplayChart(matchedPersons[0]);
        } else {
            // 如果有多个匹配项，显示选择模态框
            const modal = document.getElementById('selectionModal');
            const choicesContainer = document.getElementById('selectionChoices');

            // 1. 清空旧选项
            choicesContainer.innerHTML = '';

            // 2. 动态创建新选项
            matchedPersons.forEach(person => {
                const choiceElement = document.createElement('div');
                choiceElement.className = 'selection-choice';
                // 将 Position_Number 存储在 data attribute 中，方便后续获取
                choiceElement.dataset.id = person.Position_Number;

                choiceElement.innerHTML = `
        <h4>${person.Display_Name}</h4>
        <p>${person.Position_Number}</p>
        <p>${person.Department_Descr_Short}</p>
        <p>${person.Position_Descr}</p>
        <p>${person.Effective_Date}</p>
      `;

                // 3. 为每个选项添加点击事件
                choiceElement.addEventListener('click', () => {
                    // 从数据中找到完整的 person 对象
                    const selectedPerson = editedData.find(d => d.id === person.Position_Number);
                    if (selectedPerson) {
                        initDateSlider();
                        buildAndDisplayChart(selectedPerson);
                    }
                    modal.style.display = 'none'; // 关闭模态框
                });

                choicesContainer.appendChild(choiceElement);
            });

            // 4. 显示模态框
            modal.style.display = 'flex';
        }
    }
    /**
     * 修正版函数：遍历整个数据树，为所有子节点数>6的节点应用虚拟分组。
     * 这个版本通过创建新对象来避免“数据污染”。
     * @param {Array} data - 用于图表渲染的完整数据数组。
     * @returns {Array} - 经过转换，包含了虚拟节点的新数据数组。
     */
    function applyVirtualGrouping(data) {
        // 复制一份数据进行操作，这是一个浅拷贝，但我们后续会处理对象引用问题
        let processedData = [...data];
        const virtualNodesToAdd = [];

        // 创建一个按 parentId 分组的 Map，方便快速查找子节点
        const childrenMap = new Map();
        data.forEach(node => {
            // 忽略虚拟节点自身，它们不应该成为父节点
            if (node.isVirtual) return;

            if (node.parentId) {
                if (!childrenMap.has(node.parentId)) {
                    childrenMap.set(node.parentId, []);
                }
                childrenMap.get(node.parentId).push(node);
            }
        });

        // 遍历所有可能的父节点
        childrenMap.forEach((children, parentId) => {
            if (children.length > 6) {
                const numVirtualNodes = children.length <= 12 ? 2 : 3;
                const virtualNodes = [];

                // 创建虚拟节点
                for (let i = 0; i < numVirtualNodes; i++) {
                    const virtualNode = {
                        id: `virtual-${parentId}-${i}`,
                        parentId: parentId,
                        Display_Name: `Group ${i + 1}`,
                        isVirtual: true,
                        Position_Band: 'VIRTUAL',
                        Effective_Date: '2000/12/01 00:00:00'

                    };
                    virtualNodes.push(virtualNode);
                    virtualNodesToAdd.push(virtualNode); // 先收集起来，最后统一添加
                }

                // --- 核心修正点 ---
                // 重新分配子节点的 parentId，但不是直接修改，而是替换为新对象
                children.forEach((child, index) => {
                    const childIndexInProcessedData = processedData.findIndex(d => d.id === child.id);

                    if (childIndexInProcessedData !== -1) {
                        const virtualNodeIndex = index % numVirtualNodes;

                        // 创建一个全新的子节点对象副本，只修改 parentId
                        const updatedChild = {
                            ...processedData[childIndexInProcessedData], // 复制所有属性
                            parentId: virtualNodes[virtualNodeIndex].id // 覆盖 parentId

                        };

                        // 在 processedData 数组中，用新对象替换掉旧对象
                        processedData.splice(childIndexInProcessedData, 1, updatedChild);
                    }
                });
            }
        });

        // 将所有新创建的虚拟节点合并到结果数组中
        return [...processedData, ...virtualNodesToAdd];
    }

    // 替换旧的 buildAndDisplayChart 函数
    function buildAndDisplayChart(person) {
        if (!person) return;

        // 1. 获取日期滑块的当前选定日期
        const slider = document.getElementById('dateRange');
        // 如果滑块还没有初始化，就用今天的日期
        const selectedDate = dateValues[slider.value] || formatDate(new Date());

        // 2. 调用新函数，获取基于该日期的、干净的 "视图数据"
        const viewData = getViewDataForDate(selectedDate);

        // 3. 在渲染前，对刚刚生成的 viewData 重新计算下属人数
        //    这样可以确保图表上显示的所有计数值都是基于当前日期的准确值
        recalculateSubordinateCounts(viewData);

        // 3. getSubtree 函数现在基于干净的 viewData 操作
        function getSubtree(rootId) {
            const children = viewData.filter((d) => d.parentId === rootId);
            let result = [...children];
            for (let child of children) {
                result = result.concat(getSubtree(child.id));
            }
            return result;
        }

        // 4. 构建用于渲染的最终数据
        const subtree = getSubtree(person.id);
        const rootNodeInView = viewData.find(d => d.id === person.id); // 确保根节点也来自viewData
        const rootNodeForChart = { ...rootNodeInView, parentId: null };
        let mainTree = [rootNodeForChart, ...subtree];
        mainTree = sortDataByBand(mainTree);

        // 5. 应用虚拟分组并显示图表 (这部分逻辑不变)
        const transformedTree = applyVirtualGrouping(mainTree);
        displayChart(transformedTree);
        data_by_position = transformedTree; // 更新全局变量以反映当前视图
    }


    document.addEventListener("DOMContentLoaded", function () {
        // ...您已有的其他 DOMContentLoaded 代码...

        const selectionModal = document.getElementById('selectionModal');
        const cancelSelectionBtn = document.getElementById('cancelSelection');

        // 点击取消按钮关闭模态框
        if (cancelSelectionBtn) {
            cancelSelectionBtn.onclick = () => {
                selectionModal.style.display = 'none';
            };
        }

        // 点击模态框背景也能关闭
        if (selectionModal) {
            selectionModal.addEventListener('click', e => {
                if (e.target === selectionModal) {
                    selectionModal.style.display = 'none';
                }
            });
        }
    });




    // 1. 添加字段配置面板到HTML中（需要在HTML中添加容器）
    // 修改 createConfigPanel 函数
    function createConfigPanel() {
        // 创建容器（用于包裹按钮和面板）
        const configContainer = document.createElement('div');
        configContainer.id = 'chart-config-container';
        configContainer.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: flex;
        flex-direction: row-reverse;
        align-items: flex-end;
        gap: 10px;
        z-index: 1000;
    `;

        // 创建切换按钮
        const toggleBtn = document.createElement('button');
        toggleBtn.id = 'config-toggle-btn';
        toggleBtn.innerHTML = '⚙️';
        toggleBtn.style.cssText = `
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 1);
        border: 1px solid #fff;
        color: white;
        font-size: 20px;
        cursor: pointer;
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
    `;

        // 创建配置面板
        const configPanel = document.createElement('div');
        configPanel.id = 'chart-config-panel';
        configPanel.style.cssText = `
        position: relative;
        background: rgba(0, 0, 0, 0.5);
        padding: 15px;
        border: 2px solid #fff;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        color: white;
        transition: transform 0.3s ease, opacity 0.3s ease;
    `;

        configPanel.innerHTML = `
        <h3 style="margin-top:0; color:#fff; border-bottom:1px solid #fff; padding-bottom:8px;">Field Filter</h3>
        <div id="field-configs" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;"></div>
        <div style="margin-top:15px; display:flex; gap:8px;">
            <button id="save-config" style="flex:1; background:#0066cc; color:white; border:1px solid #0ff; padding:5px;">Save Configuration</button>
            <button id="reset-config" style="flex:1; background:#333; color:white; border:1px solid #888; padding:5px;">Reset Configuration</button>
        </div>
    `;

        // 添加关闭按钮到面板右上角
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = '×';
        closeBtn.style.cssText = `
        position: absolute;
        top: 5px;
        right: 8px;
        background: transparent;
        border: none;
        color: #fff;
        font-size: 20px;
        cursor: pointer;
        line-height: 1;
        padding: 0;
    `;
        configPanel.appendChild(closeBtn);

        // 组装元素
        configContainer.appendChild(toggleBtn);
        configContainer.appendChild(configPanel);
        document.body.appendChild(configContainer);

        // 添加事件监听
        toggleBtn.addEventListener('click', toggleConfigPanel);
        closeBtn.addEventListener('click', toggleConfigPanel);

        // 初始化面板状态
        updatePanelVisibility();
    }

    // 新增函数：切换面板可见性
    function toggleConfigPanel() {
        // 从localStorage加载保存的状态
        const savedState = localStorage.getItem('configPanelState');
        if (savedState) {
            isConfigPanelVisible = JSON.parse(savedState);
        }

        isConfigPanelVisible = !isConfigPanelVisible;
        updatePanelVisibility();

        // 保存状态到localStorage
        localStorage.setItem('configPanelState', JSON.stringify(isConfigPanelVisible));
    }

    // 新增函数：更新面板可见性
    function updatePanelVisibility() {
        const panel = document.getElementById('chart-config-panel');
        const toggleBtn = document.getElementById('config-toggle-btn');

        if (!panel || !toggleBtn) return;

        if (isConfigPanelVisible) {
            // 先确保可见（解除 display:none），然后触发过渡
            panel.style.display = 'block';            // 从渲染树中恢复
            // 保证下一帧应用 transform/opacity，触发 CSS transition
            requestAnimationFrame(() => {
                panel.style.transform = 'translateX(0)';
                panel.style.opacity = '1';
                panel.style.pointerEvents = 'auto';
            });
            toggleBtn.innerHTML = '⚙️';
            toggleBtn.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        } else {
            // 先做淡出/移动动画
            panel.style.transform = 'translateX(20px)';
            panel.style.opacity = '0';
            panel.style.pointerEvents = 'none';
            toggleBtn.innerHTML = '⚙️';
            toggleBtn.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';

            // 隐藏动画结束后彻底 remove（避免挡住事件）
            const onTransEnd = (e) => {
                // 仅在面板本身的 transitionend 时处理一次
                if (e.target === panel) {
                    panel.style.display = 'none';
                    panel.removeEventListener('transitionend', onTransEnd);
                }
            };
            panel.addEventListener('transitionend', onTransEnd);
        }
    }



    // 2. 字段配置定义
    const fieldConfigurations = [
        { id: 'displayName', label: 'Name', field: 'Display_Name', default: true },
        { id: 'department', label: 'Department', field: 'Department_Descr_Short', default: true },
        { id: 'PositionBand', label: 'Position Band', field: 'Position_Band', default: true },
        { id: 'salaryGrade', label: 'Salary Grade', field: 'Salary_Grade', default: true },
        { id: 'posentrydate', label: 'Pos Entry Date', field: 'Pos_Entry_Date', default: true },
        { id: 'effectiveDate', label: 'Effective Date', field: 'Effective_Date', default: false },
        { id: 'Span_of_Control', label: 'Span of Control', field: 'Span_of_Control', default: true },
        { id: 'totalStaffs', label: 'Total Staffs', field: 'Staffs', default: true },
        { id: 'PositionDescr', label: 'Position Descr', field: 'Position_Descr', default: true },
        { id: 'Funding', label: 'Funding', field: 'FTE_Type_Funding_Status', default: true },
        { id: 'CostCenter', label: 'Cost Center', field: 'Cost_Center', default: true },
        { id: 'RiskAssessment', label: 'Risk Assessment', field: 'Risk_Assessment', default: true },
        { id: 'Remark', label: 'Remark', field: 'Mark_in_OrgChart', default: true },
        { id: 'DirectReport', label: 'Direct Report', field: 'Direct_Report', default: true },
        { id: 'Remark2', label: 'Remark 2', field: 'Remark_2', default: false },
        { id: 'Remark3', label: 'Remark 3', field: 'Remark_3', default: false }
    ];

    // 3. 字段配置状态管理
    let fieldConfigState = {};

    function initializeFieldConfig() {
        // 尝试从localStorage加载配置
        const savedConfig = localStorage.getItem('orgChartFieldConfig');

        if (savedConfig) {
            fieldConfigState = JSON.parse(savedConfig);
        } else {
            // 使用默认配置
            fieldConfigState = {};
            fieldConfigurations.forEach(config => {
                fieldConfigState[config.id] = config.default;
            });
        }

        renderFieldConfigUI();
    }

    function renderFieldConfigUI() {
        const container = document.getElementById('field-configs');
        if (!container) return;

        container.innerHTML = '';

        fieldConfigurations.forEach(config => {
            const isChecked = fieldConfigState[config.id];

            const checkbox = document.createElement('div');
            checkbox.style.display = 'flex';
            checkbox.style.alignItems = 'center';
            checkbox.style.gap = '5px';

            checkbox.innerHTML = `
      <input type="checkbox" id="${config.id}" ${isChecked ? 'checked' : ''}>
      <label for="${config.id}" style="cursor:pointer;">${config.label}</label>
    `;

            container.appendChild(checkbox);

            // 添加事件监听
            document.getElementById(config.id).addEventListener('change', (e) => {
                fieldConfigState[config.id] = e.target.checked;
                refreshChart();
            });
        });
    }

    function getNodeContent(d) {
        if (d.data.isVirtual) {
            return `
        <div style="
         
          background-color: transparent; /* 完全透明 */
          border: none; /* 无边框 */
        ">
        </div>
      `;
        }
        // --- 修改结束 ---
        const dynamicSrc = `./images/${d.data.Job_User_ID}.png`;
        const defaultSrc = `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAF8AAABfCAYAAACOTBv1AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAABdzSURBVHhe5Z0JtNXTF8ePh1BJRElKUchYKilKKaVBKEKUTIlFahWRpfxTFrLM46JQallRSYhMadBgKEVSkkqJzGPG8z+f/e6+zvu9c++79707vPiutd+97zec3/nts8/e+5x9zr7bGWOso3KHGjVqmHr16pnatWubvffe2+y2226mcuXKZpdddjE77bST2XHHHU1BQYH566+/zO+//262bt1qfvnlF/PTTz+Zb775xmzatMl8+umnZu3atebnn3+OlVq+kBfmwzRrrZCiQYMG5rDDDjMHHXSQqVOnjtlnn33MnnvuaapWrWp23XVXs/POO5sKFSoI07fffnuh7bbbzvz999/SAH/++af5448/zG+//SaN8OOPP5pvv/3WfPHFF9IQ69atMx9++KF55513pHHKA/LCfJgG4w899FBz7LHHmkMOOcQceOCBZt999xWG77777iLdXFdW0DA0Bg3x5Zdfmk8++cSsXr3avP3222bu3Lnm66+/jl2Ze+Sc+agTGH7MMceYI4880tSvX99Ur17dVKxYUXpEtkEP+eGHH8xnn30mPeG9994zs2fPNsuWLcu5esoZ81ElJ554ojnhhBPM4YcfLv+jTtJhOLr9119/FWlG/6OGYCTH+Y5qQi0l6jGq5vQ8DfHVV19Jb6AnPP/882bhwoVSZkg1ZhpZZz6S3qVLF3PSSSeZxo0biwFFpSQDRvPzzz8X6URX6ydMQa8fddRR5txzzzV169Y1L730kpkyZYowcYcddhC1xXFUGJ808l577SXPhJHRhlHmUvbHH38szKe8t956S+qRTWSM+VFJQRJh+mmnnSYqBiYkYjoSCLPff/998+abb4pOxih+//335rvvvpNPdDYSDi688EJz7bXXmgMOOECk9brrrhP1AfCGsBl4R/q5xx57SIM1a9bMHHzwwfI/BhtonWkUiEZYuXKleeONN8zYsWPNqlWr4u+UDVBymclVPP69RYsW9tZbb7VLliyxzti5uhfCeSZCis2bN1vHPDtgwADbqVMn6xhkq1WrZh1jipQdpeuvv17uBe+++651NiR4nRLluZ5gnRDYbt262VGj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`;



        // 判断 Risk_Assessment 是否为 'Yes' 或 'compulsory'（不区分大小写）
        const isRiskRed = d.data.Risk_Assessment && (d.data.Risk_Assessment.toLowerCase() === 'yes' || d.data.Risk_Assessment.toLowerCase() === 'compulsory');
        const idColor =
            !d.data.Display_Name || d.data.Display_Name.trim() === '' ? 'red' : '#212121';
        // 设置字体颜色为红色，并加粗，如果符合条件
        const riskStyle = isRiskRed ? 'color: red; font-weight: 600;' : '';

        // 动态设置顶部渐变条的颜色
        let gradientColor = '';
        if (d.data.Position_Band === '1' || d.data.Position_Band === 'B' || d.data.Position_Band === 'C' || d.data.Position_Band === '001') {
            gradientColor = 'background:darkgreen ;';
        } else if (d.data.Position_Band === '2' || d.data.Position_Band === '002') {
            gradientColor = 'background: lawngreen;';
        } else if (d.data.Position_Band === '3' || d.data.Position_Band === '003') {
            gradientColor = 'background: navy;';
        } else if (d.data.Position_Band === '4' || d.data.Position_Band === '004') {
            gradientColor = 'background: skyblue;';
        } else if (d.data.Position_Band === 'AL') {
            // 判断是否有子节点
            const hasChildren = d.data.Direct_Report > 0;
            gradientColor = hasChildren ? 'background: gray;' : 'background: white;';
        }


        return `
  <div style="
    padding-top: 30px;
    margin-left: 0;
    height: ${d.height}px;
    overflow: visible;
  ">
    <div style="
      height: ${d.height - 32}px;
      background-color:#ffffff;
      border-radius: 12px;
      border: ${(
                String(d.data.Mark_in_OrgChart ?? '').toLowerCase().includes('dot') ||
                String(d.data.Remark_2 ?? '').toLowerCase().includes('dot') ||
                String(d.data.Remark_3 ?? '').toLowerCase().includes('dot')
            )
                ? '4px dashed #000'
                : '1px solid rgba(0,0,0,0.05)'
            };

      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: relative;
    ">
      <!-- 顶部渐变条，使用动态颜色 -->
      <div style="
        position: absolute; top: 0; left: 0;
        width: 100%; height: 8px;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        ${gradientColor}  /* 动态背景颜色 */
      "></div>
      
      <!-- 头像 -->
      <img
        
        src="${dynamicSrc}"
        onerror="this.onerror=null; this.src='${defaultSrc}';"
        
        style="
          position: absolute; top: -30px;
          left: calc(50% - 30px);
          width: 60px; height: 60px;
          border-radius: 50%;
          border: 2px solid rgba(64,201,255,0.8);
          box-shadow: 0 2px 6px rgba(64,201,255,0.3);
          background-color: #fff;
        "
      />

      <!-- ID -->
      <div style="
        position: absolute; top: 12px; right: 12px;
        color: ${idColor}; font-size: 16px;
      ">${d.data.id}</div>

      <!-- PB -->
      <div style="
        position: absolute; top: 12px; left: 12px;
        color: #212121; 
      ">
      ${fieldConfigState.PositionBand ? `<div style="font-size: 20px; font-weight: 1000;">${d.data.Position_Band}</div>` : ''}
      </div>

      <!-- 内容区 -->
      <div style="padding: 50px 20px 20px; text-align: center; color: #212121;">
        ${fieldConfigState.displayName ? `<div style="font-size: 18px; font-weight: 600;">${d.data.Display_Name}</div>` : ''}
        ${fieldConfigState.department ? `<div style="font-size: 14px; margin-top: 4px; color: #555;">${d.data.Department_Descr_Short}</div>` : ''}
      </div>

      <style>
        .info-row {
          display: flex;
          justify-content: space-between;
          padding: 0 20px;
          margin-bottom: 8px;
          color: #212121;
          font-size: 13px;
        }
        .info-row .label {
          color: #212121;
          margin-right: 4px;
        }
        

      </style>


      ${fieldConfigState.PositionDescr ? `
      <div class="info-row">
        <div><span class="label">Position Descr:</span>${d.data.Position_Descr}</div>
      </div>` : ''}

      ${fieldConfigState.salaryGrade ? `
      <div class="info-row">
        <div><span class="label">Salary Grade:</span>${d.data.Salary_Grade}</div>
      </div>` : ''}

      ${fieldConfigState.effectiveDate ? `
      <div class="info-row">
        <div><span class="label">Effective Date:</span>${d.data.Effective_Date}</div>
      </div>` : ''}

      ${fieldConfigState.posentrydate ? `
      <div class="info-row">
        <div><span class="label">Pos.Entry Date:</span>${d.data.Pos_Entry_Date}</div>
      </div>` : ''}

      ${fieldConfigState.Span_of_Control || fieldConfigState.totalStaffs ? `
      <div class="info-row">
        ${fieldConfigState.Span_of_Control ? `<div><span class="label">Span_of_Control:</span>${d.data.Span_of_Control}👤</div>` : ''}
        ${fieldConfigState.totalStaffs ? `<div><span class="label">Staffs:</span>${d.data.Staffs}👤</div>` : ''}
      </div>` : ''}

      ${fieldConfigState.Funding || fieldConfigState.CostCenter ? `
      <div class="info-row">
        ${fieldConfigState.Funding ? `<div><span class="label">Funding:</span>${d.data.FTE_Type_Funding_Status}</div>` : ''}
        ${fieldConfigState.CostCenter ? `<div><span class="label">Cost Center:</span>${d.data.Cost_Center}</div>` : ''}
      </div>` : ''}

      ${fieldConfigState.RiskAssessment || fieldConfigState.DirectReport ? `
      <div class="info-row">
        ${fieldConfigState.RiskAssessment ? `<div><span class="label" style="${riskStyle}">Risk Assessment:</span><span style="${riskStyle}">${d.data.Risk_Assessment}</span></div>` : ''}
        ${fieldConfigState.DirectReport ? `<div><span class="label">Direct Report:</span>${d.data.Direct_Report}👤</div>` : ''}
      </div>` : ''}

       ${fieldConfigState.Remark ? `
      <div class="info-row">
        <div><span class="label">Remark:</span>${d.data.Mark_in_OrgChart}</div>
      </div>` : ''}

      ${fieldConfigState.Remark2 ? `
      <div class="info-row">
        <div><span class="label">Remark 2:</span>${d.data.Remark_2}</div>
      </div>` : ''}

      ${fieldConfigState.Remark3 ? `
      <div class="info-row">
        <div><span class="label">Remark 3:</span>${d.data.Remark_3}</div>
      </div>` : ''}

      <!-- 可保留图表容器 -->
      <div id="chart-container-${d.data.id}" style="height: 100px; margin: 0 20px;"></div>
    </div>
  </div>
  `;
    }


    // 5. 刷新图表函数
    function refreshChart() {
        if (chart) {
            // 更新节点内容函数
            chart.nodeContent(getNodeContent);
            // 重新渲染图表
            chart.render();
            chart.collapseAll();
        }
    }

    // 6. 保存和重置配置功能
    function setupConfigActions() {
        document.getElementById('save-config')?.addEventListener('click', () => {
            localStorage.setItem('orgChartFieldConfig', JSON.stringify(fieldConfigState));
            alert('Config Saved！');
        });

        document.getElementById('reset-config')?.addEventListener('click', () => {
            // 重置为默认配置
            fieldConfigurations.forEach(config => {
                fieldConfigState[config.id] = config.default;
            });

            renderFieldConfigUI();
            refreshChart();
        });
    }

    function getFieldCount(d) {
        return fieldConfigurations.reduce((count, config) => {
            // config.id 如 "displayName"，config.field 如 "Display_Name"
            if (fieldConfigState[config.id] && d.data[config.field] != null) {
                return count + 1;
            }
            return count;
        }, 0);
    }

    const defaultFieldCount = fieldConfigurations
        .filter(cfg => cfg.default)
        .length;
    const defaultHeight = 370;  // 初始高
    const unitHeight = 22;      // “减一行”就用 22px

    function computeNodeHeight(d) {
        /* ① 先判断是不是虚拟节点 —— 在 applyVirtualGrouping 里已经写了 isVirtual:true */
        if (d.data && d.data.isVirtual) {
            return 1;        // 只有 1 px 高；如果想稍微能看见，可改成 12、20 等
        }
        const currentCount = getFieldCount(d);
        const removed = defaultFieldCount - currentCount;
        const steps = Math.floor(Math.max(removed, 0) / 2);
        return defaultHeight - steps * unitHeight;
    }


    // 使用这个新版本完整替换旧的 displayChart 函数
    function displayChart(data) {

        // --- 核心修正：创建数据的“深拷贝”，彻底隔绝数据污染 ---
        // 这样无论后续D3库对数据做任何修改，都不会影响到我们的原始数据源
        const dataForChart = JSON.parse(JSON.stringify(data));

        console.log('进入了displayChart函数，开始绘制图表');
        if (!dataForChart || dataForChart.length === 0) {
            alert('没有找到有效的数据，请确认搜索条件');
            return;
        }

        // 清空上一次的图表，确保一个干净的画布
        document.querySelector('.chart-container').innerHTML = '';

        // 确保配置面板存在 (这部分逻辑不变)
        if (!document.getElementById('chart-config-container')) {
            createConfigPanel();
            const savedState = localStorage.getItem('configPanelState');
            if (savedState !== null) {
                isConfigPanelVisible = JSON.parse(savedState);
            }
            initializeFieldConfig();
            setupConfigActions();
            updatePanelVisibility();
        }

        // 初始化图表实例，注意这里传入的是深拷贝后的 dataForChart
        chart = new d3.OrgChart()
            .container('.chart-container')
            .data(dataForChart) // <--- 使用深拷贝的数据
            .nodeWidth((d) => 370)
            .initialZoom(0.7)

            .nodeHeight(computeNodeHeight)
            .childrenMargin((d) => 40)
            .compactMarginBetween((d) => 35)
            .compactMarginPair((d) => 80)
            .nodeContent(getNodeContent)


            .compact(true)
            .onExpandOrCollapse(node => {
                // 刚刚被“展开”的判定：有 children 且没有 _children
                const justExpanded = !!node.children && !node._children;
                // 刚刚被“收回”的判定：没有 children 且有 _children
                const justCollapsed = !node.children && !!node._children;

                // A) 禁止收回：如果被收回的就是“虚拟组”本身，立刻反向展开回来
                if (justCollapsed && node.data && node.data.isVirtual) {
                    node.children = node._children;
                    node._children = null;
                    chart.update(node);  // 立即刷新视图
                    //setTimeout(restyleVirtualNodeButtons, 0);
                    return;              // 直接返回，阻止后续逻辑
                }

                // B) 原有逻辑：当父节点被展开时，自动把它的“虚拟组”孩子也保持为展开态
                if (justExpanded && Array.isArray(node.children)) {
                    node.children.forEach(child => {
                        if (child.data && child.data.isVirtual && child._children) {
                            child.children = child._children;
                            child._children = null;
                        }
                    });
                    chart.update(node);
                    //setTimeout(restyleVirtualNodeButtons, 0);
                }
            })
            .render()

            .collapseAll();
        //setTimeout(restyleVirtualNodeButtons, 0);



    }






    function collapseToOneLevel() {
        // 确保图表已存在且有数据
        if (!chart || !data_by_position || data_by_position.length === 0) {
            alert('You should create a org chart before collapse');
            return;
        }

        // 1. 在当前图表数据中找到根节点 (parentId 为 null 的节点)
        const rootNode = data_by_position.find(d => d.parentId === null);

        if (!rootNode) {
            console.error("在当前图表中未找到根节点");
            return;
        }

        // 2. 调用图表库的 collapseAll 方法，收起所有节点
        chart.collapseAll();

        // 3. 接着调用 expand 方法，仅展开根节点，这样其+1级的子节点就会显示出来
        // d3-org-chart 库的 expand 方法会自动处理渲染和动画
        chart.expand(rootNode);
    }




    // 8. 修改DOMContentLoaded事件（确保配置面板在图表之后创建）
    document.addEventListener("DOMContentLoaded", function () {

        const addDataBtn = document.getElementById('addDataBtn');
        const addDataModal = document.getElementById('addDataModal');
        const cancelBtn = document.getElementById('cancelAddData');
        const confirmBtn = document.getElementById('confirmAddData');
        const dropdown = document.querySelector('.dropdown');
        const editBtn = document.getElementById('editBtn');
        const editMenu = document.getElementById('editMenu');
        const undoBtn = document.getElementById('undoAddBtn');
        const redoBtn = document.getElementById('redoAddBtn');
        const removeDataBtn = document.getElementById('removeDataBtn');
        const modifyDataBtn = document.getElementById('modifyDataBtn');
        const modifyDataModal = document.getElementById('modifyDataModal');
        const cancelModifyBtn = document.getElementById('cancelModifyData');
        const confirmModifyBtn = document.getElementById('confirmModifyData');
        const exportBtn = document.getElementById('exportCsvBtn');
        if (exportBtn) exportBtn.addEventListener('click', exportEditedDataCsv);

        undoBtn.onclick = undoLastAdd;
        redoBtn.onclick = redoLastAdd;
        removeDataBtn.onclick = removeNode;

        modifyDataBtn.onclick = initiateModifyNode;
        confirmModifyBtn.onclick = confirmModification;
        cancelModifyBtn.onclick = () => {
            modifyDataModal.classList.remove('open');
            nodeToModify = null; // 取消时清空
        };

        // 点击模态框背景也能关闭
        modifyDataModal.addEventListener('click', e => {
            if (e.target === modifyDataModal) {
                modifyDataModal.classList.remove('open');
                nodeToModify = null; // 取消时清空
            }
        });

        // 用更健壮的 handler 替换原先的简单打开行为
        addDataBtn.onclick = () => {
            try {
                const supervisorInput = document.getElementById('new_Reports_To_Position_Number');
                const positionInput = document.getElementById('new_Position_Number');

                // 如果 data_by_position 已存在并且是数组，找到当前视图的根节点
                if (typeof data_by_position !== 'undefined' && Array.isArray(data_by_position) && data_by_position.length > 0) {
                    const currentViewRoot = data_by_position.find(d => d.parentId === null);
                    if (currentViewRoot && currentViewRoot.id) {
                        // 预填 Supervisor Position Number
                        supervisorInput.value = currentViewRoot.id;
                    } else {
                        // 没找到根节点则清空（或可以保留上次值）
                        supervisorInput.value = '';
                    }
                } else {
                    // 没有 data_by_position（尚未渲染图表），默认清空
                    if (supervisorInput) supervisorInput.value = '';
                }

                // 打开模态框
                addDataModal.classList.add('open');

                // UX: 将焦点移到 Position Number 输入框，方便用户直接输入新条目
                if (positionInput) {
                    positionInput.focus();
                }
            } catch (err) {
                // 出错时仍保证模态框能打开，不阻塞用户
                console.warn('预填 Supervisor 失败：', err);
                addDataModal.classList.add('open');
            }
        };

        cancelBtn.onclick = () => { addDataModal.classList.remove('open'); };
        // 点击 Confirm 后收集数据、写入数组并重渲染
        confirmBtn.onclick = () => {
            addDataModal.classList.remove('open');
            const pos = document.getElementById('new_Position_Number').value.trim();
            const rpt = document.getElementById('new_Reports_To_Position_Number').value.trim();
            const nm = document.getElementById('new_Display_Name').value.trim();
            const pb = document.getElementById('new_Position_Band').value.trim();
            const sg = document.getElementById('new_Salary_Grade').value.trim();
            const cp = document.getElementById('new_Department_Descr_Short').value.trim();
            const pd = document.getElementById('new_Position_Descr').value.trim();
            const cc = document.getElementById('new_Cost_Center').value.trim();
            const fd = document.getElementById('new_FTE_Type_Funding_Status').value.trim();
            const rk = document.getElementById('new_Risk_Assessment').value.trim();
            const rm = document.getElementById('new_Mark_in_OrgChart').value.trim();
            const dt = document.getElementById('new_Effective_Date').value.trim();
            const pe = document.getElementById('new_Pos_Entry_Date').value.trim();
            const rm2 = document.getElementById('new_Remark_2').value.trim();
            const rm3 = document.getElementById('new_Remark_3').value.trim();
            if (!pos) {
                alert('Please enter Position Number');
                return;
            }
            if (!dt) {
                alert('Please enter Effective Date');
                return;
            }
            // 映射成和 CSV 导入时一致的格式
            const entry = {
                Position_Number: pos,
                Reports_To_Position_Number: rpt,
                id: pos,
                parentId: rpt,
                Display_Name: nm,
                Position_Band: pb,
                Salary_Grade: sg,
                Department_Descr_Short: cp,
                Position_Descr: pd,
                Cost_Center: cc,
                FTE_Type_Funding_Status: fd,
                Risk_Assessment: rk,
                Mark_in_OrgChart: rm,
                Effective_Date: dt,
                Pos_Entry_Date:pe,
                Remark_2: rm2,
                Remark_3: rm3,
                _uniqueId: `new-${Date.now()}` // 新增：为新条目生成唯一ID
            };
            // --- 核心修改 ---
            // 步骤 1: 修改“真实数据源” (editedData) 和撤销栈
            editedData.push(entry);
            // 将简单的条目推入改为推入一个带“action”标志的对象
            undoStack.push({ action: 'add', data: entry });
            redoStack.length = 0; // 清空重做栈
            // [新增] 在这里调用计算函数
            recalculateSubordinateCounts(editedData);

            initDateSlider();

            // 步骤 2: 触发视图的完全重建
            // 2a. 从上一次渲染的数据中 (data_by_position) 找到根节点，以确定当前视图是什么
            const currentViewRoot = data_by_position.find(d => d.parentId === null);
            if (!currentViewRoot) {
                alert("无法确定当前图表的根节点，无法刷新。");
                return;
            }

            // 2b. 使用根节点的ID，在“真实数据源”中找到对应的、未经转换的节点对象
            const rootNodeForRemount = editedData.find(d => d.id === currentViewRoot.id);

            // 2c. 以这个干净的根节点为起点，调用总的构建和显示函数
            //      这个函数会处理排序、虚拟分组等所有逻辑
            if (rootNodeForRemount) {
                buildAndDisplayChart(rootNodeForRemount);
            }

            // 步骤 3: 关闭弹窗并更新按钮状态


        };

        // 点击模态框背景也能关闭
        addDataModal.addEventListener('click', e => {
            if (e.target === addDataModal) addDataModal.classList.remove('open');
        });




        // 完整替换旧的 removeNode 函数
        function removeNode() {
            const positionToRemove = prompt("Please input Position Number to remove:");
            if (!positionToRemove || positionToRemove.trim() === '') {
                return;
            }

            const trimmedId = positionToRemove.trim();

            // 1. 在 editedData 中查找所有匹配的记录
            const matchedPersons = editedData.filter(d => d.id === trimmedId);

            // 2. 根据匹配数量执行不同操作
            if (matchedPersons.length === 0) {
                alert(`Cannot find this Position Number: "${trimmedId}"`);
                return;
            }

            if (matchedPersons.length === 1) {
                // 只有一个匹配项，直接执行删除
                performRemove(matchedPersons[0]);
            } else {
                // 有多个匹配项，调用选择函数，并将真正的删除逻辑作为回调传入
                promptUserToSelectRecord(matchedPersons, (selectedPerson) => {
                    performRemove(selectedPerson);
                });
            }
        }

        /**
         * 辅助函数：封装了实际的删除逻辑
         * @param {object} nodeToRemove - 经过用户确认的、要删除的唯一节点对象.
         */
        function performRemove(nodeToRemove) {

            const nodesToRemove = [nodeToRemove];

            // 存入撤销栈
            undoStack.push({ action: 'remove', data: nodesToRemove });
            redoStack.length = 0;

            // 新的正确代码：直接判断对象引用是否在待删除列表中，确保唯一性
            editedData = editedData.filter(d => !nodesToRemove.includes(d));

            // 重新计算并刷新图表
            recalculateSubordinateCounts(editedData);

            const currentViewRoot = data_by_position.find(d => d.parentId === null);
            if (!currentViewRoot) {
                alert("Cannot find current root node, unable to refresh.");
                return;
            }

            const rootNodeForRemount = editedData.find(d => d.id === currentViewRoot.id);
            if (rootNodeForRemount) {
                buildAndDisplayChart(rootNodeForRemount);
            } else {
                document.querySelector('.chart-container').innerHTML = '';
                alert("The root node of the chart has been removed.");
            }
        }
        /**
       * 启动修改流程的函数
       */
        function initiateModifyNode() {
            const positionToModify = prompt("Please input Position Number to modify:");
            if (!positionToModify || positionToModify.trim() === '') {
                return;
            }

            const trimmedId = positionToModify.trim();

            // 1. 查找所有匹配记录
            const matchedPersons = editedData.filter(d => d.id === trimmedId);

            // 2. 根据匹配数量执行不同操作
            if (matchedPersons.length === 0) {
                alert(`Cannot find Position Number: "${trimmedId}"`);
                return;
            }

            if (matchedPersons.length === 1) {
                // 只有一个匹配项，直接打开修改框
                populateAndShowModifyModal(matchedPersons[0]);
            } else {
                // 有多个匹配项，调用选择函数，并将打开修改框的逻辑作为回调
                promptUserToSelectRecord(matchedPersons, (selectedPerson) => {
                    populateAndShowModifyModal(selectedPerson);
                });
            }
        }

        /**
         * 辅助函数：封装了填充并显示修改模态框的逻辑
         * @param {object} node - 经过用户确认的、要修改的唯一节点对象.
         */
        function populateAndShowModifyModal(node) {
            nodeToModify = node; // 将找到的节点存储在全局变量中

            // 获取模态框及其所有输入字段
            const modal = document.getElementById('modifyDataModal');
            document.getElementById('modify_Position_Number').value = node.Position_Number || '';
            document.getElementById('modify_Effective_Date').value = node.Effective_Date || '';
            document.getElementById('modify_Reports_To_Position_Number').value = node.Reports_To_Position_Number || '';
            document.getElementById('modify_Display_Name').value = node.Display_Name || '';
            document.getElementById('modify_Position_Band').value = node.Position_Band || '';
            document.getElementById('modify_Salary_Grade').value = node.Salary_Grade || '';
            document.getElementById('modify_Department_Descr_Short').value = node.Department_Descr_Short || '';
            document.getElementById('modify_Position_Descr').value = node.Position_Descr || '';
            document.getElementById('modify_Cost_Center').value = node.Cost_Center || '';
            document.getElementById('modify_FTE_Type_Funding_Status').value = node.FTE_Type_Funding_Status || '';
            document.getElementById('modify_Risk_Assessment').value = node.Risk_Assessment || '';
            document.getElementById('modify_Pos_Entry_Date').value = node.Pos_Entry_Date || '';
            document.getElementById('modify_Mark_in_OrgChart').value = node.Mark_in_OrgChart || '';
            document.getElementById('modify_Remark_2').value = node.Remark_2 || '';
            document.getElementById('modify_Remark_3').value = node.Remark_3 || '';

            // 显示模态框
            modal.classList.add('open');
        }

        /**
         * 确认修改并更新数据的函数
         */
        function confirmModification() {
            if (!nodeToModify) return;

            // 1. 为 Undo/Redo 保存节点的旧状态 (深拷贝)
            const oldNodeData = JSON.parse(JSON.stringify(nodeToModify));

            // 2. 从模态框读取新数据并更新节点对象
            //    由于 nodeToModify 是 editedData 中对象的引用，直接修改它即可
            nodeToModify.Effective_Date = document.getElementById('modify_Effective_Date').value;
            nodeToModify.Reports_To_Position_Number = document.getElementById('modify_Reports_To_Position_Number').value;
            nodeToModify.parentId = document.getElementById('modify_Reports_To_Position_Number').value; // 确保 parentId 也更新
            nodeToModify.Display_Name = document.getElementById('modify_Display_Name').value;
            nodeToModify.Position_Band = document.getElementById('modify_Position_Band').value;
            nodeToModify.Salary_Grade = document.getElementById('modify_Salary_Grade').value;
            nodeToModify.Department_Descr_Short = document.getElementById('modify_Department_Descr_Short').value;
            nodeToModify.Position_Descr = document.getElementById('modify_Position_Descr').value;
            nodeToModify.Cost_Center = document.getElementById('modify_Cost_Center').value;
            nodeToModify.FTE_Type_Funding_Status = document.getElementById('modify_FTE_Type_Funding_Status').value;
            nodeToModify.Risk_Assessment = document.getElementById('modify_Risk_Assessment').value;
            nodeToModify.Pos_Entry_Date = document.getElementById('modify_Pos_Entry_Date').value;
            nodeToModify.Mark_in_OrgChart = document.getElementById('modify_Mark_in_OrgChart').value;
            nodeToModify.Remark_2 = document.getElementById('modify_Remark_2').value;
            nodeToModify.Remark_3 = document.getElementById('modify_Remark_3').value;

            // 3. 为 Undo/Redo 保存节点的新状态 (深拷贝)
            const newNodeData = JSON.parse(JSON.stringify(nodeToModify));

            // 4. 将“修改”操作推入撤销栈
            undoStack.push({ action: 'modify', oldData: oldNodeData, newData: newNodeData });
            redoStack.length = 0; // 清空重做栈

            // [新增] 在这里调用计算函数
            recalculateSubordinateCounts(editedData);

            initDateSlider();

            // 5. 关闭模态框并重置全局变量
            document.getElementById('modifyDataModal').classList.remove('open');
            nodeToModify = null;

            // 6. 重新渲染图表
            const currentViewRoot = data_by_position.find(d => d.parentId === null);
            if (currentViewRoot) {
                const rootNodeForRemount = editedData.find(d => d.id === currentViewRoot.id);
                if (rootNodeForRemount) {
                    buildAndDisplayChart(rootNodeForRemount);
                }
            }
        }

        // 原有的搜索框事件监听...

        // 确保在页面加载时初始化配置
        if (!document.getElementById('chart-config-container')) {
            createConfigPanel();

            // 从localStorage加载面板状态
            const savedState = localStorage.getItem('configPanelState');
            if (savedState !== null) {
                isConfigPanelVisible = JSON.parse(savedState);
            }

            initializeFieldConfig();
            setupConfigActions();
            updatePanelVisibility(); // 应用初始状态
        }



        // 点击 Edit 按钮，切换菜单显示/隐藏
        editBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // 阻止事件冒泡到 document
            dropdown.classList.toggle('open');
        });

        // 点击页面其它地方时自动收起菜单
        document.addEventListener('click', () => {
            dropdown.classList.remove('open');
        });

        // ▼▼▼ 新增的核心代码 ▼▼▼
        /**
         * @description 使用一个只包含表头的CSV字符串来初始化应用
         */
        function initializeWithEmptyData() {
            // 定义一个“空”的CSV，只包含必要的列标题
            const emptyCsvHeaders = "Position_Number,Reports_To_Position_Number,Display_Name,Position_Descr,Department_Descr_Short,Position_Band,Salary_Grade,FTE_Type_Funding_Status,Cost_Center,Risk_Assessment,Pos_Entry_Date,Mark_in_OrgChart,Remark_2,Remark_3,Effective_Date";

            // 使用这个空数据来处理和初始化应用状态
            processCsvData(emptyCsvHeaders);
        }

        // 页面加载后立即执行初始化
        initializeWithEmptyData();
        // ▲▲▲ 新增的核心代码 ▲▲▲


    });

    function undoLastAdd() {
        if (undoStack.length === 0) {
            alert("No more undo");
            return;
        }

        const lastAction = undoStack.pop();
        redoStack.push(lastAction);

        switch (lastAction.action) {
            case 'add':
                // 修改：使用 _uniqueId 来精确查找并删除
                const indexToRemove = editedData.findIndex(d => d._uniqueId === lastAction.data._uniqueId);
                if (indexToRemove > -1) editedData.splice(indexToRemove, 1);
                break;

            case 'remove':
                editedData.push(...lastAction.data);
                break;

            case 'modify':
                // 修改：使用 _uniqueId 来查找要恢复的节点
                const nodeToRestore = editedData.find(d => d._uniqueId === lastAction.oldData._uniqueId);
                if (nodeToRestore) {
                    // 用旧数据覆盖它
                    Object.assign(nodeToRestore, lastAction.oldData);
                }
                break;
        }

        // [新增] 在这里调用计算函数
        recalculateSubordinateCounts(editedData);

        initDateSlider();

        // 完全重建视图
        const currentViewRoot = data_by_position.find(d => d.parentId === null);
        if (!currentViewRoot) return;

        const rootNodeForRemount = editedData.find(d => d.id === currentViewRoot.id);
        if (rootNodeForRemount) {
            buildAndDisplayChart(rootNodeForRemount);
        } else {
            const restoredRoot = lastAction.action === 'remove' ? lastAction.data.find(d => d.id === currentViewRoot.id) : null;
            if (restoredRoot) buildAndDisplayChart(restoredRoot);
        }
    }

    function redoLastAdd() {
        if (redoStack.length === 0) {
            alert("No more redo");
            return;
        }

        const actionToRedo = redoStack.pop();
        undoStack.push(actionToRedo);

        switch (actionToRedo.action) {
            case 'add':
                editedData.push(actionToRedo.data);
                break;

            case 'remove':
                // 修改：创建一个包含所有待删除项 _uniqueId 的 Set
                const idsToRemove = new Set(actionToRedo.data.map(n => n._uniqueId));
                // 修改：根据 _uniqueId 进行过滤，确保只删除正确的记录
                editedData = editedData.filter(d => !idsToRemove.has(d._uniqueId));
                break;

            case 'modify':
                // 修改：使用 _uniqueId 来查找要更新的节点
                const nodeToUpdate = editedData.find(d => d._uniqueId === actionToRedo.newData._uniqueId);
                if (nodeToUpdate) {
                    // 用新数据覆盖它
                    Object.assign(nodeToUpdate, actionToRedo.newData);
                }
                break;
        }

        // [新增] 在这里调用计算函数
        recalculateSubordinateCounts(editedData);

        initDateSlider();

        // 完全重建视图
        const currentViewRoot = data_by_position.find(d => d.parentId === null);
        if (!currentViewRoot) return;

        const rootNodeForRemount = editedData.find(d => d.id === currentViewRoot.id);
        if (rootNodeForRemount) {
            buildAndDisplayChart(rootNodeForRemount);
        } else {
            document.querySelector('.chart-container').innerHTML = '';
            alert("Root node removed");
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("searchInput").addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
                if (!uploadedData) {
                    alert('Please upload data');
                    return;
                }
                searchPerson(); // 确保此函数已定义
            }
        });
    });




    // 自定义通知函数（可选，如需保留原生alert可删除）
    function showNotification(message, type = 'info') {
        // 实现与之前相同...
    }
    //控制收缩与展开
    function toggleContainer() {
        const container = document.getElementById('collapsibleContainer');
        const button = document.querySelector('button[onclick="toggleContainer()"]');

        // 通过切换 class 来控制状态
        const isCollapsed = container.classList.toggle('collapsed');

        if (isCollapsed) {
            button.textContent = "▼ Expand";
        } else {
            button.textContent = "▲";
        }
    }

    function formatDate(date) {
        return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
    }

    // 替换旧的 initDateSlider 函数
    function initDateSlider() {
        // 注意：现在我们从 editedData (完整数据源) 中提取日期
        if (!editedData || editedData.length === 0) {
            console.error('No data available for date slider');
            return;
        }

        const today = new Date();
        const todayFormatted = formatDate(today);
        const toDate = (dateStr) => new Date(dateStr.replace(/\//g, '-'));

        // 从 editedData 提取所有不重复的未来日期
        const futureDates = [...new Set(
            editedData
                .map(item => item.Effective_Date ? item.Effective_Date.split(' ')[0] : null)
                .filter(date => date && toDate(date) > toDate(todayFormatted))
        )];

        // 将今天和未来日期合并并排序
        dateValues = [todayFormatted, ...futureDates].sort((a, b) => toDate(a) - toDate(b));

        const slider = document.getElementById('dateRange');
        const output = document.getElementById('dateValue');

        slider.min = 0;
        slider.max = dateValues.length - 1;
        slider.value = 0; // 默认值设为今天

        updateDateDisplay(slider.value, true); // 首次加载不重绘图表

        // 移除旧的事件监听器，避免重复绑定
        const newSlider = slider.cloneNode(true);
        slider.parentNode.replaceChild(newSlider, slider);

        // 监听滑块变化，触发完整的图表重绘
        newSlider.addEventListener('input', function () {
            updateDateDisplay(this.value, false); // 滑动时需要重绘
        });

        // 如果没有未来日期，则禁用滑块
        if (dateValues.length <= 1) {
            newSlider.disabled = false;
            output.style.color = '#fff';
            output.title = 'No future data available';
        } else {
            newSlider.disabled = false;
            output.style.color = '#fff';
            output.title = '';
        }
    }

    // 替换旧的 updateDateDisplay 函数
    function updateDateDisplay(index, isInitialLoad = false) {
        const output = document.getElementById('dateValue');
        const selectedDate = dateValues[index];

        if (selectedDate) {
            output.textContent = selectedDate;

            // 如果不是首次加载，则重绘图表
            if (!isInitialLoad) {
                // 找到当前视图的根节点，然后用新日期重绘
                const currentViewRoot = data_by_position.find(d => d.parentId === null);
                if (currentViewRoot) {
                    const rootNodeForRemount = editedData.find(d => d.id === currentViewRoot.id);
                    if (rootNodeForRemount) {
                        buildAndDisplayChart(rootNodeForRemount);
                    }
                }
            }
        }
    }

    // 请删除旧的 filterDataByDate 函数，它不再被需要。


    function printChart() {
        const chartContainer = document.querySelector('.chart-container');

        if (!chartContainer) {
            alert("No content！");
            return;
        }

        // 打开浏览器的打印对话框
        window.print();
    }


    /*
      function toggleCompact() {
        if (!chart) return;          // chart 还没初始化就直接返回
    
        const nowCompact = chart.compact();     // 读取当前状态
        chart.compact(!nowCompact).render();    // 切换并重新渲染
    
        // 改一下按钮文字（可选）
        const btn = document.getElementById('swapLayoutBtn');
        btn.textContent = nowCompact ? 'Vertical' : 'Horizontal';
      }*/

    function exportEditedDataCsv() {
        if (!Array.isArray(editedData) || !editedData.length) {
            alert('No data'); return;
        }
        // 过滤掉虚拟子节点
        const rows = editedData.filter(r => !r.isVirtual);

        if (!rows.length) { alert('No data'); return; }

        // 可选：指定列顺序；不指定则 d3 会按对象 key 顺序导出
        const columns = [
            "Position_Number", "Reports_To_Position_Number", "Display_Name", "Position_Descr",
            "Department_Descr_Short", "Position_Band", "Salary_Grade", "FTE_Type_Funding_Status",
            "Cost_Center", "Risk_Assessment","Pos_Entry_Date", "Mark_in_OrgChart", "Remark_2", "Remark_3",
            "Effective_Date", "id", "parentId", "Span_of_Control", "Direct_Report", "Staffs"
        ].filter(c => rows.some(r => Object.prototype.hasOwnProperty.call(r, c)));

        const csv = d3.csvFormat(rows, columns); // ← 官方格式化函数（d3-dsv）

        const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `editedData-${new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-')}.csv`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    /**
   * 递归辅助函数：计算一个节点下的所有后代（直接+间接）总数
   * @param {string} parentId - 要计算的父节点的 ID
   * @param {Array} dataArray - 完整的数据源数组 (editedData)
   * @returns {number} - 后代总数
   */
    function countAllDescendants(parentId, dataArray) {
        // 找到所有直接子节点 (非虚拟节点)
        const directChildren = dataArray.filter(d => !d.isVirtual && d.parentId === parentId);
        let count = directChildren.length;
        // 对每个子节点，递归地加上它自己的后代数量
        for (const child of directChildren) {
            count += countAllDescendants(child.id, dataArray);
        }
        return count;
    }

    /**
     * 主函数：为整个数据集重新计算 Direct_Report, Staffs 和 Span_of_Control 数量
     * 这个函数会直接修改传入数组中对象的属性
     * @param {Array} dataArray - 完整的数据源数组 (editedData)
     */
    function recalculateSubordinateCounts(dataArray) {
        // --- 第一部分：计算 Direct_Report 和 Staffs ---
        const directReportMap = new Map();
        dataArray.forEach(d => {
            // 过滤掉虚拟节点，它们不应被计入
            if (d.isVirtual) return;
            if (d.parentId) {
                directReportMap.set(d.parentId, (directReportMap.get(d.parentId) || 0) + 1);
            }
        });

        dataArray.forEach(person => {
            if (person.isVirtual) return;
            const personId = person.id;
            person.Direct_Report = directReportMap.get(personId) || 0;

            // [修改点 1] 字段名从 _totalSubordinates 改为 Staffs
            person.Staffs = countAllDescendants(personId, dataArray);
        });

        // --- 第二部分：根据您的特殊逻辑计算 Span_of_Control ---
        dataArray.forEach(person => {
            if (person.isVirtual) return;

            const applicableBands = ['B', '1', '2', '3', '4'];

            // [修改点 2] 应用新的计算逻辑
            // 判断当前节点的 Position_Band 是否在需要特殊计算的范围内
            if (applicableBands.includes(person.Position_Band)) {
                let sumOfALStaffs = 0;
                // 找到所有 Position_Band 为 'AL' 的直接子节点
                const directALChildren = dataArray.filter(d =>
                    !d.isVirtual && d.parentId === person.id && d.Position_Band === 'AL'
                );

                // 累加这些 'AL' 子节点的 Staffs 数量
                directALChildren.forEach(child => {
                    // 使用在第一部分中已经为每个节点计算好的 Staffs 值
                    sumOfALStaffs += (child.Staffs || 0);
                });

                // 最终结果是 AL 子节点 Staffs 总和 + 父节点自身的直接下属数量
                person.Span_of_Control = sumOfALStaffs + person.Direct_Report;
            } else {
                // 对于其他 Position_Band (例如 'AL' 节点自身)，Span_of_Control 等于 Direct_Report
                person.Span_of_Control = 0;
            }
        });
    }
    /*
    // 调淡虚拟子节点的展开/收回按钮样式
    function restyleVirtualNodeButtons() {
      const LIGHT = '#ffffff';        // 浅灰色
      const OPACITY = 1;           // 透明度
      const THIN = '1';               // 更细的线宽
  
      // d3-org-chart 每个节点是 .node 分组，按钮在其中的 .node-button-div
      d3.selectAll('.node').each(function (d) {
        const isVirtual = d && d.data && d.data.isVirtual;
        const btnDiv = d3.select(this).select('.node-button-div');
        if (btnDiv.empty()) return;
  
        const btnSvg = btnDiv.select('svg');
  
        if (isVirtual) {
          // 背景与整体透明度更淡
          btnDiv.style('background', 'transparent')
            .style('opacity', OPACITY);
  
          // 覆盖图标颜色（需要 important 才能压过全局 !important）
          btnSvg.style('opacity', OPACITY);
          btnSvg.selectAll('*').each(function () {
            this.style.setProperty('stroke', LIGHT, 'important');
            this.style.setProperty('fill', LIGHT, 'important');
            this.style.setProperty('stroke-width', THIN, 'important');
          });
        } else {
          // 非虚拟节点恢复默认（移除覆盖，交由全局 CSS 控制）
          btnDiv.style('background', null)
            .style('opacity', null);
          btnSvg.style('opacity', null);
          btnSvg.selectAll('*').each(function () {
            this.style.removeProperty('stroke');
            this.style.removeProperty('fill');
            this.style.removeProperty('stroke-width');
          });
        }
      });
    }*/

    /**
   * 根据选定日期，从主数据源(editedData)生成用于图表展示的干净数据。
   * @param {string} selectedDate - YYYY/MM/DD 格式的日期字符串.
   * @returns {Array} - 经过筛选和去重后的数据数组，可直接用于渲染.
   */
    function getViewDataForDate(selectedDate) {
        if (!editedData || editedData.length === 0) {
            return [];
        }

        const selectedDateObj = new Date(selectedDate.replace(/\//g, '-'));

        // 1. 筛选出所有生效日期早于或等于选定日期的数据
        const historicallyValidData = editedData.filter(item => {
            if (!item.Effective_Date || item.isVirtual) { // 忽略虚拟节点和无效日期
                return item.isVirtual; // 虚拟节点直接通过
            }
            const itemDateObj = new Date(item.Effective_Date.split(' ')[0].replace(/\//g, '-'));
            return itemDateObj <= selectedDateObj;
        });

        // 2. 处理重复的 Position_Number，只保留最新的记录
        const uniquePositions = new Map();
        historicallyValidData.forEach(item => {
            // 虚拟节点没有Position_Number, 直接跳过
            if (item.isVirtual) return;

            const existing = uniquePositions.get(item.Position_Number);
            if (!existing) {
                uniquePositions.set(item.Position_Number, item);
            } else {
                const existingDate = new Date(existing.Effective_Date.split(' ')[0].replace(/\//g, '-'));
                const itemDate = new Date(item.Effective_Date.split(' ')[0].replace(/\//g, '-'));
                // 如果当前项的日期比已存项的日期更新，则替换它
                if (itemDate > existingDate) {
                    uniquePositions.set(item.Position_Number, item);
                }
            }
        });

        // 3. 将虚拟节点重新加回来 (如果它们存在于筛选后的数据中)
        const virtualNodes = historicallyValidData.filter(item => item.isVirtual);

        // 返回去重后的唯一职位数据数组，并合并虚拟节点
        return [...uniquePositions.values(), ...virtualNodes];
    }

    /**
   * 当找到多个匹配记录时，弹出一个模态框让用户选择。
   * @param {Array} records - 找到的多个匹配记录数组.
   * @param {function} onSelectCallback - 用户选择一个记录后要执行的回调函数. 这个函数会接收被选中的记录对象作为参数.
   */
    function promptUserToSelectRecord(records, onSelectCallback) {
        const modal = document.getElementById('selectionModal');
        const choicesContainer = document.getElementById('selectionChoices');
        const modalTitle = document.getElementById('selectionModalTitle');

        // 1. 设置标题并清空旧选项
        modalTitle.textContent = 'Found multiple records. Please choose one:';
        choicesContainer.innerHTML = '';

        // 2. 动态创建新选项，这次要包含 Effective_Date
        records.forEach(person => {
            const choiceElement = document.createElement('div');
            choiceElement.className = 'selection-choice';
            // 使用一个唯一的组合键（如 ID + Date）或直接用索引来查找
            choiceElement.dataset.id = person.Position_Number;
            choiceElement.dataset.date = person.Effective_Date; // 存储日期用于精确查找

            // 在显示内容中加入生效日期
            choiceElement.innerHTML = `
      <h4>${person.Display_Name} (ID: ${person.Position_Number})</h4>
      <p><strong>Effective Date: ${person.Effective_Date.split(' ')[0]}</strong></p> <p>${person.Position_Descr}</p>
    `;

            // 3. 为每个选项添加点击事件
            choiceElement.addEventListener('click', () => {
                // 精确找到用户点击的那条记录
                const selectedPerson = records.find(d =>
                    d.Position_Number === choiceElement.dataset.id &&
                    d.Effective_Date === choiceElement.dataset.date
                );

                if (selectedPerson) {
                    // 执行传入的回调函数，把选中的记录传给它
                    onSelectCallback(selectedPerson);
                }
                modal.style.display = 'none'; // 关闭模态框
            });

            choicesContainer.appendChild(choiceElement);
        });

        // 4. 显示模态框
        modal.style.display = 'flex';
    }

    /**
 * @description 接收CSV文本，解析并初始化整个应用
 * @param {string} csvText - CSV格式的字符串
 */
    function processCsvData(csvText) {
        const data = d3.csvParse(csvText);
        let uniqueIdCounter = 0;

        uploadedData = data.map(d => {
            // ... (这里是您 handleFileUpload 函数中所有处理 d.Position_Band 和 return 对象的代码，完全不变)
            switch (d.Position_Band) {
                case '001': d.Position_Band = '1'; break;
                case '1': d.Position_Band = '1'; break;
                case '002': d.Position_Band = '2'; break;
                case '2': d.Position_Band = '2'; break;
                case '003': d.Position_Band = '3'; break;
                case '3': d.Position_Band = '3'; break;
                case '004': d.Position_Band = '4'; break;
                case '4': d.Position_Band = '4'; break;
                case 'B': d.Position_Band = 'B'; break;
                default: d.Position_Band = 'AL';
            }
            return {
                ...d,
                id: d.Position_Number,
                parentId: d.Reports_To_Position_Number,
                _uniqueId: `csv-${uniqueIdCounter++}`
            };
        });

        // 将处理后的数据保存到全局变量
        originalData = JSON.parse(JSON.stringify(uploadedData));
        editedData = JSON.parse(JSON.stringify(uploadedData));
        globalData = [...uploadedData];

        // 更新主页统计和图表
        updateHomepageStats();
        const positionBandData = aggregateDataByField(originalData, 'Position_Band');
        if (positionBandData.length > 0) {
            createPieChart('#position-band-chart-container', positionBandData);
        }
        const entityData = aggregateDataByField(originalData, 'Company_Descr_Short');
        if (entityData.length > 0) {
            createPieChart('#entity-chart-container', entityData);
        }

        // 初始化日期滑块
        initDateSlider();

        // 清空图表区域和旧数据，为用户操作做准备
        document.querySelector('.chart-container').innerHTML = '<div style="color: #fff; text-align: center; padding-top: 50px;"></div>';
        data_by_position = null;
    }

    /*function exportChartAsPDF() {
    if (!chart) {
      alert("Please generate a chart first before exporting!");
      return;
    }

    // Use the chart's built-in export function which leverages html2canvas
    chart.exportImg({
      save: false, // We don't want to trigger a browser download of the image
      full: true, // Capture the entire chart, not just the visible part
      onLoad: (base64) => {
        // The onLoad callback receives the chart as a base64 encoded image
        const pdf = new jspdf.jsPDF({
          orientation: 'landscape', // The chart is usually wider than it is tall
        });
        const img = new Image();
        img.src = base64;

        img.onload = function () {
          const imgWidth = img.width;
          const imgHeight = img.height;

          // PDF page dimensions in the current orientation (landscape)
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = pdf.internal.pageSize.getHeight();

          // Maintain aspect ratio, leaving a 5pt margin on each side
          const ratio = Math.min((pdfWidth - 10) / imgWidth, (pdfHeight - 10) / imgHeight);

          const newImgWidth = imgWidth * ratio;
          const newImgHeight = imgHeight * ratio;

          // Center the image
          const marginX = (pdfWidth - newImgWidth) / 2;
          const marginY = (pdfHeight - newImgHeight) / 2;

          pdf.addImage(
            img,
            'PNG',
            marginX,
            marginY,
            newImgWidth,
            newImgHeight
          );
          pdf.save('organization-chart.pdf');
        };

        img.onerror = function () {
          alert("An error occurred while loading the chart image for PDF export.");
        }
      },
    });
  }*/



</script>

<body>
    <div class="bg-shapes">
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
    </div>

    <!-- SINGLE NAVIGATION HEADER -->
    <header>
        <div class="container">
            <nav class="glass">
                <div class="logo" onclick="showPage('home')">
                    <div class="logo-icon">
                        <img src="images/ORG.png" alt="Org Vision logo" style="width:75px;height:auto;display:block;">
                    </div>
                    <svg width="100%" height="100" viewBox="0 0 900 100" xmlns="http://www.w3.org/2000/svg" role="img"
                        aria-label="Animated gradient ORG VISION CANVAS">
                        <defs>
                            <linearGradient id="g-anim" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" stop-color="#1a9fe2" />
                                <stop offset="50%" stop-color="#0b63c8" />
                                <stop offset="100%" stop-color="#1a9fe2" />
                                <!-- 用 animateTransform 让渐变移动（兼容性好） -->
                                <animate attributeName="x1" values="0%;-50%;0%" dur="3s" repeatCount="indefinite" />
                                <animate attributeName="x2" values="100%;50%;100%" dur="3s" repeatCount="indefinite" />
                            </linearGradient>
                        </defs>

                        <text x="0" y="70" font-family="'Segoe UI', Tahoma, Verdana" font-size="50" font-weight="640"
                            fill="url(#g-anim)">
                            ORG VISION CANVAS
                        </text>
                    </svg>


                </div>
                <div class="nav-links">
                    <a href="#" onclick="showPage('home')" class="active">Home</a>
                    <a href="#" onclick="showPage('Canvas')">Canvas</a>

                    <a href="#" onclick="showPage('Guidance')">Guidance</a>
                </div>
            </nav>
        </div>
    </header>

    <!-- HOME PAGE -->
    <div id="home" class="page active">
        <div class="container">
            <div class="content-wrapper">
                <section class="hero glass">
                    <div class="hero-image">
                        <img src="images/templatemo-futuristic-girl.jpg" alt="Modern Technology Interaction" />
                    </div>
                    <div class="hero-content">
                        <h1>Welcome to ORG VISION CANVAS</h1>
                        <p>ORG VISION CANVAS — interactive, zoomable org charts that turn your org into a living map: inspect hierarchy, positions instantly.</p>
                        <button onclick="document.getElementById('fileInput').click()" class="cta-button-home">
                            Upload
                        </button>
                    </div>

                </section>

                <section class="stats">
                    <div class="stat-card glass">
                        <div class="stat-number">Null</div>
                        <div class="stat-label">Total Positions</div>
                    </div>
                    <div class="stat-card glass">
                        <div class="stat-number">Null</div>
                        <div class="stat-label">Vacant Positions</div>
                    </div>
                    <div class="stat-card glass">
                        <div class="stat-number">Null</div>
                        <div class="stat-label">Vacancy Rate</div>
                    </div>

                </section>
                <section class="services-grid">
                    <div class="service-card glass">
                        <div id="position-band-chart-container" class="service-header">
                            <h3>Position Pand</h3>
                        </div>
                    </div>
                    <div class="service-card glass">
                        <div id="entity-chart-container" class="service-header">
                            <h3>Entity</h3>
                        </div>
                    </div>

                </section>

            </div>
        </div>
    </div>

    <!-- Canvas PAGE -->
    <div id="Canvas" class="page">

        <script src="./libs/d3.min.js"></script>
        <script src="./libs/d3-flextree.min.js"></script>
        <script src="./libs/d3-org-chart.min.js"></script>
        <script src="https://unpkg.com/html2canvas@1.1.4/dist/html2canvas.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>


        <div class="toolbar">


            <!-- ▼ 新增：Collect Collapse 按钮 -->
            <!--<button id="swapLayoutBtn" onclick="toggleCompact()" class="btn btn-secondary">Horizontal</button>-->

            <!--
            <div class="toolbar-controls">
                <button onclick="toggleContainer()" class="cta-button">▲</button>-->

            <button onclick="document.getElementById('fileInput').click()" class="cta-button">
                Upload
            </button>

            <input type="file" id="fileInput" accept=".csv" style="display: none" onchange="handleFileUpload(event)" />

            <input id="searchInput" type="text" placeholder="Name or Position Number" class="cta-SearchInput">
            <style>
                /* 临时覆盖，仅作用于带 id 的这个输入框 */
                #searchInput::placeholder {
                    color: #ffffff;
                    opacity: 1;
                }
            </style>


            <button onclick="searchPerson()" class="cta-button">
                Create
            </button>
            <div style="flex: 1;"></div>
            <button id="collapseToOneLevelBtn" onclick="collapseToOneLevel()" class="cta-button">Collapse All</button>

            <div class="cta-button">
                <label for="dateRange">Future Date:</label>
                <input type="range" id="dateRange" min="0" max="1000" value="500">
                <output id="dateValue">No Data</output>
            </div>
            <button onclick="chart.fit()" class="cta-button">Auto Layout</button>
            <div style="flex: 1;"></div>


            <div class="dropdown">
                <button id="editBtn" class="cta-button">Edit ▼</button>
                <div id="editMenu" class="dropdown-content">
                    <button id="addDataBtn" class="cta-button">Add New</button>
                    <button id="removeDataBtn" class="cta-button">Remove</button>
                    <button id="modifyDataBtn" class="cta-button">Modify</button>
                    <button id="undoAddBtn" class="cta-button">Undo</button>
                    <button id="redoAddBtn" class="cta-button">Redo</button>
                </div>
            </div>
            <button id="exportCsvBtn" class="cta-button">Export Data</button>



            <button onclick="printChart()" class="cta-button">Print</button>


        </div>

        <div id="addDataModal" class="modal ">
            <div class="modal-content">
                <h3>Add Person</h3>
                <div class="form-group"><label for="new_Position_Number">Position Number</label><input
                        id="new_Position_Number" type="text" placeholder="e.g.,CND00003"></div>
                <div class="form-group"><label for="new_Pos_Entry_Date">Pos.Entry Date</label><input
                        id="new_Pos_Entry_Date" type="text" placeholder="e.g.,YYYY-MM-DD"></div>
                        <div class="form-group"><label for="new_Effective_Date">Effective Date</label><input
                        id="new_Effective_Date" type="text" placeholder="e.g.,YYYY-MM-DD"></div>
                <div class="form-group"><label for="new_Reports_To_Position_Number">Supervisor Position
                        Number</label><input id="new_Reports_To_Position_Number" type="text"
                        placeholder="e.g., CND00001">
                </div>
                <div class="form-group"><label for="new_Display_Name">Name</label><input id="new_Display_Name"
                        type="text" placeholder="e.g., Tom"></div>
                <div class="form-group"><label for="new_Position_Band">Position Band</label><input
                        id="new_Position_Band" type="text" placeholder="e.g., PB3"></div>
                <div class="form-group"><label for="new_Salary_Grade">Salary Grade</label><input id="new_Salary_Grade"
                        type="text" placeholder="e.g., PG5"></div>
                <div class="form-group"><label for="new_Department_Descr_Short">Company</label><input
                        id="new_Department_Descr_Short" type="text" placeholder="e.g., BMBS"></div>
                <div class="form-group"><label for="new_Position_Descr">Position Descr</label><input
                        id="new_Position_Descr" type="text" placeholder="e.g., President"></div>
                <div class="form-group"><label for="new_Cost_Center">Cost Center</label><input id="new_Cost_Center"
                        type="text" placeholder="e.g., 10900771"></div>
                <div class="form-group"><label for="new_FTE_Type_Funding_Status">Funding</label><input
                        id="new_FTE_Type_Funding_Status" type="text" placeholder="e.g., BMBS"></div>
                <div class="form-group"><label for="new_Risk_Assessment">Risk</label><input id="new_Risk_Assessment"
                        type="text" placeholder="e.g., Compulsory"></div>
                <div class="form-group"><label for="new_Mark_in_OrgChart">Remark</label><input id="new_Mark_in_OrgChart"
                        type="text" placeholder="e.g.,New"></div>
                <div class="form-group"><label for="new_Remark_2">Remark 2</label><input id="new_Remark_2" type="text">
                </div>
                <div class="form-group"><label for="new_Remark_3">Remark 3</label><input id="new_Remark_3" type="text">
                </div>

                <div class="modal-buttons">
                    <button id="cancelAddData" class="cta-button">Cancel</button>
                    <button id="confirmAddData" class="cta-button">Confirm</button>
                </div>
            </div>
        </div>

        <div id="modifyDataModal" class="modal">
            <div class="modal-content">
                <h3>Modify Person</h3>
                <div class="form-group"><label for="modify_Position_Number">Position Number</label><input
                        id="modify_Position_Number" type="text" readonly style="background-color: #555;"></div>
                <div class="form-group"><label for="modify_Pos_Entry_Date">Pos.Entry Date</label><input
                        id="modify_Pos_Entry_Date" type="text" placeholder="e.g.,YYYY-MM-DD"></div>
                <div class="form-group"><label for="modify_Effective_Date">Effective Date</label><input
                        id="modify_Effective_Date" type="text" placeholder="e.g.,YYYY-MM-DD"></div>
                <div class="form-group"><label for="modify_Reports_To_Position_Number">Supervisor Position
                        Number</label><input id="modify_Reports_To_Position_Number" type="text"
                        placeholder="e.g.,CND00001">
                </div>
                <div class="form-group"><label for="modify_Display_Name">Name</label><input id="modify_Display_Name"
                        type="text" placeholder="e.g.,Tom"></div>
                <div class="form-group"><label for="modify_Position_Band">Position Band</label><input
                        id="modify_Position_Band" type="text" placeholder="e.g.,PB3"></div>
                <div class="form-group"><label for="modify_Salary_Grade">Salary Grade</label><input
                        id="modify_Salary_Grade" type="text" placeholder="e.g.,PG5"></div>
                <div class="form-group"><label for="modify_Department_Descr_Short">Company</label><input
                        id="modify_Department_Descr_Short" type="text" placeholder="e.g., BMBS"></div>
                <div class="form-group"><label for="modify_Position_Descr">Position Descr</label><input
                        id="modify_Position_Descr" type="text" placeholder="e.g., President"></div>
                <div class="form-group"><label for="modify_Cost_Center">Cost Center</label><input
                        id="modify_Cost_Center" type="text" placeholder="e.g., 10900771"></div>
                <div class="form-group"><label for="modify_FTE_Type_Funding_Status">Funding</label><input
                        id="modify_FTE_Type_Funding_Status" type="text" placeholder="e.g., BMBS"></div>
                <div class="form-group"><label for="modify_Risk_Assessment">Risk</label><input
                        id="modify_Risk_Assessment" type="text" placeholder="e.g., Compulsory"></div>
                <div class="form-group"><label for="modify_Mark_in_OrgChart">Remark</label><input
                        id="modify_Mark_in_OrgChart" type="text" placeholder="New"></div>
                <div class="form-group"><label for="modify_Remark_2">Remark_2</label><input id="modify_Remark_2"
                        type="text">
                </div>
                <div class="form-group"><label for="modify_Remark_3">Remark_3</label><input id="modify_Remark_3"
                        type="text">
                </div>

                <div class="modal-buttons">
                    <button id="cancelModifyData" class="cta-button">Cancel</button>
                    <button id="confirmModifyData" class="cta-button">Confirm</button>
                </div>
            </div>
        </div>

        <div id="selectionModal" class="modal">
            <div class="modal-content">
                <h3 id="selectionModalTitle">Please Choose：</h3>
                <div id="selectionChoices">
                </div>
                <div class="modal-buttons" style="margin-top: 20px;">
                    <button id="cancelSelection" class="btn btn-dark">Cancel</button>
                </div>
            </div>
        </div>

        <div class="chart-container"></div>
    </div>





    </div>



    <!-- CONTACT PAGE -->
    <div id="Guidance" class="page">
        <div class="container">
            <div class="content-wrapper">
                <section class="contact-grid">


                    <div class="contact-info glass">
                        <h2>Contact Information</h2>

                        <div class="contact-item">
                            <div class="contact-item-icon">📧</div>
                            <div class="contact-item-text">
                                <h4>Email</h4>
                                <p>oaocharlie@icloud.com</p>
                                
                            </div>
                        </div>



                        <div class="contact-item">
                            <div class="contact-item-icon">📍</div>
                            <div class="contact-item-text">
                                <h4>Address</h4>
                                <p>Beijing</p>
                            </div>
                        </div>

                        <div class="contact-item">
                            <div class="contact-item-icon">🕒</div>
                            <div class="contact-item-text">
                                <h4>Business Hours</h4>
                                <p>Monday-Friday: 9AM-6PM</p>
                            </div>
                        </div>
                    </div>
                </section>


            </div>
        </div>
    </div>


    <script src="templatemo-glossy-touch.js"></script>
</body>

</html>
